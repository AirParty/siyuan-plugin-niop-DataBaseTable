/*!
 * MIT License
 *
 * Copyright (c) 2023 SiYuan 思源笔记
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */(()=>{"use strict";var M={};M.d=(e,t)=>{for(var n in t)M.o(t,n)&&!M.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},M.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),M.r=e=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var U={};M.r(U),M.d(U,{NiopTable:()=>q,default:()=>y});const D=require("siyuan");var P=(e,t,n)=>new Promise((s,o)=>{var a=l=>{try{i(n.next(l))}catch(c){o(c)}},r=l=>{try{i(n.throw(l))}catch(c){o(c)}},i=l=>l.done?s(l.value):Promise.resolve(l.value).then(a,r);i((n=n.apply(e,t)).next())});class fe{constructor(){this.creatCommands=t=>{t.protyleSlash.push({filter:[],html:'<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">'+t.i18n.niopimportTool+'</span><span class="b3-list-item__meta">TABLE</span></div>',id:"niop-getCommand-AVdebugDialog",callback:n=>P(this,null,function*(){console.log(`${t.i18n.DataBaseImportToolDes}`+n.protyle.notebookId);const s=n.protyle.breadcrumb.id;n.insert("<span></span>");const o=new D.Dialog({title:`${t.i18n.DataBaseImportToolDes}`,content:`
                        <div class="b3-dialog__content">
                        <div class="fn__hr"></div>
                        <div>DataBae ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox1">
                        <div class="fn__hr"></div>
                        <div>Table ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox2">
                        <div class="fn__hr"></div>
                        <div style="display:none">RenderMethod:</div>
                        <div class="fn__hr"></div>
                        <div class="renderMethod">
                          <button class="niopRenderSelect" id = "niopButton5" style="display: inline-block;"></button>
                        </div>
                        <div class="fn__hr"></div>
                        <div class="fn__hr"></div>
                        <div style="display:none">json:</div>
                        <div id = "jsonstring" style="display:none"></div>
                        </div>        
                    `,width:"360px",height:"440px",destroyCallback:()=>{t.saveData("niopTID_AVID",a.value),t.saveData("niopTID_TableID",r.value)}}),a=o.element.querySelector("#niopIDBox1"),r=o.element.querySelector("#niopIDBox2"),i=o.element.querySelector("#niopButton5");i.textContent=t.i18n.import,t.loadData("niopTID_AVID").then(l=>{a.value=l}),t.loadData("niopTID_TableID").then(l=>{r.value=l}),i.addEventListener("click",()=>{we(a.value,r.value,n,t)})})})}}}function me(e,t=null){(0,D.fetchPost)("/api/block/getBlockKramdown",{id:e},n=>{t&&t(n)})}function Ke(e,t=null){fetchPost("/api/block/getBlockDOM",{id:e},n=>{t&&t(n)})}function Z(e,t,n=null){(0,D.fetchPost)("/api/av/renderAttributeView",{id:e,pageSize:t},s=>{n&&n(s)})}const ge=(e,t=null)=>{(0,D.fetchPost)("/api/block/getBlockKramdown",{id:e},n=>{const s=n.data.kramdown,o=/data-av-id="([^"]+)"/,a=s.match(o);if(!a){console.log("No av-id"),t&&t({result:!1,value:""});return}t&&t({result:!0,value:a[1]})})};function ee(){return globalThis.Lute.NewNodeID()}const ze=(e,t,n=null)=>{const s=e.id,o=[ee()];let a="";e.view.rows.length>0&&(a=e.view.rows[e.view.rows.length-1].id);const r=[{action:"insertAttrViewBlock",avID:s,previousID:a,srcIDs:o,isDetached:!0}];console.log(`ac:${s} \u65B0id:${o} \u524D\u4E00\u7EA7id${a}  do:`),t.protyle.getInstance().transaction(r,[{action:"removeAttrViewBlock",srcIDs:o,avID:s}]),n&&n(1)},Ge=(e,t)=>{const s=e.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),o=e.protyle.notebookId;fetchPost("/api/filetree/getHPathByID",{id:s},a=>{const r=a.data+"/\u65B0\u5EFA\u6587\u68631";fetchPost("/api/filetree/createDocWithMd",{notebook:o,path:r,markdown:"tttt"},i=>{const l=e.protyle;setTimeout(()=>{l.getInstance().transaction([{action:"insertAttrViewBlock",avID:t.id,previousID:t.view.rows[t.view.rows.length-1].id,srcIDs:[i.data],isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:[i.data],avID:t.id}])},500)})})},be=(e,t,n,s,o,a=null)=>{let r=null;o.checkerResult.result&&(r=o.checkerResult.value,(0,D.fetchPost)("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,rowID:n,cellID:s,value:r},i=>{a&&a(i)}))},te=(e,t,n,s,o,a=null)=>{(0,D.fetchPost)("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,rowID:n,cellID:s,value:o},r=>{a&&a(r)})};function ve(e,t){const n=/\[([^\]]*)\]\(([^)]+)\)/,s=[];let o=0,a;for(;(a=n.exec(e))!=null;){o+=1;let r=a[1];r||(r="");const i=a[2],l=e[a.index-1]==="!",c={content:i,type:l?"image":"file",name:r};e=e.replace(l?"!"+a[0]:a[0],""),s.push(c)}return o===0?{result:!1}:{result:!0,value:{[t]:s}}}const we=(e,t,n,s)=>P(void 0,null,function*(){ge(e,o=>{o.result&&Z(o.value,2e4,a=>{me(t,r=>P(void 0,null,function*(){if(s.OnImportData){s.OnImportData=!1;return}try{if(r.code=="0"){let i=!1;const l=h=>P(void 0,null,function*(){i||(i=!0,(0,D.fetchPost)("/api/notification/pushMsg",{msg:h,data:30}),yield new Promise(m=>setTimeout(m,300)),i=!1)});s.OnImportData=!0;const c=new Se(r.data.kramdown);let p=new ne(a.data.view);if(p.duplicatesRow){(0,D.fetchPost)("/api/notification/pushErrMsg",{msg:"database have duplicates name",data:1e3});return}const u=[],d=[],k=[],w=[],b=a.data.view.rows.length;if(c.cells[0].forEach((h,m)=>{p.columnIndexMap[h.content]!=null&&h.content!=""&&m!=0&&u.push({col:m,name:h.content})}),u.length===0)return;for(let h=1;h<c.cells.length;h++){const m={name:c.cells[h][0].content,row:h};if(m.name=="")continue;const S=p.getCellData(m.name);k.push(m),S.result||d.push(m)}const I=!1;let A=!0,f=0;const N=n.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),C=n.protyle.notebookId,g=a.data,v=[],E=[];if(d.length>0&&I){f=d.length;let h=0;console.log("creat new note "+d.length);const m=new Date,S=`import${m.getFullYear()}_${m.getMonth()}_${m.getDay()}_${m.getHours()}_${m.getMinutes()}`;for((0,D.fetchPost)("/api/filetree/getHPathByID",{id:N},$=>P(void 0,null,function*(){(0,D.fetchPost)("/api/filetree/createDocWithMd",{notebook:C,path:$.data+"/"+S,markdown:`import at ${m.getDate()}`},R=>P(void 0,null,function*(){for(const pe of d){h++;const We=$.data+"/"+S+"/"+pe.name;for(console.log("creat new note "+pe.name),(0,D.fetchPost)("/api/filetree/createDocWithMd",{notebook:C,path:We,markdown:""},Q=>{v.push(Q.data),f--,h--});h>0;)yield new Promise(Q=>setTimeout(Q,10))}}))}));f>0;)yield new Promise($=>setTimeout($,200)),l("wait for creat note "+f);l("note creat over "+d.length)}else if(d.length>0)for(const h of d){const m=ee();v.push(m),E.push(h.name)}if(yield new Promise(h=>setTimeout(h,250)),v.length>0){v.reverse(),E.reverse();const h=n.protyle,m=g.view.rows.length>0?g.view.rows[g.view.rows.length-1].id:"";h.getInstance().transaction([{action:"insertAttrViewBlock",avID:g.id,previousID:m,srcIDs:v,isDetached:!I}],[{action:"removeAttrViewBlock",srcIDs:v,avID:g.id}]),yield new Promise(R=>setTimeout(R,1500)),A=!0;let S;const $=a.data.view.rowCount+v.length;for(;A;)yield new Promise(R=>setTimeout(R,1200)),Z(o.value,$,R=>{A&&R.data.view.rowCount==$&&(S=R,A=!1)}),l("wait for av reload");yield new Promise(R=>setTimeout(R,200)),console.log(S),a=S}p=new ne(a.data.view),I||(p.setEmptyBlockCell(v,E),d.forEach(h=>{const m=p.getCellData(h.name,p.keyColumnName,h.name);m.columnName=h.name,m.keyName=h.name,m.reX=h.row,w.push(m)})),f=u.length*k.length;for(const h of u)for(const m of k){const S=p.getCellData(m.name,h.name,c.cells[m.row][h.col].content);S.result&&(S.reX=m.row,S.reY=h.col,S.content=c.cells[m.row][h.col].content,w.push(S))}yield new Promise(h=>setTimeout(h,200)),f=0;let _=0;for(let h=0;h<w.length;h++){f++,l("UPDATE "+h+" / "+w.length);const m=w[h];for(m.checkerResult.result?(be(o.value,m.value.keyID,m.rowsID,m.value.id,m,()=>{f--}),_++):f--;f>5;)yield new Promise(S=>setTimeout(S,5))}s.OnImportData=!1,(0,D.fetchPost)("/api/notification/pushMsg",{msg:"Import Over with"+_+" data",data:1e3})}}catch{s.OnImportData=!1}}))})})});class ne{constructor(t){this.duplicatesRow=!1,this.lateKeyName="",this.laterowIndex=0,this.data=t,this.preprocessData()}preprocessData(){const t=this.data.columns.find(n=>n.type==="block");this.keyColumnIndex=this.data.columns.indexOf(t),this.keyColumnName=t.name,this.columnIndexMap={},this.rowValueChecker={},this.data.columns.forEach((n,s)=>{this.columnIndexMap[n.name]=s,this.rowValueChecker[s]=ye(n)}),this.rowIndexMap={},this.emptyRowIndexMap={},this.data.rows.forEach((n,s)=>{const o=n.cells[this.keyColumnIndex].value.block.content;o&&o!=""?(this.rowIndexMap[o]&&(console.log("block name duplicate "+o),this.duplicatesRow=!0),this.rowIndexMap[o]=s):this.emptyRowIndexMap[n.id]=s})}getCellData(t,n="",s=""){if(t!=this.lateKeyName){if(this.laterowIndex=this.rowIndexMap[t],this.laterowIndex===void 0)return{result:!1,debug:"have no main key"};this.lateKeyName=t}if(n=="")return{result:!0};const o=this.columnIndexMap[n];if(o===void 0)return{result:!1,debug:"have no attr"};const a=this.data.rows[this.laterowIndex],r=a.cells[o],i=this.rowValueChecker[o],l=i(s,r.value,r.valueType);return{result:!0,value:r.value,checkerResult:l,column:this.data.columns[o],rowsID:a.id,keyName:t,columnName:n}}setEmptyBlockCell(t,n){for(let s=0;s<t.length;s++){const o=t[s],a=n[s],r=this.emptyRowIndexMap[o];r>=0?(this.rowIndexMap[a]=r,delete this.emptyRowIndexMap[o]):(console.error(`error with wrong index ${o} ${a} ${s}`),this.error())}}}const ye=e=>{const t={};let n=J;switch(e.type){case"text":return j;case"date":return Ie;case"number":return De;case"relation":return J;case"rollup":return J;case"select":if(!e.options)return(s,o,a)=>({result:!1,faliResult:e.name+" No Any Options"});return e.options.forEach(s=>{t[s.name]=s}),n=(s,o,a)=>{const r=t[s];let i=!1,l="",c="";if(!r)return l="input isnot in select options",{result:i,faliResult:l};const p=o.mSelect;if(p&&s==p[0].content)return l="the same as input",{result:i,faliResult:l};const u={mSelect:[{content:r.name,color:r.color}]};return c=`[${s}] -> [${p}]`,i=!0,{result:i,value:u,successLog:c}},n;break;case"block":return ke;case"mSelect":if(!e.options)return(s,o,a)=>({result:!1,faliResult:e.name+" No Any Options"});return e.options.forEach(s=>{t[s.name]=s}),n=(s,o,a)=>{let r=!1,i="",l="",c="",p="";const u=[];let d=s.split(",");d||(d=[s]);const k=o.mSelect;for(let b=0;b<d.length;b++){const I=d[b],A=t[I];if(!A){c+=I+",";continue}let f=!1;if(k){for(let T=0;T<k.length;T++)if(k[T].content==I){f=!0;break}}if(f){p+=I+",";continue}u.push({content:A.name,color:A.color})}if(u.length<1)return i=`unKnow option:(${c}) duplicate option:(${p})`,{result:r,faliResult:i};let w;return k?w={mSelect:[...o.mSelect,...u]}:w={mSelect:u},l=`[${s}] -> [${k}]`,r=!0,{result:r,value:w,successLog:l}},n;break;case"url":return j;case"email":return j;case"phone":return j;case"mAsset":return Ee;case"checkbox":return Ae;default:return J}},ke=(e,t,n)=>{const s=t.block.content;let o=!1,a="",r="";if(e==s)return a=`the same as input (${s})`,{result:o,faliResult:a};const i={block:{content:e}};return r=`[${e}] -> [${s}]`,o=!0,{result:o,value:i,successLog:r}},j=(e,t,n)=>{const s=t[n].content;let o=!1,a="",r="";if(e==s)return a=`the same as input (${s})`,{result:o,faliResult:a};const i={[n]:{content:e}};return r=`[${e}] -> [${s}]`,o=!0,{result:o,value:i,successLog:r}},De=(e,t,n)=>{const s=t.number.content;let o=!1,a="",r="";if(parseFloat(e)==s)return a=`the same as input (${s})`,{result:o,faliResult:a};const i={number:{content:parseFloat(e)}};return r=`[${e}] -> [${s}]`,o=!0,{result:o,value:i,successLog:r}},Ie=(e,t,n)=>{const s=t.date,o={content:0,isNotEmpty:!1,content2:0,isNotEmpty2:!1,isNotTime:!1};o.hasEndDate=s.hasEndDate,o.isNotTime=s.isNotTime;let a=!1,r="",i="",l=0;const c=e.split(",");if(c.length>=1){const u=c[0].trim(),d=oe(u);d!==0&&(o.content=d,o.isNotEmpty=!0),s.content===o.content&&l++}if(c.length>=2){const u=c[1].trim(),d=oe(u);d!==0&&(o.content2=d,o.isNotEmpty2=!0,o.hasEndDate=!0),s.content2===o.content2&&l++}if(l==2)return r=`the same as input (${s})`,{result:a,faliResult:r};const p={date:o};return i=`[${e}] -> [${s}]`,a=!0,{result:a,value:p,successLog:i}};function oe(e){const t=Date.parse(e);return isNaN(t)?0:t+new Date().getTimezoneOffset()*60*1e3}const Ae=(e,t,n)=>{const s=t.checkbox.checked;let o=!1,a="",r="";if(e==="")return a=`input is empety (${e})`,{result:o,faliResult:a};const i=e.includes("true");if(i===s)return a=`the same as input (${s})`,{result:o,faliResult:a};const l={checkbox:{checked:i}};return r=`[${e}] -> [${s}]`,o=!0,{result:o,value:l,successLog:r}},J=(e,t,n)=>({result:!1,faliResult:`Unkonw type [${n}] value [${e}]`}),Ee=(e,t,n)=>{const s=ve(e,n);let o=!1,a="",r="";if(!s.result)return a=`input isnot asset (${e})`,{result:o,faliResult:a};const i=s.value[n];let l=[],c=[];if(t.mAsset){if(l=i.filter(p=>!t.mAsset.some(d=>d.content===p.content)),l.length===0)return a=`${e} -> already in database `,{result:o,faliResult:a};r+=`asset ${l.length} ${l.map(p=>p.content).join(" ")} -> ${t.mAsset?t.mAsset.length:"none"}`,t.mAsset&&t.mAsset.length>0&&(l=[...t.mAsset,...l]),s.value=l}return c=s.value,o=!0,{result:o,value:c,successLog:r}};class Se{constructor(t){this.cells=[],this.end="",this.duplicatesRow=!1,this.keyWorlds={},this.kmdCellRegex=/{:\s*(.+?)\s*}/,this.kmdCell=n=>{const s=n.match(this.kmdCellRegex);return s?{content:n.replace(s[0],"")}:{content:n}},this.parseTable(t)}parseTable(t){const n=t.split(`
`);this.end=n[n.length-1],n.slice(0,-1).map(o=>o.split(new RegExp("(?<!\\\\)\\|")).map(a=>a.replace(/\\\|/g,"|"))).forEach((o,a)=>{this.cells[a]=[],o.forEach((r,i)=>{this.cells[a][i]=this.kmdCell(r)}),this.cells[a]=this.cells[a].slice(1,-1),this.cells[a][0].content=this.sanitizeFileName(this.cells[a][0].content),this.keyWorlds[this.cells[a][0].content]?(this.keyWorlds[this.cells[a][0].content]+=1,this.duplicatesRow=!0):this.keyWorlds[this.cells[a][0].content]=1}),this.cells=this.cells.slice(0,1).concat(this.cells.slice(2))}sanitizeFileName(t){const n=/[\/\\\?%\*:|"<>]/g;return t.replace(n,"").replace(/<br\/>/g,"")}}function Ye(e,t,n=null){fetchPost("/api/notification/pushMsg",{msg:e,data:t},s=>{n&&n(s)})}function Xe(e,t,n=null){fetchPost("/api/notification/pushErrMsg",{msg:e,data:t},s=>{n&&n(s)})}const $e=e=>{const t=e.getAttribute("niopInput");let n,s,o;switch(t){case"text":return O(t,e);case"date":return null;case"number":return Te(t,e);case"relation":return null;case"rollup":return null;case"select":return xe(t,e);case"block":return O(t,e);case"mSelect":return null;case"url":return O(t,e);case"email":return O(t,e);case"phone":return O(t,e);case"mAsset":return null;case"checkbox":return Ce(t,e);default:return O(t,e)}},O=(e,t)=>{const n=F(t.innerText);return n!=t.innerText&&(t.innerText=n),{[e]:{content:n}}},Te=(e,t)=>{const n=parseFloat(F(t.innerText));return n.toString()!=t.innerText&&(t.innerText=n.toString()),{[e]:{content:n}}},Ce=(e,t)=>({checkbox:{checked:t.checked}}),xe=(e,t)=>{const n=t;return{mSelect:[{content:n.value,color:n.getAttribute("color")}]}},F=e=>e.replace(/[\s\n]+$/,""),W=(e,t)=>{const n=$e(t);n!=null?te(e.resourceAVID,t.getAttribute("keyID"),t.getAttribute("rowID"),t.getAttribute("cellID"),n):console.log(`error with ${t.getAttribute("niotInput")}`)};let x=null;const _e=(e,t)=>{Ne();const n=t.target,s=n.getAttribute("niopInput");if(s!==null){x={element:n,text:n.innerText,change:!1};const o=a=>{(x.change||n===x.element&&n.innerText!=x.text&&s!="mAsset")&&W(e,x.element),n.removeEventListener("blur",o),x=null};n.addEventListener("blur",o),x.blur=o}},Ne=()=>{x!=null&&(x.blur(),x=null)},Re=(e,t)=>{t.preventDefault();const n=t.composedPath&&t.composedPath();for(let s=0;s<n.length&&s<=2;s++)if(n[s].hasAttribute&&n[s].getAttribute("niopInput")=="mAsset"){if(n[s]instanceof HTMLElement){const o=n[s],a=t.clipboardData?t.clipboardData.getData("text"):"";if(a&&a!=""){const r=Me(a);let i="";const l=[];r.forEach(p=>{i+=p.content,l.push({type:p.isImage?"image":"file",content:p.link,name:""})}),o.innerHTML=i;const c={mAsset:l};te(e.resourceAVID,o.getAttribute("keyID"),o.getAttribute("rowID"),o.getAttribute("cellID"),c,()=>{})}}break}},Ve=(e,t)=>{const n=t.target;if(n.getAttribute("niopInput")!==null){W(e,n);return}};function Me(e){const t=/\[([^\]]*)\]\(([^)]+)\)/g,n=[];let s;for(;(s=t.exec(e))!==null;){const o=s[0],a=s[1],r=s[2],i=e[s.index-1]==="!",l=i?`<img src="${r}" alt="${a}">`:`<a href="${r}">${a}</a>`;e=e.replace(i?"!"+o:o,l),n.push({text:a,link:r,content:l,isImage:i})}return n}var B=(e,t,n)=>new Promise((s,o)=>{var a=l=>{try{i(n.next(l))}catch(c){o(c)}},r=l=>{try{i(n.throw(l))}catch(c){o(c)}},i=l=>l.done?s(l.value):Promise.resolve(l.value).then(a,r);i((n=n.apply(e,t)).next())});const se=!1,K="menu-config",Qe="custom_tab",Ze="dock_tab",V=class extends D.Plugin{onload(){this.eventBus.on("switch-protyle",this.switch_protyle),V.Ini=this,this.eventBus.on("click-blockicon",this.blockIconEvent.bind(this)),this.protyleSlash=[{filter:["table","data table","database table","niop","\u8868\u683C","\u6570\u636E\u8868\u683C","\u6570\u636E\u5E93\u8868\u683C","shujubiaoge"],html:`<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${this.i18n.dTable}</span><span class="b3-list-item__meta">TABLE</span></div>`,id:"creatniopDateTable",callback(r){return B(this,null,function*(){const i=r.protyle.breadcrumb.id,l=r.protyle.contentElement.querySelector(`[data-node-id="${i}"]`),c=r.protyle.transactionTime;yield(u=>B(this,null,function*(){r.insert("<span></span>"),yield he(i),G(l,i,r.protyle,200)}))(1)})}}];const e=document.createElement("div");e.innerHTML=`
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u8F85\u52A9\u5DE5\u5177 -->
<select id="niopSelect" >
    <option value="close">${V.Ini.i18n.close}</option>
    <option value="open">${V.Ini.i18n.open}</option>
</select>

<!-- \u9009\u62E9\u6846\u548C\u8F93\u5165\u6846 \u9884\u5B9A\u4E49 CSS -->
<div id="niopContainer" class="fn__none">
    <select id="niopSelect2">
        <option value="option1">\u4F7F\u7528\u5185\u5D4Ccss</option>
        <option value="option2">\u4F7F\u7528\u81EA\u5B9A\u4E49css</option>
    </select>
    <button onclick="console.log('Clicked!')">\u6062\u590D\u9ED8\u8BA4css</button>
    <input type="text" id="niopInput" placeholder="Type something...">
</div>    
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u5FEB\u901F\u5DE5\u5177\u680F \u8F93\u51FA log -->
<select id="niopSelect3" class="fn__none">
    <option value="option1">Option 1</option>
    <option value="option2">Option 2</option>
    <option value="option3">Option 3</option>
</select>
<!-- \u5FEB\u901F\u5DE5\u5177\u680F -->
<div id="niopToolbar" class="fn__none">
    <button onclick="console.log('Clicked!')">Log</button>
</div>
    `;const t=e.querySelector("#niopSelect"),n=e.querySelector("#niopSelect2"),s=e.querySelector("#niopInput"),o=e.querySelector("#niopSelect3"),a=e.querySelector("#niopToolbar");this.setting=new D.Setting({confirmCallback:()=>{this.saveData(K,{useAdvanceTools:t.value})}}),this.setting.addItem({title:`${V.Ini.i18n.useImportToll}`,createActionElement:()=>(this.loadData(K).then(r=>{r.useAdvanceTools&&(t.value=r.useAdvanceTools)}),e)}),console.log("DatabaseTable from niop ~"),this.loadData(K).then(r=>{r.useAdvanceTools&&new fe().creatCommands(this)})}onLayoutReady(){}onunload(){this.eventBus.off("switch-protyle",this.switch_protyle),this.eventBus.off("click-blockicon",this.blockIconEvent.bind(this))}EventMenu(){}blockIconEvent({detail:e}){e.menu.addItem({iconHTML:'<svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg>',label:this.i18n.dTable,click:()=>{const t=e.blockElements[0],n=t.getAttribute("data-node-id");G(t,n,e.protyle,0)}})}switch_protyle(e){const t=e.detail.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr");if(!t)return;let n=t.getAttribute("niopStatu");if(n||(n="addToolBar",t.setAttribute("niopStatu",n)),n==="addToolBar"){const o=e.detail.protyle.contentElement;o.addEventListener("click",a=>{if(a.altKey){const r=a.composedPath();for(let i=0;i<r.length;i++){const l=r[i];if(typeof l.getAttribute=="function"&&l.getAttribute(V.ATTRNAME)!==null){const c=l,p=c.getAttribute("data-node-id");G(c,p,e.detail.protyle,0),a.preventDefault(),a.stopPropagation();break}if(l===o)break}}})}const s=e.detail.protyle.contentElement.querySelectorAll(`[${V.ATTRNAME}]`);s.forEach(o=>{});for(let o=0;o<s.length;o++){const a=s[o],r=a.getAttribute("data-node-id"),i=a.getAttribute(V.ATTRNAME);try{const l=new q(i);if(l.tableNode=a,l.nodeID=r,l.protyle=e.detail.protyle,l.tableContainer=a.parentElement,(l.reFreshOnPageSelect||l.editableCard)&&Be(l))continue;z(l)}catch{}}t.setAttribute("niopStatu","none")}};let y=V;y.OnRedner=!1,y.OnImportData=!1,y.ATTRNAME="custom-nioptable";const et=()=>{},Be=e=>y.OnRedner||y.OnImportData||e.renderEditMethod!=1?!1:((e.reFreshOnPageSelect||e.editableCard)&&Pe(e),!0),z=(e,t=!1)=>{if(!e.editableCard)return;t&&(e.tableNode=e.tableContainer.querySelector(`[data-node-id="${e.nodeID}"]`));const n=e.tableNode;if(!n.getAttribute("niopStatu")&&(n.setAttribute("niopStatu","none"),n.getAttribute("data-type")==="NodeHTMLBlock")){const s=n.querySelector("protyle-html[data-content]");n.querySelector(".protyle-icons").classList.add("fn__none");const a=s.shadowRoot.querySelector(".cardContainer");a.addEventListener("focus",r=>{_e(e,r)},!0),a.addEventListener("change",r=>{Ve(e,r)}),a.addEventListener("paste",r=>{Re(e,r)})}},Pe=(e,t=!0)=>{le(e.resourceID,n=>{e.resourceAVUpdated!=n&&(e.resourceAVUpdated=n,ae(e,t,!0,()=>{e.save(),setTimeout(()=>{z(e,!0)},500)}))})},G=(e,t,n,s=1e3)=>{const o=e,a=o.getAttribute("data-type");if(a!="NodeTable"&&a!="NodeHTMLBlock"){ue("DataBaseTable only used on Table",4e3);return}if(a==="NodeHTMLBlock"&&!o.getAttribute(y.ATTRNAME)){ue("error with wrong attribute",4e3);return}const r=c=>{if(c.nodeID=t,c.tableContainer=o.parentElement,c.tableNode=o,c.protyle=n,c.renderEditMethod===2||c.renderEditMethod<1){c.renderEditMethod=2;const p=[],u=c.tableNode.querySelector("colgroup");u&&u.querySelectorAll("col").forEach(k=>{const w=k.getBoundingClientRect().width,b=w?`${w}px`:"";p.push(b)}),c.colgroup=JSON.stringify(p),(0,D.fetchPost)("/api/block/getBlockKramdown",{id:c.nodeID},d=>B(void 0,null,function*(){c.renderEditMethod=2,c.setSourceTable(d.data.kramdown),yield he(t),Y(c)}))}else Y(c)},i=c=>{const p=o.getAttribute(y.ATTRNAME),u=new q(p);s>10?setTimeout(()=>{r(u)},s):r(u)},l=c=>{const p=new q(""),u={[y.ATTRNAME]:p.getJson()};s>10?setTimeout(()=>{L(t,u,()=>{r(p)})},s):L(t,u,()=>{r(p)})};qe(t,y.ATTRNAME,i,l)},tt=e=>{const t=e,n=t.getAttribute("data-node-id"),s=t.getAttribute(y.ATTRNAME);if(!n){console.error("error with data-node-id ");return}const o=t.getElementsByClassName("protyle-attr"),a=document.createElement("div");a.setAttribute("contenteditable","false"),a.classList.add("niop-toolbar-container"),a.addEventListener("mouseenter",()=>{a.classList.remove("hide"),a.classList.add("show")}),a.addEventListener("mouseleave",()=>{a.classList.remove("show"),a.classList.add("hide")}),o[0].appendChild(a);const r=new q(s);r.nodeID=n,r.tableNode=t;const i=document.createElement("button");i.textContent="Toolbar",i.setAttribute("niopButton","showMenu"),i.setAttribute("contenteditable","false"),i.classList.add("niop-button"),a.appendChild(i),i.addEventListener("click",()=>{Y(r)});const l=document.createElement("button");l.textContent="Reload",l.setAttribute("niopButton","reload"),l.setAttribute("contenteditable","false"),l.classList.add("niop-button"),a.appendChild(l),l.addEventListener("click",()=>{Ue(r)}),r.tableContainer=a},Y=e=>{let t=!1;const n=h=>{t&&e.save(m=>{setTimeout(()=>{z(e,!0)},200)})},s=new D.Dialog({title:`${y.Ini.i18n.OnEditSomthing_Table} : ${e.nodeID}`,content:`
      <div class="b3-dialog__content">
      <div class="fn__hr"></div>
      <div>${y.Ini.i18n.AVBlockID}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Dababase ID" id = "niopIDBox">
      <div class="fn__hr"></div>
      <div >${y.Ini.i18n.AVViewName}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Views Name" id = "niopIDBox2">
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${y.Ini.i18n.RenderMethodAs}:</div>
      <div class="fn__hr"></div>
      <div class="renderMethod">
        <button class="niopRenderSelect" id = "niopRenderSelectCard" style="display: inline-block;" >${y.Ini.i18n.renderCard}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectRight" style="display: inline-block;">${y.Ini.i18n.renderRight}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectDown" style="display: inline-block;" >${y.Ini.i18n.renderBelow}</button>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${y.Ini.i18n.DisPlayAs}:</div>
      <div class="fn__hr"></div>
      <div class="niopRenderMethodDis">
      <div class="niopRenderSelect" id = "niopRenderAsEditor" aria-label="">${y.Ini.i18n.currentDisPlayMethod_Editor}</div>
      <div class="niopRenderSelect" id = "niopRenderAsDataBase" aria-label="">${y.Ini.i18n.currentDisPlayMethod_DateBase}</div>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${y.Ini.i18n.SwitchRender}:</div>
      <div class="fn__hr"></div>
      <div class="niopLoadMethod">
      <button class="niop-button" id = "niopEditTable" aria-label="">${y.Ini.i18n.currentDisPlayMethod_Editor}</button>
      <span style="width:120px;height:60px;"><span>
      <button class="niop-button" id = "niopReloadAll" aria-label="">${y.Ini.i18n.ReloadAll}</button>
      </div>
      <div class="fn__hr"></div>
      <div>${y.Ini.i18n.tableSetting}</div>
      <div class="fn__hr"></div>
      <button class="niopRenderSelect" id = "reLoadOnTabSelect" aria-label="">${y.Ini.i18n.reLoadOnTabSelect}</button>
      <button class="niopRenderSelect" id = "EditorAble" aria-label="">${y.Ini.i18n.editableCard}</button>
      <div class="fn__hr"></div>
      <div style="display:none">Edit</div>
      <div class="fn__hr"></div>

      <button class="niop-button hide" id = "niopSetFiltter" >SetFiltter</button>
      <button class="niop-button hide" id = "niopCleanFiltter" >cleanFiltter</button>
      <div class="fn__hr" style="display:none"></div>
      <div class="fn_none" style="display:none">json:</div>
      <div id = "jsonstring" class="fn_none" style="display:none"></div>
      </div>        
  `,width:"360px",height:"500px",destroyCallback:n}),o=s.element.querySelector("#jsonstring"),a=s.element.querySelector("#niopIDBox"),r=s.element.querySelector("#niopIDBox2"),i=s.element.querySelector("#niopRenderSelectCard"),l=s.element.querySelector("#niopRenderSelectRight"),c=s.element.querySelector("#niopRenderSelectDown"),p=s.element.querySelector("#niopEditTable"),u=s.element.querySelector("#niopReloadAll"),d=s.element.querySelector("#reLoadOnTabSelect"),k=s.element.querySelector("#EditorAble"),w=s.element.querySelector("#niopRenderAsEditor"),b=s.element.querySelector("#niopRenderAsDataBase"),I=s.element.querySelector("#niopSetFiltter"),A=s.element.querySelector("#niopCleanFiltter"),f=()=>{o.innerText=e.getJson()},T=()=>{i.classList.remove("select"),l.classList.remove("select"),c.classList.remove("select"),w.classList.remove("select"),b.classList.remove("select"),d.classList.remove("select"),k.classList.remove("select"),e.renderMethod===1?i.classList.add("select"):e.renderMethod===2?l.classList.add("select"):e.renderMethod===3&&c.classList.add("select"),e.renderEditMethod===1&&b.classList.add("select"),e.renderEditMethod===2&&w.classList.add("select"),e.reFreshOnPageSelect&&d.classList.add("select"),e.editableCard&&k.classList.add("select")},N=()=>{const h=[{action:"setAttrViewFilters",avID:e.resourceAVID,data:e.hotReloadSetting.filters},{action:"setAttrViewSorts",avID:e.resourceAVID,data:e.hotReloadSetting.sorts}];e.protyle.getInstance().transaction(h)},C=()=>{e.renderEditMethod=2,w.classList.add("select"),b.classList.remove("select");const h=H(e.sourceTable,["fold","updated"]);ce(e.nodeID,h,m=>{}),y.OnRedner=!1,t=!0,f()},g=h=>{e.resourceAVID!=""&&(w.classList.remove("select"),b.classList.add("select"),ae(e,h))},v=()=>{X(e,h=>{if(!h){console.log("no av on the block:"+e.resourceID);return}t=!0,e.renderEditMethod=1,g(!1),f()})},E=()=>{const h=e.resourceAVID;X(e,m=>{if(!m){console.log("no av on the block"+e.resourceID);return}e.resourceAVID!=h?g(!1):g(!0),f()})},_=()=>{t=!0,d.classList.remove("select"),e.reFreshOnPageSelect=!e.reFreshOnPageSelect};a.value=e.resourceID,r.value=e.resourceAVViewName,X(e,()=>{f()}),a.addEventListener("input",()=>{e.resourceID=a.value,t=!0}),r.addEventListener("input",()=>{e.resourceAVViewName=r.value,t=!0}),i.addEventListener("click",()=>{e.renderMethod=1,t=!0,f(),T()}),l.addEventListener("click",()=>{e.renderMethod=2,t=!0,f(),T()}),c.addEventListener("click",()=>{e.renderMethod=3,t=!0,f(),T()}),p.addEventListener("click",C),u.addEventListener("click",v),d.addEventListener("click",()=>{e.reFreshOnPageSelect=!e.reFreshOnPageSelect,le(e.resourceID,h=>{e.resourceAVUpdated=h}),t=!0,T()}),k.addEventListener("click",()=>{e.editableCard=!e.editableCard,t=!0,T()}),a.innerText=e.resourceID,T()},ae=(e,t=!0,n=!1,s=null)=>B(void 0,null,function*(){if(!n){if(y.OnRedner){de(`${y.Ini.i18n.pleaseWaitOnRendering}`,3e3),y.OnRedner=!1;return}y.OnRedner=!0}(0,D.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID},o=>B(void 0,null,function*(){const a=o.data.view.rowCount,r=()=>{se&&(console.log("niopTable:"),console.log(e));const l=new Fe(e.sourceTable,e);let c="";switch(e.renderMethod){case 1:l.direction={card:1,x:0,y:0},l.makeToCard(e),c=l.RebuildAsCard(e);break;case 2:l.direction={card:0,x:1,y:0},l.makeToCard(e),c=l.Rebuild(e);break;case 3:l.direction={card:0,x:0,y:1},l.makeToCard(e),c=l.Rebuild(e);break;default:de(`${y.Ini.i18n.mustSelectOneRenderMethod}`,5e3);break}se&&(console.log("\u9884\u5904\u7406\u8868\u683C"),console.log(l),console.log(c)),ce(e.nodeID,c,s),e.renderEditMethod=1,y.OnRedner=!1};t=!1;let i=o.data.view.id;if(e.resourceAVViewName!=""&&o.data.view.name!=e.resourceAVViewName&&o.data.views.length>1){for(let l=0;l<o.data.views.length;l++){const c=o.data.views[l];if(c.name===e.resourceAVViewName){t=!0,i=c.id;break}}t||console.log("error view name")}t||a>o.data.view.rows.length?(0,D.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID,viewID:i,pageSize:a},c=>{e.titles=c.data.view.columns,e.rows=c.data.view.rows,e.avTable=c,r()}):(e.titles=o.data.view.columns,e.rows=o.data.view.rows,e.avTable=o,r())}))}),le=(e,t=null)=>{(0,D.fetchPost)("/api/block/getBlockDOM",{id:e},n=>{if(n.data.dom||n.data.dom==="")return;const s=document.createElement("div");s.innerHTML=n.data.dom;const o=s.children[0].getAttribute("updated");o&&t&&t(o)})},nt=(e,t=null)=>{fetchPost("/api/av/renderAttributeView",{id:e.resourceAVID},n=>{e.titles=e.deepCopy(n.data.view.columns),e.rows=n.data.view.rows,e.avTable=n,e.setting.filters=Object.assign(n.data.view.filters),e.setting.sorts=Object.assign(n.data.view.sorts),t&&t()})},ot=e=>{console.log(e)};class q{constructor(t){this.renderMethod=-1,this.renderEditMethod=2,this.resourceID="",this.resourceAVID="",this.resourceAVUpdated="",this.resourceAVViewName="",this.setting={filters:[],sorts:[]},this.hotReloadSetting={filters:[],sorts:[]},this.sourceTable="",this.colgroup="",this.nodeID="",this.reFreshOnPageSelect=!1,this.editableCard=!1,this.displayEmpety=!1,this.displayAddButton=!1;try{const n=JSON.parse(t);n.renderMethod&&(this.renderMethod=n.renderMethod),n.resourceID&&(this.resourceID=n.resourceID),n.resourceAVID&&(this.resourceAVID=n.resourceAVID),n.sourceTable&&(this.sourceTable=this.decode(n.sourceTable)),n.renderEditMethod&&(this.renderEditMethod=n.renderEditMethod),n.hotReloadSetting&&(this.hotReloadSetting=n.hotReloadSetting),n.nodeID&&(this.nodeID=n.nodeID),n.colgroup&&(this.colgroup=this.decode(n.colgroup)),n.resourceAVViewName&&(this.resourceAVViewName=n.resourceAVViewName),n.resourceAVUpdated&&(this.resourceAVUpdated=n.resourceAVUpdated),n.reFreshOnPageSelect&&(this.reFreshOnPageSelect=n.reFreshOnPageSelect),n.editableCard&&(this.editableCard=n.editableCard),n.displayEmpety&&(this.displayEmpety=n.displayEmpety)}catch(n){console.log("Error parsing JSON:",n),this.save(s=>{setTimeout(()=>{},200)})}}clean(){this.protyle=null}getJson(){return JSON.stringify({renderMethod:this.renderMethod,resourceID:this.resourceID,resourceAVID:this.resourceAVID,sourceTable:this.encode(this.sourceTable),renderEditMethod:this.renderEditMethod,hotReloadSetting:this.hotReloadSetting,nodeID:this.nodeID,colgroup:this.encode(this.colgroup),resourceAVViewName:this.resourceAVViewName,resourceAVUpdated:this.resourceAVUpdated,reFreshOnPageSelect:this.reFreshOnPageSelect,editableCard:this.editableCard,displayEmpety:this.displayEmpety})}encode(t){const n=encodeURIComponent(t);return window.btoa(n)}decode(t){try{const n=atob(t);return decodeURIComponent(n)}catch(n){return console.error("Error decoding string:",n),""}}deepCopy(t){return JSON.parse(JSON.stringify(t))}setSourceTable(t){const n=/custom-nioptable="[^"]*"/g,s=t.replace(n,"");this.sourceTable=s}save(t=null){if(this.nodeID!=""){const n={[y.ATTRNAME]:this.getJson()};t?L(this.nodeID,n,s=>{t(s)}):L(this.nodeID,n)}}}const st=()=>{const e=`|{: colspan="4" rowspan="1"}\u6807\u9898|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|
| :-------------------------------: | :--------------------------------: | :--------------------------------: | :--------------------------------: |
|{: colspan="1"}\u5934\u50CF|{: colspan="1"}\u540D\u5B57|{: colspan="1"}\u7B49\u7EA7|\u6280\u80FD|
|..(icon)|..(name)|..(level)|..(skill)|
{: colgroup="width: 94px;|width: 121px;|width: 95px;|width: 116px;" custom-nioptable="123" fold="0" id="20231120114455-g1jmigv" updated="20231130193916"}`,n=e.split(`
`).slice(0,-1).map(o=>o.split(new RegExp("(?<!\\\\)\\|")).map(a=>a.replace(/\\\|/g,"|"))),s=[[{content:"",config:""}]];n.forEach((o,a)=>{s[a]=[],o.forEach((r,i)=>{s[a][i]=re(r)}),s[a]=s[a].slice(1,-1)}),console.log(e),console.log(s)},Oe=/{:\s*(.+?)\s*}/,re=e=>{const t=e.match(Oe);if(t){const n=e.replace(t[0],""),s=Le(t[1]),o=s.attributes,a=!!(o.colspan&&o.colspan>1||o.rowspan&&o.rowspan>1);return{content:n,config:o,configNo:s.length,resize:a,valueType:"",colspan:o.colspan?parseInt(o.colspan):1,rowspan:o.rowspan?parseInt(o.rowspan):1}}else return{content:e,config:{},configNo:0,resize:!1,valueType:"",colspan:1,rowspan:1}};function Le(e){const t=/(\S+)=["']([^"']+)["']/g,n=e.match(t);if(!n)return{};const s={};let o=0;return n.forEach(a=>{const[r,i,l]=a.match(/(\S+)=["']([^"']+)["']/);s[i]=l,o++}),{attributes:s,length:o}}class Fe{constructor(t,n){this.cells=[],this.dashRowNum=1,this.colgroup=[],this.rowsStyleStrs=[],this.cellStyleStrs={},this.end="",this.cards=[],this.haveActionValueRegex=/\.\.\((.+?)\)/g,this.checkifHaveActionValue=s=>!!s.content.match(this.haveActionValueRegex),this.rowStyleRegex=/\.\.style\(([^)]*)\)/,this.cellStyleRegex=/\.\.tdstyle\(([^)]*)\)/,this.direction={card:0,x:0,y:0},this.curCell={card:0,x:0,y:0},this.parseTable(t,n)}parseTable(t,n){const s={};let o=!1;const a=t.split(`
`);this.end=a[a.length-1],a.slice(0,-1).map(i=>i.split(new RegExp("(?<!\\\\)\\|")).map(l=>l.replace(/\\\|/g,"|"))).forEach((i,l)=>{this.cells[l]=[];let c=!1;s[l]||(s[l]=0),i.forEach((p,u)=>{if(this.cells[l][u]=re(p),!o&&this.cells[l][u].rowspan>1){c=!0;for(let d=0;d<this.cells[l][u].rowspan;d++)s[l+d]?s[l+d]+=1:s[l+d]=1}}),!o&&!c&&s[l]===0&&(o=!0,this.dashRowNum<l&&(this.dashRowNum=l)),this.cells[l]=this.cells[l].slice(1,-1)}),this.getRawColgroup(n),this.getMdSettingFromTable()}removeEmpetyInputRows(t){const n=t.avTable.data.view;let s=-1;for(let a=0;a<n.columns.length;a++)if(n.columns[a].type==="block"){s=a;break}const o=[];for(let a=0;a<n.rows.length;a++)n.rows[a].cells[s].value.block.content===""&&o.push(a);for(let a=o.length-1;a>=0;a--)n.rows.splice(o[a],1)}caculateColAndRowGroup(t){this.cells.forEach((n,s)=>{n.forEach((o,a)=>{switch(t.renderMethod){case 1:break;case 2:o.colspan>1&&n.length==a+o.colspan?(o.colspan+=t.rows.length-1,o.config.colspan=o.colspan):n.length==1&&o.colspan==1&&this.dashRowNum!=s&&(this.checkifHaveActionValue(o)||(o.colspan+=t.rows.length-1,o.config.colspan=o.colspan,o.configNo+=1));break;case 3:o.rowspan>1&&this.cells.length==s+o.rowspan+1?(o.rowspan+=t.rows.length,o.config.rowspan=o.rowspan):this.cells.length==2&&o.rowspan==1&&this.dashRowNum!=s&&(this.checkifHaveActionValue(o)||(o.rowspan+=t.rows.length-1,o.config.rowspan=o.rowspan,o.configNo+=1));break;default:break}})})}Rebuild(t){const n=this.cards.map(a=>a.map(r=>"|"+r.map(i=>{let l="";return i.configNo>0&&(l="{: "+Object.entries(i.config).map(([c,p])=>`${c}="${p}"`).join("  ")+"}"),l+i.content}).join("|")).join(`|
`)).join("");this.end=t.renderMethod===2?H(this.end,["fold","id","updated","colgroup"]):H(this.end,["fold","id","updated"]);let s=' id="'+t.nodeID+'" ';t.renderMethod===2&&(s+=' colgroup="'+this.colgroup.map(a=>"width: "+a+";").join("|")+'" ');const o=this.end;return this.end=o.slice(0,2)+s+o.slice(2),`${n}
${this.end}`}RebuildAsCard(t){const n=H(this.end,["fold","id","updated","colgroup"]),s=` id="${t.nodeID}"  data-type="NodeHTMLBlock" `;this.end=n.slice(0,2)+s+n.slice(2);const o=je(this.cards.length,this.cells.length-1,this.colgroup,this.rowsStyleStrs,this.cellStyleStrs,t),a=[];return this.cards.forEach((r,i)=>{r.forEach((l,c)=>{if(this.dashRowNum!=c){const p=c>this.dashRowNum?c-1:c;l.forEach((u,d)=>{const k=o.cells[i][p][d];if(k.innerHTML=u.content,u.configNo>0){if(u.colspan>1||u.rowspan>1)for(let w=0;w<u.colspan;w++)for(let b=0;b<u.rowspan;b++)w===0&&b===0||a.push(o.cells[i][p+b][d+w]);if(u.colspan>1){k.setAttribute("colspan",`${u.colspan}`);let w=parseInt(k.style.width);for(let b=1;b<u.colspan;b++)w+=parseInt(o.cells[i][p][d+b].style.width);k.style.width=w+"px"}u.rowspan>1&&k.setAttribute("rowspan",`${u.rowspan}`)}})}}),a.forEach(l=>{l.className="fn__none"})}),`<div>${o.body.innerHTML}</div>
${this.end}`}makeToCard(t){this.cards=[],this.removeEmpetyInputRows(t),this.caculateColAndRowGroup(t);const n=this.cells[0].length,s=this.cells.length,o=t.titles.length,a=t.rows.length,r=this.cards,i={card:0,x:0,y:0},l=this.direction;if(l.card==1?(He(this.cells),t.rows.forEach((d,k)=>{r[k]=t.deepCopy(this.cells)})):r[0]=t.deepCopy(this.cells),l.x===1){const d=r[0],k=this.colgroup[this.colgroup.length-1];for(let w=0;w<t.rows.length-1;w++)this.colgroup.push(k);for(let w=0;w<s;w++){const b=JSON.parse(JSON.stringify(d[w][n-1]));b.colspan>1&&this.dashRowNum!=w&&(b.content="",b.config.class="fn__none",b.colspan=1,b.config.colspan=1,b.configNo=1);const I=JSON.stringify(b);t.rows.forEach((A,f)=>{f!=0&&d[w].push(JSON.parse(I))})}}if(l.y===1){const d=r[0],k=t.rows.length,w=d[0].length,b=this.dashRowNum===s-1;let I;b?I=JSON.parse(JSON.stringify(Object.assign(d[s-2]))):I=Object.assign(JSON.parse(JSON.stringify(d[s-1]))),I.forEach(f=>{f.rowspan>1&&(f.content="",f.config.class="fn__none",f.rowspan=1,f.config.rowspan=1,f.configNo=1)});const A=JSON.stringify(I);for(let f=1;f<k;f++)b?d.splice(d.length-1,0,JSON.parse(A)):d.push(JSON.parse(A))}const c=[],p=/\.\.\((.*?)\)/;this.cells.forEach((d,k)=>{d.forEach((w,b)=>{w.content.match(p)&&c.push({x:k,y:b})})}),t.titles.forEach((d,k)=>{if(d.name!=""){const w=`..(${d.name})`;c.forEach(b=>{const I=this.cells[b.x][b.y],A=new RegExp(w),f=t.editableCard;if(A.test(I.content))for(let T=0;T<a;T++){const N=this.getOffsetCell(b,T),C=t.rows[T],g=t.rows[T].cells[k];let v="[None Data]",E=g.value[g.valueType],_,h="";switch(g.valueType){case"block":v=g.value.block.content,v=F(v),v=`<span contenteditable="${f}" niopInput="block" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">${v}</span>`;break;case"number":v=g.value.number.content,v=`<span contenteditable="${f}" niopInput="number" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">${v}</span>`;break;case"date":v=(E.isNotEmpty?ie(E.content):"")+(E.isNotEmpty2?` -> ${ie(E.content2)}`:"");break;case"phone":v=g.value.phone.content,v=F(v),v=`<span contenteditable="${f}" niopInput="phone" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">${v}</span>`;break;case"mAsset":if(g.value.mAsset){const m=g.value.mAsset.length;t.renderMethod===1?m===1?(v=`<span class='imgDiv'><img src="${g.value.mAsset[0].content}"></span>`,v=`<span contenteditable="${f}" niopInput="mAsset" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">${v}</span>`):v=`<span class='AssetContainer'>${g.value.mAsset.map($=>$.type==="image"?`<span class='imgDiv'><img src='${$.content}' alt='${$.name}'></span>`:`<span class='fileDiv'><a href='${$.content}' title='${$.name}'>${$.name}</a></span>`).join("")}</span>`:m===1?(v=g.value.mAsset[0].type==="image"?`![image](${g.value.mAsset[0].content})`:`![file](${g.value.mAsset[0].content})`,v=`<span contenteditable="${f}" niopInput="mAsset" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">${v}</span>`):v=`${g.value.mAsset.map($=>$.type==="image"?`![${$.name}](${$.content})`:`[${$.name}](${$.content})`).join("")}`}else v="[No Assets]",v=`<span contenteditable="${f}" niopInput="mAsset" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">${v}</span>`;break;case"select":if(_=d.options,h=`<select contenteditable="${f}"  ${f?"":"disabled"} niopInput="select" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">`,E=g.value.mSelect,h+=`<option value="" Color="" ${E?"":"selected"}  >[None]</option>`,_.length>0)for(const m of _)h+=`<option value="${m.name}" Color="${m.color}" ${E&&E.length>0&&E[0].content===m.name?"selected":""}>${m.name}</option>`;h+="</select>",v=h;break;case"mSelect":if(_=d.options,h=`<select multiple contenteditable="${f}"  ${f?"":"disabled"} niopInput="mSelect" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">`,E=g.value.mSelect,_.length>0)for(const m of _)h+=`<option value="${m.name}" Color="${m.color}" ${E&&E.some(S=>S.content===m.name)?"selected":""}>${m.name}</option>`;else h+='<option value="" style="background-color: default;">[None]</option>';h+="</select>",v=h;break;case"checkbox":E=g.value.checkbox,v=`<input type="checkbox" ${E.checked?"checked":""} contenteditable="${f}" niopInput="${g.valueType}" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">`;break;default:E.content&&(v=F(E.content),v=`<span contenteditable="${f}" niopInput="${g.valueType}" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">${v}</span>`),v==="[None Data]"&&(v=`<span contenteditable="${f}" niopInput="${g.valueType}" keyID="${g.value.keyID}" rowID="${C.id}" cellID="${g.value.id}">${v}</span>`);break}N.content=N.content.replace(w,v)}})}})}getOffsetCell(t,n){let s=0,o=t.x,a=t.y;return this.direction.card===1&&(s=n),this.direction.y===1&&(o+=n),this.direction.x===1&&(a+=n),this.cards[s][o][a]}getRawColgroup(t){this.colgroup=JSON.parse(t.colgroup)}getMdSettingFromTable(){const t=[],n={},s=this.cells[0].length;let o=0;this.cells.forEach((a,r)=>{r!=this.dashRowNum&&(a.forEach((i,l)=>{let c=i.content;const p=c.match(this.cellStyleRegex);if(p&&p[1]){let u=p[1];u.length>1&&u.charAt(u.length-1)!==";"&&(u=u+";"),n[s*o+l]=u,c=c.replace(p[0],"")}if(l==0){const u=c.match(this.rowStyleRegex);if(u&&u[1]){let d=u[1];d.length>1&&d.charAt(d.length-1)!==";"&&(d=d+";"),t.push(d),c=c.replace(u[0],"")}else t.push("")}i.content=c}),o++)}),this.rowsStyleStrs=t,this.cellStyleStrs=n}}const X=(e,t=null)=>{(0,D.fetchPost)("/api/block/getBlockKramdown",{id:e.resourceID},n=>{const s=n.data.kramdown,o=/data-av-id="([^"]+)"/,a=s.match(o);if(a)e.resourceAVID!=a[1]&&(e.resourceAVID=a[1]);else{console.log("No av-id"),e.resourceAVID="",t&&t(!1);return}t&&t(!0)})},at=(e,t=null)=>{fetchPost("/api/block/getBlockKramdown",{id:e.resourceID},n=>{const s=n.data.kramdown,o=/data-av-id="([^"]+)"/,a=s.match(o);if(a)e.resourceAVID!=a[1]&&(e.resourceAVID=a[1]);else{console.log("No av-id"),e.resourceAVID="",t&&t(!1);return}t&&t(!0)})},lt=e=>{};function ie(e){const t=new Date(e),n=t.getFullYear(),s=(t.getMonth()+1).toString().padStart(2,"0"),o=t.getDate().toString().padStart(2,"0");return`${n}-${s}-${o}`}function L(e,t,n=null){const s=JSON.stringify({id:e,attrs:t});(0,D.fetchPost)("/api/attr/setBlockAttrs",{id:e,attrs:t},o=>{n&&n(o)})}function qe(e,t,n=null,s=null){const o={id:e};return(0,D.fetchPost)("/api/attr/getBlockAttrs",o,a=>{a.data[t]?n&&n(a.data[t]):s&&s(a)}),!1}function rt(e,t){return B(this,null,function*(){const n={id:e};return fetchPost("/api/attr/getBlockAttrs",n,s=>{const o=s.data[t];return o||null}),null})}function it(e,t=null){fetchPost("/api/av/renderAttributeView",{id:e},n=>{t&&t(n)})}function ce(e,t,n=null){(0,D.fetchPost)("/api/block/updateBlock",{dataType:"markdown",data:t,id:e},s=>{n&&n(s)})}function de(e,t,n=null){(0,D.fetchPost)("/api/notification/pushMsg",{msg:e,data:t},s=>{n&&n(s)})}function ue(e,t,n=null){(0,D.fetchPost)("/api/notification/pushErrMsg",{msg:e,data:t},s=>{n&&n(s)})}const he=(e,t=30)=>B(void 0,null,function*(){const n="custom-nioptablewait";let o=0,a=!0;const r=()=>{o++>t&&(a=!1,o=0)};for(L(e,{[n]:"1"},i=>{a=!1});a;)yield new Promise(i=>setTimeout(i,50)),r();for(a=!0,L(e,{[n]:""},i=>{a=!1});a;)yield new Promise(i=>setTimeout(i,50)),r()}),H=(e,t)=>{const n=t.map(a=>`${a}="[^"]*"`).join("|"),s=new RegExp(n,"g");return e.replace(s,"")};function je(e,t,n,s,o,a){const r=document.createElement("div"),i=document.createElement("style"),l=Je(),c=n.length;i.textContent=`
.niop-card {
  padding: 5px;
  margin: 5px;
  display: inline-block;
  background-color: ${l.surfaceLight}; 
  border-radius: 5px; 
  opacity: 0.95;
  transition: box-shadow 0.3s ease; 
}
.niop-card:hover {
  box-shadow: 0 0 10px rgba(0, 0, 0, 1.0); 
  background-color: ${l.primarylight}; 
  opacity: 1;
}
.niop-card tr{
  background-color:${l.surface};
  /* height of each line */
  min-height: auto;
}
.niop-card tr.thread{
  background-color:${l.surface};
}
.niop-card img {
  line-height: 0;
  object-fit: contain;
  width: 100%;
  height: 100%;
  vertical-align: middle;
}
.niop-card td {
  border-Color:${l.cellBorderColor};
  border-collapse: collapse;
  text-align: center;
  overflow-wrap: anywhere;
  word-break: break-all;
  text-align: left;
  /*vertical-align: text-top;*/
}
.niop-card td:hover {
  box-shadow: 0px 0px 30px ${l.primarylighter};
}
.niop-card span.imgsDiv {
  width: 0;
  height: -webkit-fill-available;
  display: flex;
}
.niop-card span.imgDiv  {
  height: -webkit-fill-available;
  width: -webkit-fill-available;
}
.AssetContainer {
  position: relative;
  height: 100%;
  width: 100%;
  display: block;
  overflow-x: auto;
  white-space: nowrap;
  left: 0px;
  top: 14px;
}
.AssetContainer::-webkit-scrollbar {
height: 5px; 
background-color: transparent; 
}
.AssetContainer::-webkit-scrollbar-track {
background-color: transparent;
}
.AssetContainer::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.098); 
transition: background-color 0.3s ease; 
}
.AssetContainer:hover::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.6); 
height: 20px; 
}
.niop-card td span[niopinput] {
  width: fit-content;
  padding-right: 3px;
  /*display: inline-block;*/
}
.niop-card td span[niopinput]:empty {
  content:"[None]"
  min-width:20px;
  padding-right: 5px;
  background-color: #; 
  border-radius: 8px;
  display: inline-block;
}
.niop-card td select[niopinput="select"] {
  min-height: 25px;
  max-width: 100%;
  width:fit-content;
}
.fn__none {
  display: none !important;
}
`,r.append(i);const p=document.createElement("div");p.className="cardContainer",r.append(p),p.setAttribute("avID",a.resourceAVID),p.setAttribute("viewName",a.resourceAVViewName);const u=[];for(let d=0;d<e;d++){const k=document.createElement("div");k.className="niop-card";const w=document.createElement("table");for(let b=0;b<t;b++){const I=document.createElement("tr");if(s[b]!=""){const A=s[b];I.setAttribute("style",A)}b===0&&(I.className="thread");for(let A=0;A<n.length;A++){const f=document.createElement("td"),T=b*c+A,N=o[T];N&&f.setAttribute("style",N),f.style.width=n[A],f.style.maxWidth=n[A],f.style.height="inherit",u[d]||(u[d]=[]),u[d][b]||(u[d][b]=[]),u[d][b][A]=f,I.appendChild(f)}w.appendChild(I)}k.appendChild(w),p.appendChild(k)}return{body:r,cells:u}}function Je(){const e=window.getComputedStyle(document.documentElement);return{backgroundColor:e.getPropertyValue("--b3-theme-background"),surface:e.getPropertyValue("--b3-theme-surface"),surfaceLight:e.getPropertyValue("--b3-theme-surface-lighter"),cellBorderColor:e.getPropertyValue("--b3-border-color"),primarylight:e.getPropertyValue("--b3-theme-primary-light"),primarylighter:e.getPropertyValue("--b3-theme-primary-lighter"),primarylightest:e.getPropertyValue("--b3-theme-primary-lightest"),listhover:e.getPropertyValue("--b3-list-hover"),tooltipscolor:e.getPropertyValue("--b3-tooltips-color"),tooltipsbackground:e.getPropertyValue("--b3-tooltips-background")}}function ct(e){const t={backgroundColor:"",surface:"",surfaceLight:"",cellBorderColor:""},n=e.querySelector("thead");if(n){const a=window.getComputedStyle(n);t.surface=a.backgroundColor}const s=e.querySelector("tbody");if(s){const a=window.getComputedStyle(s);t.surfaceLight=a.backgroundColor}const o=e.querySelectorAll("td");if(o.length>0){const a=window.getComputedStyle(o[0]);t.cellBorderColor=a.borderColor}return t}function He(e){const t=/\[([^\]]*)\]\(([^)]+)\)/g;e.forEach(n=>{n.forEach(s=>{let o;for(;(o=t.exec(s.content))!==null;){const a=o[0],r=o[1],i=o[2],l=s.content[o.index-1]==="!",c=l?`<img" src="${i}" alt="${r}">`:`<a href="${i}">${r}</a>`;s.content=s.content.replace(l?"!"+a:a,c)}})})}const Ue=e=>{throw new Error("Function not implemented.")};module.exports=U})();
