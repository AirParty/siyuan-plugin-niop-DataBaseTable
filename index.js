/*!
 * MIT License
 *
 * Copyright (c) 2023 SiYuan 思源笔记
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */(()=>{"use strict";var R={};R.d=(t,e)=>{for(var o in e)R.o(e,o)&&!R.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},R.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),R.r=t=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var q={};R.r(q),R.d(q,{NiopTable:()=>F,default:()=>y});const A=require("siyuan");var V=(t,e,o)=>new Promise((n,s)=>{var i=r=>{try{l(o.next(r))}catch(c){s(c)}},a=r=>{try{l(o.throw(r))}catch(c){s(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,a);l((o=o.apply(t,e)).next())});class ie{constructor(){this.creatCommands=e=>{e.protyleSlash.push({filter:[],html:'<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">'+e.i18n.niopimportTool+'</span><span class="b3-list-item__meta">TABLE</span></div>',id:"niop-getCommand-AVdebugDialog",callback:o=>V(this,null,function*(){console.log(`${e.i18n.DataBaseImportToolDes}`+o.protyle.notebookId);const n=o.protyle.breadcrumb.id;o.insert("<span></span>");const s=new A.Dialog({title:`${e.i18n.DataBaseImportToolDes}`,content:`
                        <div class="b3-dialog__content">
                        <div class="fn__hr"></div>
                        <div>DataBae ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox1">
                        <div class="fn__hr"></div>
                        <div>Table ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox2">
                        <div class="fn__hr"></div>
                        <div style="display:none">RenderMethod:</div>
                        <div class="fn__hr"></div>
                        <div class="renderMethod">
                          <button class="niopRenderSelect" id = "niopButton5" style="display: inline-block;"></button>
                        </div>
                        <div class="fn__hr"></div>
                        <div class="fn__hr"></div>
                        <div style="display:none">json:</div>
                        <div id = "jsonstring" style="display:none"></div>
                        </div>        
                    `,width:"360px",height:"440px",destroyCallback:()=>{e.saveData("niopTID_AVID",i.value),e.saveData("niopTID_TableID",a.value)}}),i=s.element.querySelector("#niopIDBox1"),a=s.element.querySelector("#niopIDBox2"),l=s.element.querySelector("#niopButton5");l.textContent=e.i18n.import,e.loadData("niopTID_AVID").then(r=>{i.value=r}),e.loadData("niopTID_TableID").then(r=>{a.value=r}),l.addEventListener("click",()=>{de(i.value,a.value,o)})})})}}}function ae(t,e=null){(0,A.fetchPost)("/api/block/getBlockKramdown",{id:t},o=>{e&&e(o)})}function Ce(t,e=null){fetchPost("/api/block/getBlockDOM",{id:t},o=>{e&&e(o)})}function z(t,e,o=null){(0,A.fetchPost)("/api/av/renderAttributeView",{id:t,pageSize:e},n=>{o&&o(n)})}const le=(t,e=null)=>{(0,A.fetchPost)("/api/block/getBlockKramdown",{id:t},o=>{const n=o.data.kramdown,s=/data-av-id="([^"]+)"/,i=n.match(s);if(!i){console.log("No av-id"),e&&e({result:!1,value:""});return}e&&e({result:!0,value:i[1]})})};function U(){return globalThis.Lute.NewNodeID()}const _e=(t,e,o=null)=>{const n=t.id,s=[U()];let i="";t.view.rows.length>0&&(i=t.view.rows[t.view.rows.length-1].id);const a=[{action:"insertAttrViewBlock",avID:n,previousID:i,srcIDs:s,isDetached:!0}];console.log(`ac:${n} \u65B0id:${s} \u524D\u4E00\u7EA7id${i}  do:`),e.protyle.getInstance().transaction(a,[{action:"removeAttrViewBlock",srcIDs:s,avID:n}]),o&&o(1)},Ne=(t,e)=>{const n=t.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),s=t.protyle.notebookId;fetchPost("/api/filetree/getHPathByID",{id:n},i=>{const a=i.data+"/\u65B0\u5EFA\u6587\u68631";fetchPost("/api/filetree/createDocWithMd",{notebook:s,path:a,markdown:"tttt"},l=>{const r=t.protyle;setTimeout(()=>{r.getInstance().transaction([{action:"insertAttrViewBlock",avID:e.id,previousID:e.view.rows[e.view.rows.length-1].id,srcIDs:[l.data],isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:[l.data],avID:e.id}])},500)})})},re=(t,e,o,n,s,i=null)=>{let a=null;s.checkerResult.result&&(a=s.checkerResult.value,(0,A.fetchPost)("/api/av/setAttributeViewBlockAttr",{avID:t,keyID:e,rowID:o,cellID:n,value:a},l=>{i&&i(l)}))};function ce(t,e){const o=/\[([^\]]*)\]\(([^)]+)\)/,n=[];let s=0,i;for(;(i=o.exec(t))!=null;){s+=1;let a=i[1];a||(a="");const l=i[2],r=t[i.index-1]==="!",c={content:l,type:r?"image":"file",name:a};t=t.replace(r?"!"+i[0]:i[0],""),n.push(c)}return s===0?{result:!1}:{result:!0,value:{[e]:n}}}const de=(t,e,o)=>V(void 0,null,function*(){le(t,n=>{n.result&&z(n.value,2e4,s=>{ae(e,i=>V(void 0,null,function*(){if(i.code=="0"){let a=!1;const l=h=>V(void 0,null,function*(){a||(a=!0,(0,A.fetchPost)("/api/notification/pushMsg",{msg:h,data:30}),yield new Promise(w=>setTimeout(w,300)),a=!1)}),r=new we(i.data.kramdown);let c=new G(s.data.view);if(c.duplicatesRow){(0,A.fetchPost)("/api/notification/pushErrMsg",{msg:"database have duplicates name",data:1e3});return}const p=[],d=[],u=[],f=[],g=s.data.view.rows.length;if(r.cells[0].forEach((h,w)=>{c.columnIndexMap[h.content]!=null&&h.content!=""&&w!=0&&p.push({col:w,name:h.content})}),p.length===0)return;for(let h=1;h<r.cells.length;h++){const w={name:r.cells[h][0].content,row:h};if(w.name=="")continue;const S=c.getCellData(w.name);u.push(w),S.result||d.push(w)}const m=!1;let b=!0,k=0;const C=o.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),v=o.protyle.notebookId,E=s.data,D=[],T=[];if(d.length>0&&m){k=d.length;let h=0;console.log("creat new note "+d.length);const w=new Date,S=`import${w.getFullYear()}_${w.getMonth()}_${w.getDay()}_${w.getHours()}_${w.getMinutes()}`;for((0,A.fetchPost)("/api/filetree/getHPathByID",{id:C},x=>V(void 0,null,function*(){(0,A.fetchPost)("/api/filetree/createDocWithMd",{notebook:v,path:x.data+"/"+S,markdown:`import at ${w.getDate()}`},_=>V(void 0,null,function*(){for(const ne of d){h++;const Se=x.data+"/"+S+"/"+ne.name;for(console.log("creat new note "+ne.name),(0,A.fetchPost)("/api/filetree/createDocWithMd",{notebook:v,path:Se,markdown:""},W=>{D.push(W.data),k--,h--});h>0;)yield new Promise(W=>setTimeout(W,10))}}))}));k>0;)yield new Promise(x=>setTimeout(x,200)),l("wait for creat note "+k);l("note creat over "+d.length)}else if(d.length>0)for(const h of d){const w=U();D.push(w),T.push(h.name)}if(yield new Promise(h=>setTimeout(h,250)),D.length>0){D.reverse(),T.reverse();const h=o.protyle,w=E.view.rows.length>0?E.view.rows[E.view.rows.length-1].id:"";h.getInstance().transaction([{action:"insertAttrViewBlock",avID:E.id,previousID:w,srcIDs:D,isDetached:!m}],[{action:"removeAttrViewBlock",srcIDs:D,avID:E.id}]),yield new Promise(_=>setTimeout(_,1500)),b=!0;let S;const x=s.data.view.rowCount+D.length;for(;b;)yield new Promise(_=>setTimeout(_,1200)),z(n.value,x,_=>{b&&_.data.view.rowCount==x&&(S=_,b=!1)}),l("wait for av reload");yield new Promise(_=>setTimeout(_,200)),console.log(S),s=S}c=new G(s.data.view),m||(c.setEmptyBlockCell(D,T),d.forEach(h=>{const w=c.getCellData(h.name,c.keyColumnName,h.name);w.columnName=h.name,w.keyName=h.name,w.reX=h.row,f.push(w)})),k=p.length*u.length;for(const h of p)for(const w of u){const S=c.getCellData(w.name,h.name,r.cells[w.row][h.col].content);S.result&&(S.reX=w.row,S.reY=h.col,S.content=r.cells[w.row][h.col].content,f.push(S))}yield new Promise(h=>setTimeout(h,200)),k=0;let N=0;for(let h=0;h<f.length;h++){k++,l("UPDATE "+h+" / "+f.length);const w=f[h];for(w.checkerResult.result?(re(n.value,w.value.keyID,w.rowsID,w.value.id,w,()=>{k--}),N++):k--;k>0;)yield new Promise(S=>setTimeout(S,2))}(0,A.fetchPost)("/api/notification/pushMsg",{msg:"Import Over with"+N+" data",data:1e3})}}))})})});class G{constructor(e){this.duplicatesRow=!1,this.lateKeyName="",this.laterowIndex=0,this.data=e,this.preprocessData()}preprocessData(){const e=this.data.columns.find(o=>o.type==="block");this.keyColumnIndex=this.data.columns.indexOf(e),this.keyColumnName=e.name,this.columnIndexMap={},this.rowValueChecker={},this.data.columns.forEach((o,n)=>{this.columnIndexMap[o.name]=n,this.rowValueChecker[n]=ue(o)}),this.rowIndexMap={},this.emptyRowIndexMap={},this.data.rows.forEach((o,n)=>{const s=o.cells[this.keyColumnIndex].value.block.content;s&&s!=""?(this.rowIndexMap[s]&&(console.log("block name duplicate "+s),this.duplicatesRow=!0),this.rowIndexMap[s]=n):this.emptyRowIndexMap[o.id]=n})}getCellData(e,o="",n=""){if(e!=this.lateKeyName){if(this.laterowIndex=this.rowIndexMap[e],this.laterowIndex===void 0)return{result:!1,debug:"have no main key"};this.lateKeyName=e}if(o=="")return{result:!0};const s=this.columnIndexMap[o];if(s===void 0)return{result:!1,debug:"have no attr"};const i=this.data.rows[this.laterowIndex],a=i.cells[s],l=this.rowValueChecker[s],r=l(n,a.value,a.valueType);return{result:!0,value:a.value,checkerResult:r,column:this.data.columns[s],rowsID:i.id,keyName:e,columnName:o}}setEmptyBlockCell(e,o){for(let n=0;n<e.length;n++){const s=e[n],i=o[n],a=this.emptyRowIndexMap[s];a>=0?(this.rowIndexMap[i]=a,delete this.emptyRowIndexMap[s]):(console.error(`error with wrong index ${s} ${i} ${n}`),this.error())}}}const ue=t=>{const e={};let o=O;switch(t.type){case"text":return P;case"date":return fe;case"number":return pe;case"relation":return O;case"rollup":return O;case"select":if(!t.options)return(n,s,i)=>({result:!1,faliResult:t.name+" No Any Options"});return t.options.forEach(n=>{e[n.name]=n}),o=(n,s,i)=>{const a=e[n];let l=!1,r="",c="";if(!a)return r="input isnot in select options",{result:l,faliResult:r};const p=s.mSelect;if(p&&n==p[0].content)return r="the same as input",{result:l,faliResult:r};const d={mSelect:[{content:a.name,color:a.color}]};return c=`[${n}] -> [${p}]`,l=!0,{result:l,value:d,successLog:c}},o;break;case"block":return he;case"mSelect":if(!t.options)return(n,s,i)=>({result:!1,faliResult:t.name+" No Any Options"});return t.options.forEach(n=>{e[n.name]=n}),o=(n,s,i)=>{let a=!1,l="",r="",c="",p="";const d=[];let u=n.split(",");u||(u=[n]);const f=s.mSelect;for(let m=0;m<u.length;m++){const b=u[m],k=e[b];if(!k){c+=b+",";continue}let I=!1;if(f){for(let C=0;C<f.length;C++)if(f[C].content==b){I=!0;break}}if(I){p+=b+",";continue}d.push({content:k.name,color:k.color})}if(d.length<1)return l=`unKnow option:(${c}) duplicate option:(${p})`,{result:a,faliResult:l};let g;return f?g={mSelect:[...s.mSelect,...d]}:g={mSelect:d},r=`[${n}] -> [${f}]`,a=!0,{result:a,value:g,successLog:r}},o;break;case"url":return P;case"email":return P;case"phone":return P;case"mAsset":return ge;case"checkbox":return me;default:return O}},he=(t,e,o)=>{const n=e.block.content;let s=!1,i="",a="";if(t==n)return i=`the same as input (${n})`,{result:s,faliResult:i};const l={block:{content:t}};return a=`[${t}] -> [${n}]`,s=!0,{result:s,value:l,successLog:a}},P=(t,e,o)=>{const n=e[o].content;let s=!1,i="",a="";if(t==n)return i=`the same as input (${n})`,{result:s,faliResult:i};const l={[o]:{content:t}};return a=`[${t}] -> [${n}]`,s=!0,{result:s,value:l,successLog:a}},pe=(t,e,o)=>{const n=e.number.content;let s=!1,i="",a="";if(parseFloat(t)==n)return i=`the same as input (${n})`,{result:s,faliResult:i};const l={number:{content:parseFloat(t)}};return a=`[${t}] -> [${n}]`,s=!0,{result:s,value:l,successLog:a}},fe=(t,e,o)=>{const n=e.date,s={content:0,isNotEmpty:!1,content2:0,isNotEmpty2:!1,isNotTime:!1};s.hasEndDate=n.hasEndDate,s.isNotTime=n.isNotTime;let i=!1,a="",l="",r=0;const c=t.split(",");if(c.length>=1){const d=c[0].trim(),u=Y(d);u!==0&&(s.content=u,s.isNotEmpty=!0),n.content===s.content&&r++}if(c.length>=2){const d=c[1].trim(),u=Y(d);u!==0&&(s.content2=u,s.isNotEmpty2=!0,s.hasEndDate=!0),n.content2===s.content2&&r++}if(r==2)return a=`the same as input (${n})`,{result:i,faliResult:a};const p={date:s};return l=`[${t}] -> [${n}]`,i=!0,{result:i,value:p,successLog:l}};function Y(t){const e=Date.parse(t);return isNaN(e)?0:e+new Date().getTimezoneOffset()*60*1e3}const me=(t,e,o)=>{const n=e.checkbox.checked;let s=!1,i="",a="";if(t==="")return i=`input is empety (${t})`,{result:s,faliResult:i};const l=t.includes("true");if(l===n)return i=`the same as input (${n})`,{result:s,faliResult:i};const r={checkbox:{checked:l}};return a=`[${t}] -> [${n}]`,s=!0,{result:s,value:r,successLog:a}},O=(t,e,o)=>({result:!1,faliResult:`Unkonw type [${o}] value [${t}]`}),ge=(t,e,o)=>{const n=ce(t,o);let s=!1,i="",a="";if(!n.result)return i=`input isnot asset (${t})`,{result:s,faliResult:i};const l=n.value[o];let r=[],c=[];if(e.mAsset){if(r=l.filter(p=>!e.mAsset.some(u=>u.content===p.content)),r.length===0)return i=`${t} -> already in database `,{result:s,faliResult:i};a+=`asset ${r.length} ${r.map(p=>p.content).join(" ")} -> ${e.mAsset?e.mAsset.length:"none"}`,e.mAsset&&e.mAsset.length>0&&(r=[...e.mAsset,...r]),n.value=r}return c=n.value,s=!0,{result:s,value:c,successLog:a}};class we{constructor(e){this.cells=[],this.end="",this.duplicatesRow=!1,this.keyWorlds={},this.kmdCellRegex=/{:\s*(.+?)\s*}/,this.kmdCell=o=>{const n=o.match(this.kmdCellRegex);return n?{content:o.replace(n[0],"")}:{content:o}},this.parseTable(e)}parseTable(e){const o=e.split(`
`);this.end=o[o.length-1],o.slice(0,-1).map(s=>s.split(new RegExp("(?<!\\\\)\\|")).map(i=>i.replace(/\\\|/g,"|"))).forEach((s,i)=>{this.cells[i]=[],s.forEach((a,l)=>{this.cells[i][l]=this.kmdCell(a)}),this.cells[i]=this.cells[i].slice(1,-1),this.cells[i][0].content=this.sanitizeFileName(this.cells[i][0].content),this.keyWorlds[this.cells[i][0].content]?(this.keyWorlds[this.cells[i][0].content]+=1,this.duplicatesRow=!0):this.keyWorlds[this.cells[i][0].content]=1}),this.cells=this.cells.slice(0,1).concat(this.cells.slice(2))}sanitizeFileName(e){const o=/[\/\\\?%\*:|"<>]/g;return e.replace(o,"").replace(/<br\/>/g,"")}}function Re(t,e,o=null){fetchPost("/api/notification/pushMsg",{msg:t,data:e},n=>{o&&o(n)})}function Me(t,e,o=null){fetchPost("/api/notification/pushErrMsg",{msg:t,data:e},n=>{o&&o(n)})}var M=(t,e,o)=>new Promise((n,s)=>{var i=r=>{try{l(o.next(r))}catch(c){s(c)}},a=r=>{try{l(o.throw(r))}catch(c){s(c)}},l=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,a);l((o=o.apply(t,e)).next())});const X=!1,j="menu-config",xe="custom_tab",Ve="dock_tab",$=class extends A.Plugin{onload(){this.eventBus.on("switch-protyle",this.switch_protyle),$.Ini=this,this.eventBus.on("click-blockicon",this.blockIconEvent.bind(this)),this.protyleSlash=[{filter:["table","data table","database table","niop","\u8868\u683C","\u6570\u636E\u8868\u683C","\u6570\u636E\u5E93\u8868\u683C","shujubiaoge"],html:`<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${this.i18n.dTable}</span><span class="b3-list-item__meta">TABLE</span></div>`,id:"creatniopDateTable",callback(a){return M(this,null,function*(){const l=a.protyle.breadcrumb.id,r=a.protyle.contentElement.querySelector(`[data-node-id="${l}"]`),c=a.protyle.transactionTime;yield(d=>M(this,null,function*(){a.insert("<span></span>"),yield se(l),J(r,l,a.protyle,200)}))(1)})}}];const t=document.createElement("div");t.innerHTML=`
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u8F85\u52A9\u5DE5\u5177 -->
<select id="niopSelect" >
    <option value="close">${$.Ini.i18n.close}</option>
    <option value="open">${$.Ini.i18n.open}</option>
</select>

<!-- \u9009\u62E9\u6846\u548C\u8F93\u5165\u6846 \u9884\u5B9A\u4E49 CSS -->
<div id="niopContainer" class="fn__none">
    <select id="niopSelect2">
        <option value="option1">\u4F7F\u7528\u5185\u5D4Ccss</option>
        <option value="option2">\u4F7F\u7528\u81EA\u5B9A\u4E49css</option>
    </select>
    <button onclick="console.log('Clicked!')">\u6062\u590D\u9ED8\u8BA4css</button>
    <input type="text" id="niopInput" placeholder="Type something...">
</div>    
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u5FEB\u901F\u5DE5\u5177\u680F \u8F93\u51FA log -->
<select id="niopSelect3" class="fn__none">
    <option value="option1">Option 1</option>
    <option value="option2">Option 2</option>
    <option value="option3">Option 3</option>
</select>
<!-- \u5FEB\u901F\u5DE5\u5177\u680F -->
<div id="niopToolbar" class="fn__none">
    <button onclick="console.log('Clicked!')">Log</button>
</div>
    `;const e=t.querySelector("#niopSelect"),o=t.querySelector("#niopSelect2"),n=t.querySelector("#niopInput"),s=t.querySelector("#niopSelect3"),i=t.querySelector("#niopToolbar");this.setting=new A.Setting({confirmCallback:()=>{this.saveData(j,{useAdvanceTools:e.value})}}),this.setting.addItem({title:`${$.Ini.i18n.useImportToll}`,createActionElement:()=>(this.loadData(j).then(a=>{a.useAdvanceTools&&(e.value=a.useAdvanceTools)}),t)}),console.log("DatabaseTable from niop ~"),this.loadData(j).then(a=>{a.useAdvanceTools&&new ie().creatCommands(this)})}onLayoutReady(){}onunload(){this.eventBus.off("switch-protyle",this.switch_protyle),this.eventBus.off("click-blockicon",this.blockIconEvent.bind(this))}EventMenu(){}blockIconEvent({detail:t}){t.menu.addItem({iconHTML:'<svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg>',label:this.i18n.dTable,click:()=>{const e=t.blockElements[0],o=e.getAttribute("data-node-id");J(e,o,t.protyle,0)}})}switch_protyle(t){const e=t.detail.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr");if(!e)return;let o=e.getAttribute("niopStatu");if(o||(o="addToolBar",e.setAttribute("niopStatu",o)),o==="addToolBar"){const n=t.detail.protyle.contentElement;n.addEventListener("click",s=>{if(s.altKey){const i=s.composedPath();for(let a=0;a<i.length;a++){const l=i[a];if(typeof l.getAttribute=="function"&&l.getAttribute($.ATTRNAME)!==null){const r=l,c=r.getAttribute("data-node-id");J(r,c,t.detail.protyle,0),s.preventDefault(),s.stopPropagation();break}if(l===n)break}}})}e.setAttribute("niopStatu","none")}};let y=$;y.OnRedner=!1,y.ATTRNAME="custom-nioptable";const $e=()=>{},J=(t,e,o,n=1e3)=>{const s=t,i=s.getAttribute("data-type");if(i!="NodeTable"&&i!="NodeHTMLBlock"){oe("\u53EA\u80FD\u4F7F\u7528\u5728Table\u4E0A",4e3);return}if(i==="NodeHTMLBlock"&&!s.getAttribute(y.ATTRNAME)){oe("\u6CA1\u6709\u539F\u59CB\u8868\u683C\u6570\u636E",4e3);return}const a=c=>{if(c.nodeID=e,c.tableNode=s,c.protyle=o,c.renderEditMethod===2||c.renderEditMethod<1){c.renderEditMethod=2;const p=[],d=c.tableNode.querySelector("colgroup");d&&d.querySelectorAll("col").forEach(f=>{const g=f.getBoundingClientRect().width,m=g?`${g}px`:"";p.push(m)}),c.colgroup=JSON.stringify(p),(0,A.fetchPost)("/api/block/getBlockKramdown",{id:c.nodeID},u=>M(void 0,null,function*(){c.renderEditMethod=2,c.setSourceTable(u.data.kramdown),yield se(e),H(c)}))}else H(c)},l=c=>{const p=s.getAttribute(y.ATTRNAME),d=new F(p);n>10?setTimeout(()=>{a(d)},n):a(d)},r=c=>{const p=new F(""),d={[y.ATTRNAME]:p.getJson()};n>10?setTimeout(()=>{B(e,d,()=>{a(p)})},n):B(e,d,()=>{a(p)})};De(e,y.ATTRNAME,l,r)},Be=t=>{const e=t,o=e.getAttribute("data-node-id"),n=e.getAttribute(y.ATTRNAME);if(!o){console.error("error with data-node-id ");return}const s=e.getElementsByClassName("protyle-attr"),i=document.createElement("div");i.setAttribute("contenteditable","false"),i.classList.add("niop-toolbar-container"),i.addEventListener("mouseenter",()=>{i.classList.remove("hide"),i.classList.add("show")}),i.addEventListener("mouseleave",()=>{i.classList.remove("show"),i.classList.add("hide")}),s[0].appendChild(i);const a=new F(n);a.nodeID=o,a.tableNode=e;const l=document.createElement("button");l.textContent="Toolbar",l.setAttribute("niopButton","showMenu"),l.setAttribute("contenteditable","false"),l.classList.add("niop-button"),i.appendChild(l),l.addEventListener("click",()=>{H(a)});const r=document.createElement("button");r.textContent="Reload",r.setAttribute("niopButton","reload"),r.setAttribute("contenteditable","false"),r.classList.add("niop-button"),i.appendChild(r),r.addEventListener("click",()=>{Te(a)}),a.toolBarMenuContainer=i},H=t=>{let e=!1;const o=T=>{e&&t.save(N=>{setTimeout(()=>{},200)})},n=new A.Dialog({title:`${y.Ini.i18n.OnEditSomthing_Table} : ${t.nodeID}`,content:`
      <div class="b3-dialog__content">
      <div class="fn__hr"></div>
      <div>${y.Ini.i18n.AVBlockID}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Dababase ID" id = "niopIDBox">
      <div class="fn__hr"></div>
      <div >${y.Ini.i18n.AVViewName}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Views Name" id = "niopIDBox2">
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${y.Ini.i18n.RenderMethodAs}:</div>
      <div class="fn__hr"></div>
      <div class="renderMethod">
        <button class="niopRenderSelect" id = "niopRenderSelectCard" style="display: inline-block;" >${y.Ini.i18n.renderCard}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectRight" style="display: inline-block;">${y.Ini.i18n.renderRight}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectDown" style="display: inline-block;" >${y.Ini.i18n.renderBelow}</button>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>DisPlay as:</div>
      <div class="fn__hr"></div>
      <div class="niopRenderMethodDis">
      <div class="niopRenderSelect" id = "niopRenderAsEditor" aria-label="">${y.Ini.i18n.currentDisPlayMethod_Editor}</div>
      <div class="niopRenderSelect" id = "niopRenderAsDataBase" aria-label="">${y.Ini.i18n.currentDisPlayMethod_DateBase}</div>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>Switch Render:</div>
      <div class="fn__hr"></div>
      <div class="niopLoadMethod">
      <button class="niop-button" id = "niopEditTable" aria-label="">${y.Ini.i18n.currentDisPlayMethod_Editor}</button>
      <span style="width:120px;height:60px;"><span>
      <button class="niop-button" id = "niopReloadAll" aria-label="">${y.Ini.i18n.ReloadAll}</button>
      </div>
      <div class="fn__hr"></div>
      <div style="display:none">Edit</div>
      <div class="fn__hr"></div>

      <button class="niop-button hide" id = "niopSetFiltter" >SetFiltter</button>
      <button class="niop-button hide" id = "niopCleanFiltter" >cleanFiltter</button>
      <div class="fn__hr" style="display:none"></div>
      <div class="fn_none" style="display:none">json:</div>
      <div id = "jsonstring" class="fn_none" style="display:none"></div>
      </div>        
  `,width:"360px",height:"480px",destroyCallback:o}),s=n.element.querySelector("#jsonstring"),i=n.element.querySelector("#niopIDBox"),a=n.element.querySelector("#niopIDBox2"),l=n.element.querySelector("#niopRenderSelectCard"),r=n.element.querySelector("#niopRenderSelectRight"),c=n.element.querySelector("#niopRenderSelectDown"),p=n.element.querySelector("#niopEditTable"),d=n.element.querySelector("#niopReloadAll"),u=n.element.querySelector("#niopRenderAsEditor"),f=n.element.querySelector("#niopRenderAsDataBase"),g=n.element.querySelector("#niopSetFiltter"),m=n.element.querySelector("#niopCleanFiltter"),b=()=>{s.innerText=t.getJson()},k=()=>{l.classList.remove("select"),r.classList.remove("select"),c.classList.remove("select"),u.classList.remove("select"),f.classList.remove("select"),t.renderMethod===1?l.classList.add("select"):t.renderMethod===2?r.classList.add("select"):t.renderMethod===3&&c.classList.add("select"),t.renderEditMethod===1&&f.classList.add("select"),t.renderEditMethod===2&&u.classList.add("select")},I=()=>{const T=[{action:"setAttrViewFilters",avID:t.resourceAVID,data:t.hotReloadSetting.filters},{action:"setAttrViewSorts",avID:t.resourceAVID,data:t.hotReloadSetting.sorts}];t.protyle.getInstance().transaction(T)},C=()=>{t.renderEditMethod=2,u.classList.add("select"),f.classList.remove("select");const T=L(t.sourceTable,["fold","updated"]);ee(t.nodeID,T,N=>{}),y.OnRedner=!1,e=!0,b()},v=T=>{t.resourceAVID!=""&&(u.classList.remove("select"),f.classList.add("select"),be(t,T))},E=()=>{K(t,T=>{if(!T){console.log("no av on the block:"+t.resourceID);return}e=!0,t.renderEditMethod=1,v(!1),b()})},D=()=>{const T=t.resourceAVID;K(t,N=>{if(!N){console.log("no av on the block"+t.resourceID);return}t.resourceAVID!=T?v(!1):v(!0),b()})};i.value=t.resourceID,a.value=t.resourceAVViewName,K(t,()=>{b()}),i.addEventListener("input",()=>{t.resourceID=i.value,e=!0}),a.addEventListener("input",()=>{t.resourceAVViewName=a.value,e=!0}),l.addEventListener("click",()=>{t.renderMethod=1,e=!0,b(),k()}),r.addEventListener("click",()=>{t.renderMethod=2,e=!0,b(),k()}),c.addEventListener("click",()=>{t.renderMethod=3,e=!0,b(),k()}),p.addEventListener("click",C),d.addEventListener("click",E),i.innerText=t.resourceID,k()},be=(t,e=!0)=>M(void 0,null,function*(){if(y.OnRedner){te(`${y.Ini.i18n.pleaseWaitOnRendering}`,3e3);return}y.OnRedner=!0,(0,A.fetchPost)("/api/av/renderAttributeView",{id:t.resourceAVID},o=>M(void 0,null,function*(){const n=o.data.view.rowCount,s=()=>{X&&(console.log("niopTable:"),console.log(t));const a=new ke(t.sourceTable,t);let l="";switch(t.renderMethod){case 1:a.direction={card:1,x:0,y:0},a.makeToCard(t),l=a.RebuildAsCard(t);break;case 2:a.direction={card:0,x:1,y:0},a.makeToCard(t),l=a.Rebuild(t);break;case 3:a.direction={card:0,x:0,y:1},a.makeToCard(t),l=a.Rebuild(t);break;default:te(`${y.Ini.i18n.mustSelectOneRenderMethod}`,5e3);break}X&&(console.log("\u9884\u5904\u7406\u8868\u683C"),console.log(a),console.log(l)),ee(t.nodeID,l),t.renderEditMethod=1,y.OnRedner=!1};e=!1;let i=o.data.view.id;if(t.resourceAVViewName!=""&&o.data.view.name!=t.resourceAVViewName&&o.data.views.length>1){for(let a=0;a<o.data.views.length;a++){const l=o.data.views[a];if(l.name===t.resourceAVViewName){e=!0,i=l.id;break}}e||console.log("error view name")}e||n>o.data.view.rows.length?(0,A.fetchPost)("/api/av/renderAttributeView",{id:t.resourceAVID,viewID:i,pageSize:n},l=>{t.titles=t.deepCopy(l.data.view.columns),t.rows=l.data.view.rows,t.avTable=l,s()}):(t.titles=t.deepCopy(o.data.view.columns),t.rows=o.data.view.rows,t.avTable=o,s())}))}),Pe=(t,e=null)=>{fetchPost("/api/av/renderAttributeView",{id:t.resourceAVID},o=>{t.titles=t.deepCopy(o.data.view.columns),t.rows=o.data.view.rows,t.avTable=o,t.setting.filters=Object.assign(o.data.view.filters),t.setting.sorts=Object.assign(o.data.view.sorts),e&&e()})},Oe=t=>{console.log(t)};class F{constructor(e){this.renderMethod=-1,this.renderEditMethod=2,this.resourceID="",this.resourceAVID="",this.resourceAVViewName="",this.setting={filters:[],sorts:[]},this.hotReloadSetting={filters:[],sorts:[]},this.titles=[{id:"",name:"",type:"",icon:"",wrap:!1,hidden:!1,pin:!1,width:"68px",numberFormat:"",template:""}],this.sourceTable="",this.colgroup="",this.nodeID="";try{const o=JSON.parse(e);this.renderMethod=o.renderMethod||this.renderMethod,this.resourceID=o.resourceID||this.resourceID,this.resourceAVID=o.resourceAVID||this.resourceAVID,this.sourceTable=this.decode(o.sourceTable)||this.sourceTable,this.renderEditMethod=o.renderEditMethod||this.renderEditMethod,this.hotReloadSetting=o.hotReloadSetting||this.hotReloadSetting,this.colgroup=this.decode(o.colgroup)||this.colgroup,this.resourceAVViewName=o.resourceAVViewName||this.resourceAVViewName}catch(o){console.log("Error parsing JSON:",o),this.save(n=>{setTimeout(()=>{},200)})}}clean(){this.protyle=null}getJson(){return JSON.stringify({renderMethod:this.renderMethod,resourceID:this.resourceID,resourceAVID:this.resourceAVID,sourceTable:this.encode(this.sourceTable),renderEditMethod:this.renderEditMethod,hotReloadSetting:this.hotReloadSetting,colgroup:this.encode(this.colgroup),resourceAVViewName:this.resourceAVViewName})}encode(e){const o=encodeURIComponent(e);return window.btoa(o)}decode(e){try{const o=atob(e);return decodeURIComponent(o)}catch(o){return console.error("Error decoding string:",o),""}}deepCopy(e){return JSON.parse(JSON.stringify(e))}setSourceTable(e){const o=/custom-nioptable="[^"]*"/g,n=e.replace(o,"");this.sourceTable=n}save(e=null){if(this.nodeID!=""){const o={[y.ATTRNAME]:this.getJson()};e?B(this.nodeID,o,n=>{e(n)}):B(this.nodeID,o)}}}const Fe=()=>{const t=`|{: colspan="4" rowspan="1"}\u6807\u9898|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|
| :-------------------------------: | :--------------------------------: | :--------------------------------: | :--------------------------------: |
|{: colspan="1"}\u5934\u50CF|{: colspan="1"}\u540D\u5B57|{: colspan="1"}\u7B49\u7EA7|\u6280\u80FD|
|..(icon)|..(name)|..(level)|..(skill)|
{: colgroup="width: 94px;|width: 121px;|width: 95px;|width: 116px;" custom-nioptable="123" fold="0" id="20231120114455-g1jmigv" updated="20231130193916"}`,o=t.split(`
`).slice(0,-1).map(s=>s.split(new RegExp("(?<!\\\\)\\|")).map(i=>i.replace(/\\\|/g,"|"))),n=[[{content:"",config:""}]];o.forEach((s,i)=>{n[i]=[],s.forEach((a,l)=>{n[i][l]=Q(a)}),n[i]=n[i].slice(1,-1)}),console.log(t),console.log(n)},ve=/{:\s*(.+?)\s*}/,Q=t=>{const e=t.match(ve);if(e){const o=t.replace(e[0],""),n=ye(e[1]),s=n.attributes,i=!!(s.colspan&&s.colspan>1||s.rowspan&&s.rowspan>1);return{content:o,config:s,configNo:n.length,resize:i,valueType:"",colspan:s.colspan?parseInt(s.colspan):1,rowspan:s.rowspan?parseInt(s.rowspan):1}}else return{content:t,config:{},configNo:0,resize:!1,valueType:"",colspan:1,rowspan:1}};function ye(t){const e=/(\S+)=["']([^"']+)["']/g,o=t.match(e);if(!o)return{};const n={};let s=0;return o.forEach(i=>{const[a,l,r]=i.match(/(\S+)=["']([^"']+)["']/);n[l]=r,s++}),{attributes:n,length:s}}class ke{constructor(e,o){this.cells=[],this.dashRowNum=1,this.colgroup=[],this.rowsStyleStrs=[],this.end="",this.cards=[],this.haveActionValueRegex=/\.\.\((.+?)\)/g,this.checkifHaveActionValue=n=>!!n.content.match(this.haveActionValueRegex),this.direction={card:0,x:0,y:0},this.curCell={card:0,x:0,y:0},this.parseTable(e,o)}parseTable(e,o){const n={};let s=!1;const i=e.split(`
`);this.end=i[i.length-1],i.slice(0,-1).map(l=>l.split(new RegExp("(?<!\\\\)\\|")).map(r=>r.replace(/\\\|/g,"|"))).forEach((l,r)=>{this.cells[r]=[];let c=!1;n[r]||(n[r]=0),l.forEach((p,d)=>{if(this.cells[r][d]=Q(p),!s&&this.cells[r][d].rowspan>1){c=!0;for(let u=0;u<this.cells[r][d].rowspan;u++)n[r+u]?n[r+u]+=1:n[r+u]=1}}),!s&&!c&&n[r]===0&&(s=!0,this.dashRowNum<r&&(this.dashRowNum=r)),this.cells[r]=this.cells[r].slice(1,-1)}),this.getRawColgroup(o),this.getMdSettingFromTable()}removeEmpetyInputRows(e){const o=e.avTable.data.view;let n=-1;for(let i=0;i<o.columns.length;i++)if(o.columns[i].type==="block"){n=i;break}const s=[];for(let i=0;i<o.rows.length;i++)o.rows[i].cells[n].value.block.content===""&&s.push(i);for(let i=s.length-1;i>=0;i--)o.rows.splice(s[i],1)}caculateColAndRowGroup(e){this.cells.forEach((o,n)=>{o.forEach((s,i)=>{switch(e.renderMethod){case 1:break;case 2:s.colspan>1&&o.length==i+s.colspan?(s.colspan+=e.rows.length-1,s.config.colspan=s.colspan):o.length==1&&s.colspan==1&&this.dashRowNum!=n&&(this.checkifHaveActionValue(s)||(s.colspan+=e.rows.length-1,s.config.colspan=s.colspan,s.configNo+=1));break;case 3:s.rowspan>1&&this.cells.length==n+s.rowspan+1?(s.rowspan+=e.rows.length,s.config.rowspan=s.rowspan):this.cells.length==2&&s.rowspan==1&&this.dashRowNum!=n&&(this.checkifHaveActionValue(s)||(s.rowspan+=e.rows.length-1,s.config.rowspan=s.rowspan,s.configNo+=1));break;default:break}})})}Rebuild(e){const o=this.cards.map(i=>i.map(a=>"|"+a.map(l=>{let r="";return l.configNo>0&&(r="{: "+Object.entries(l.config).map(([c,p])=>`${c}="${p}"`).join("  ")+"}"),r+l.content}).join("|")).join(`|
`)).join("");this.end=e.renderMethod===2?L(this.end,["fold","id","updated","colgroup"]):L(this.end,["fold","id","updated"]);let n=' id="'+e.nodeID+'" ';e.renderMethod===2&&(n+=' colgroup="'+this.colgroup.map(i=>"width: "+i+";").join("|")+'" ');const s=this.end;return this.end=s.slice(0,2)+n+s.slice(2),`${o}
${this.end}`}RebuildAsCard(e){const o=L(this.end,["fold","id","updated","colgroup"]),n=` id="${e.nodeID}"  data-type="NodeHTMLBlock" `;this.end=o.slice(0,2)+n+o.slice(2);const s=Ae(this.cards.length,this.cells.length-1,this.colgroup,this.rowsStyleStrs,e),i=[];return this.cards.forEach((a,l)=>{a.forEach((r,c)=>{if(this.dashRowNum!=c){const p=c>this.dashRowNum?c-1:c;r.forEach((d,u)=>{const f=s.cells[l][p][u];if(f.innerHTML=d.content,d.configNo>0){if(d.colspan>1||d.rowspan>1)for(let g=0;g<d.colspan;g++)for(let m=0;m<d.rowspan;m++)g===0&&m===0||i.push(s.cells[l][p+m][u+g]);if(d.colspan>1){f.setAttribute("colspan",`${d.colspan}`);let g=parseInt(f.style.width);for(let m=1;m<d.colspan;m++)g+=parseInt(s.cells[l][p][u+m].style.width);f.style.width=g+"px"}d.rowspan>1&&f.setAttribute("rowspan",`${d.rowspan}`)}})}}),i.forEach(r=>{r.className="fn__none"})}),`<div>${s.body.innerHTML}</div>
${this.end}`}makeToCard(e){this.cards=[],this.removeEmpetyInputRows(e),this.caculateColAndRowGroup(e);const o=this.cells[0].length,n=this.cells.length,s=e.titles.length,i=e.rows.length,a=this.cards,l={card:0,x:0,y:0},r=this.direction;if(r.card==1?(Ie(this.cells),e.rows.forEach((u,f)=>{a[f]=e.deepCopy(this.cells)})):a[0]=e.deepCopy(this.cells),r.x===1){const u=a[0],f=this.colgroup[this.colgroup.length-1];for(let g=0;g<e.rows.length-1;g++)this.colgroup.push(f);for(let g=0;g<n;g++){const m=JSON.parse(JSON.stringify(u[g][o-1]));m.colspan>1&&this.dashRowNum!=g&&(m.content="",m.config.class="fn__none",m.colspan=1,m.config.colspan=1,m.configNo=1);const b=JSON.stringify(m);e.rows.forEach((k,I)=>{I!=0&&u[g].push(JSON.parse(b))})}}if(r.y===1){const u=a[0],f=e.rows.length,g=u[0].length,m=this.dashRowNum===n-1;let b;m?b=JSON.parse(JSON.stringify(Object.assign(u[n-2]))):b=Object.assign(JSON.parse(JSON.stringify(u[n-1]))),b.forEach(I=>{I.rowspan>1&&(I.content="",I.config.class="fn__none",I.rowspan=1,I.config.rowspan=1,I.configNo=1)});const k=JSON.stringify(b);for(let I=1;I<f;I++)m?u.splice(u.length-1,0,JSON.parse(k)):u.push(JSON.parse(k))}const c=[],p=/\.\.\((.*?)\)/;this.cells.forEach((u,f)=>{u.forEach((g,m)=>{g.content.match(p)&&c.push({x:f,y:m})})}),e.titles.forEach((u,f)=>{if(u.name!=""){const g=`..(${u.name})`;c.forEach(m=>{const b=this.cells[m.x][m.y];if(new RegExp(g).test(b.content))for(let I=0;I<i;I++){const C=this.getOffsetCell(m,I),v=e.rows[I].cells[f];let E="[None Data]",D=v.value[v.valueType];switch(v.valueType){case"block":E=v.value.block.content;break;case"number":E=v.value.number.content;break;case"date":E=(D.isNotEmpty?Z(D.content):"")+(D.isNotEmpty2?` -> ${Z(D.content2)}`:"");break;case"phone":E=v.value.phone.content;break;case"mAsset":if(v.value.mAsset&&(e.renderMethod===1?E=`<span class='imgDiv'><img src="${v.value.mAsset[0].content}"></span>`:E=`![image](${v.value.mAsset[0].content})`),v.value.mAsset){const T=v.value.mAsset.length;e.renderMethod===1?T===1?E=`<span class='imgDiv'><img src="${v.value.mAsset[0].content}"></span>`:E=`<span class='AssetContainer'>${v.value.mAsset.map(h=>h.type==="image"?`<span class='imgDiv'><img src='${h.content}' alt='${h.name}'></span>`:`<span class='fileDiv'><a href='${h.content}' title='${h.name}'>${h.name}</a></span>`).join("")}</span>`:T===1?E=v.value.mAsset[0].type==="image"?`![image](${v.value.mAsset[0].content})`:`![file](${v.value.mAsset[0].content})`:E=`${v.value.mAsset.map(h=>h.type==="image"?`![${h.name}](${h.content})`:`[${h.name}](${h.content})`).join("")}`}else E="[No Assets]";break;case"select":D=v.value.mSelect,D&&(E=D.length>0?D[0].content:"None Select");break;case"mSelect":D=v.value.mSelect,D&&(E=D.length>0?D.map(T=>T.content).join(","):"None Select");break;default:D.content&&(E=D.content);break}C.content=C.content.replace(g,E)}})}})}getOffsetCell(e,o){let n=0,s=e.x,i=e.y;return this.direction.card===1&&(n=o),this.direction.y===1&&(s+=o),this.direction.x===1&&(i+=o),this.cards[n][s][i]}getRawColgroup(e){this.colgroup=JSON.parse(e.colgroup)}getMdSettingFromTable(){const e=[];this.cells.forEach((o,n)=>{if(n!=this.dashRowNum){const s=o[0].content,i=/\.\.style\(([^)]*)\)/,a=s.match(i);if(a&&a[1]){const l=a[1];let r=a[1];r.length>1&&r.charAt(r.length-1)!==";"&&(r=r+";"),e.push(r),o[0].content=s.replace(a[0],"")}else e.push("")}}),this.rowsStyleStrs=e}}const K=(t,e=null)=>{(0,A.fetchPost)("/api/block/getBlockKramdown",{id:t.resourceID},o=>{const n=o.data.kramdown,s=/data-av-id="([^"]+)"/,i=n.match(s);if(i)t.resourceAVID!=i[1]&&(t.resourceAVID=i[1]);else{console.log("No av-id"),t.resourceAVID="",e&&e(!1);return}e&&e(!0)})},Le=(t,e=null)=>{fetchPost("/api/block/getBlockKramdown",{id:t.resourceID},o=>{const n=o.data.kramdown,s=/data-av-id="([^"]+)"/,i=n.match(s);if(i)t.resourceAVID!=i[1]&&(t.resourceAVID=i[1]);else{console.log("No av-id"),t.resourceAVID="",e&&e(!1);return}e&&e(!0)})},qe=t=>{};function Z(t){const e=new Date(t),o=e.getFullYear(),n=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getDate().toString().padStart(2,"0");return`${o}-${n}-${s}`}function B(t,e,o=null){const n=JSON.stringify({id:t,attrs:e});(0,A.fetchPost)("/api/attr/setBlockAttrs",{id:t,attrs:e},s=>{o&&o(s)})}function De(t,e,o=null,n=null){const s={id:t};return(0,A.fetchPost)("/api/attr/getBlockAttrs",s,i=>{i.data[e]?o&&o(i.data[e]):n&&n(i)}),!1}function je(t,e){return M(this,null,function*(){const o={id:t};return fetchPost("/api/attr/getBlockAttrs",o,n=>{const s=n.data[e];return s||null}),null})}function Je(t,e=null){fetchPost("/api/av/renderAttributeView",{id:t},o=>{e&&e(o)})}function ee(t,e,o=null){(0,A.fetchPost)("/api/block/updateBlock",{dataType:"markdown",data:e,id:t},n=>{o&&o(n)})}function te(t,e,o=null){(0,A.fetchPost)("/api/notification/pushMsg",{msg:t,data:e},n=>{o&&o(n)})}function oe(t,e,o=null){(0,A.fetchPost)("/api/notification/pushErrMsg",{msg:t,data:e},n=>{o&&o(n)})}const se=(t,e=30)=>M(void 0,null,function*(){const o="custom-nioptablewait";let s=0,i=!0;const a=()=>{s++>e&&(i=!1,s=0)};for(B(t,{[o]:"1"},l=>{i=!1});i;)yield new Promise(l=>setTimeout(l,50)),a();for(i=!0,B(t,{[o]:""},l=>{i=!1});i;)yield new Promise(l=>setTimeout(l,50)),a()}),L=(t,e)=>{const o=e.map(i=>`${i}="[^"]*"`).join("|"),n=new RegExp(o,"g");return t.replace(n,"")};function Ae(t,e,o,n,s){const i=document.createElement("div"),a=document.createElement("style"),l=Ee();a.textContent=`
.niop-card {
  padding: 5px;
  margin: 5px;
  display: inline-block;
  background-color: ${l.surfaceLight}; 
  border-radius: 5px; 
  opacity: 0.95;
  transition: box-shadow 0.3s ease; 
}
.niop-card:hover {
  box-shadow: 0 0 10px rgba(0, 0, 0, 1.0); 
  background-color: ${l.primarylight}; 
  opacity: 1;
}
.niop-card tr{
  background-color:${l.surface};
  /* height of each line */
  min-height: auto;
}
.niop-card tr.thread{
  background-color:${l.surface};
}
.niop-card img {
  line-height: 0;
  object-fit: contain;
  width: 100%;
  height: 100%;
  vertical-align: middle;
}
.niop-card td {
  border-Color:${l.cellBorderColor};
  border-collapse: collapse;
  text-align: center;
  overflow-wrap: anywhere;
}
.niop-card td:hover {
  box-shadow: 0px 0px 30px ${l.primarylighter};
}
.niop-card span.imgsDiv {
  width: 0;
  height: -webkit-fill-available;
  display: flex;
}
.niop-card span.imgDiv  {
  height: -webkit-fill-available;
  width: -webkit-fill-available;
}
.AssetContainer {
  position: relative;
  height: 100%;
  width: 100%;
  display: block;
  overflow-x: auto;
  white-space: nowrap;
  left: 0px;
  top: 14px;
}
.AssetContainer::-webkit-scrollbar {
height: 5px; 
background-color: transparent; 
}
.AssetContainer::-webkit-scrollbar-track {
background-color: transparent;
}
.AssetContainer::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.098); 
transition: background-color 0.3s ease; 
}
.AssetContainer:hover::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.6); 
height: 20px; 
}
.fn__none {
  display: none !important;
}
`,i.append(a);const r=document.createElement("div");r.className="cardContainer",i.append(r);const c=[];for(let p=0;p<t;p++){const d=document.createElement("div");d.className="niop-card";const u=document.createElement("table");for(let f=0;f<e;f++){const g=document.createElement("tr");if(n[f]!=""){const m=n[f];g.setAttribute("style",m)}f===0&&(g.className="thread");for(let m=0;m<o.length;m++){const b=document.createElement("td");b.style.width=o[m],b.style.height="inherit",c[p]||(c[p]=[]),c[p][f]||(c[p][f]=[]),c[p][f][m]=b,g.appendChild(b)}u.appendChild(g)}d.appendChild(u),r.appendChild(d)}return{body:i,cells:c}}function Ee(){const t=window.getComputedStyle(document.documentElement);return{backgroundColor:t.getPropertyValue("--b3-theme-background"),surface:t.getPropertyValue("--b3-theme-surface"),surfaceLight:t.getPropertyValue("--b3-theme-surface-lighter"),cellBorderColor:t.getPropertyValue("--b3-border-color"),primarylight:t.getPropertyValue("--b3-theme-primary-light"),primarylighter:t.getPropertyValue("--b3-theme-primary-lighter"),primarylightest:t.getPropertyValue("--b3-theme-primary-lightest"),listhover:t.getPropertyValue("--b3-list-hover"),tooltipscolor:t.getPropertyValue("--b3-tooltips-color"),tooltipsbackground:t.getPropertyValue("--b3-tooltips-background")}}function He(t){const e={backgroundColor:"",surface:"",surfaceLight:"",cellBorderColor:""},o=t.querySelector("thead");if(o){const i=window.getComputedStyle(o);e.surface=i.backgroundColor}const n=t.querySelector("tbody");if(n){const i=window.getComputedStyle(n);e.surfaceLight=i.backgroundColor}const s=t.querySelectorAll("td");if(s.length>0){const i=window.getComputedStyle(s[0]);e.cellBorderColor=i.borderColor}return e}function Ie(t){const e=/\[([^\]]*)\]\(([^)]+)\)/g;t.forEach(o=>{o.forEach(n=>{let s;for(;(s=e.exec(n.content))!==null;){const i=s[0],a=s[1],l=s[2],r=n.content[s.index-1]==="!",c=r?`<img style="max-width:px;" src="${l}" alt="${a}">`:`<a href="${l}">${a}</a>`;n.content=n.content.replace(r?"!"+i:i,c)}})})}const Te=t=>{throw new Error("Function not implemented.")};module.exports=q})();
