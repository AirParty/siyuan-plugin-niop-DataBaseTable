/*!
 * MIT License
 *
 * Copyright (c) 2023 SiYuan 思源笔记
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */(()=>{"use strict";var N={};N.d=(e,t)=>{for(var o in t)N.o(t,o)&&!N.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},N.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),N.r=e=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var j={};N.r(j),N.d(j,{NiopTable:()=>O,default:()=>w});const k=require("siyuan");var $=(e,t,o)=>new Promise((s,n)=>{var a=r=>{try{i(o.next(r))}catch(c){n(c)}},l=r=>{try{i(o.throw(r))}catch(c){n(c)}},i=r=>r.done?s(r.value):Promise.resolve(r.value).then(a,l);i((o=o.apply(e,t)).next())});class le{constructor(){this.creatCommands=t=>{t.protyleSlash.push({filter:[],html:'<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">'+t.i18n.niopimportTool+'</span><span class="b3-list-item__meta">TABLE</span></div>',id:"niop-getCommand-AVdebugDialog",callback:o=>$(this,null,function*(){console.log(`${t.i18n.DataBaseImportToolDes}`+o.protyle.notebookId);const s=o.protyle.breadcrumb.id;o.insert("<span></span>");const n=new k.Dialog({title:`${t.i18n.DataBaseImportToolDes}`,content:`
                        <div class="b3-dialog__content">
                        <div class="fn__hr"></div>
                        <div>DataBae ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox1">
                        <div class="fn__hr"></div>
                        <div>Table ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox2">
                        <div class="fn__hr"></div>
                        <div style="display:none">RenderMethod:</div>
                        <div class="fn__hr"></div>
                        <div class="renderMethod">
                          <button class="niopRenderSelect" id = "niopButton5" style="display: inline-block;"></button>
                        </div>
                        <div class="fn__hr"></div>
                        <div class="fn__hr"></div>
                        <div style="display:none">json:</div>
                        <div id = "jsonstring" style="display:none"></div>
                        </div>        
                    `,width:"360px",height:"440px",destroyCallback:()=>{t.saveData("niopTID_AVID",a.value),t.saveData("niopTID_TableID",l.value)}}),a=n.element.querySelector("#niopIDBox1"),l=n.element.querySelector("#niopIDBox2"),i=n.element.querySelector("#niopButton5");i.textContent=t.i18n.import,t.loadData("niopTID_AVID").then(r=>{a.value=r}),t.loadData("niopTID_TableID").then(r=>{l.value=r}),i.addEventListener("click",()=>{pe(a.value,l.value,o,t)})})})}}}function ce(e,t=null){(0,k.fetchPost)("/api/block/getBlockKramdown",{id:e},o=>{t&&t(o)})}function Ve(e,t=null){fetchPost("/api/block/getBlockDOM",{id:e},o=>{t&&t(o)})}function G(e,t,o=null){(0,k.fetchPost)("/api/av/renderAttributeView",{id:e,pageSize:t},s=>{o&&o(s)})}const de=(e,t=null)=>{(0,k.fetchPost)("/api/block/getBlockKramdown",{id:e},o=>{const s=o.data.kramdown,n=/data-av-id="([^"]+)"/,a=s.match(n);if(!a){console.log("No av-id"),t&&t({result:!1,value:""});return}t&&t({result:!0,value:a[1]})})};function Y(){return globalThis.Lute.NewNodeID()}const Me=(e,t,o=null)=>{const s=e.id,n=[Y()];let a="";e.view.rows.length>0&&(a=e.view.rows[e.view.rows.length-1].id);const l=[{action:"insertAttrViewBlock",avID:s,previousID:a,srcIDs:n,isDetached:!0}];console.log(`ac:${s} \u65B0id:${n} \u524D\u4E00\u7EA7id${a}  do:`),t.protyle.getInstance().transaction(l,[{action:"removeAttrViewBlock",srcIDs:n,avID:s}]),o&&o(1)},xe=(e,t)=>{const s=e.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),n=e.protyle.notebookId;fetchPost("/api/filetree/getHPathByID",{id:s},a=>{const l=a.data+"/\u65B0\u5EFA\u6587\u68631";fetchPost("/api/filetree/createDocWithMd",{notebook:n,path:l,markdown:"tttt"},i=>{const r=e.protyle;setTimeout(()=>{r.getInstance().transaction([{action:"insertAttrViewBlock",avID:t.id,previousID:t.view.rows[t.view.rows.length-1].id,srcIDs:[i.data],isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:[i.data],avID:t.id}])},500)})})},ue=(e,t,o,s,n,a=null)=>{let l=null;n.checkerResult.result&&(l=n.checkerResult.value,(0,k.fetchPost)("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,rowID:o,cellID:s,value:l},i=>{a&&a(i)}))};function he(e,t){const o=/\[([^\]]*)\]\(([^)]+)\)/,s=[];let n=0,a;for(;(a=o.exec(e))!=null;){n+=1;let l=a[1];l||(l="");const i=a[2],r=e[a.index-1]==="!",c={content:i,type:r?"image":"file",name:l};e=e.replace(r?"!"+a[0]:a[0],""),s.push(c)}return n===0?{result:!1}:{result:!0,value:{[t]:s}}}const pe=(e,t,o,s)=>$(void 0,null,function*(){de(e,n=>{n.result&&G(n.value,2e4,a=>{ce(t,l=>$(void 0,null,function*(){if(s.OnImportData){s.OnImportData=!1;return}try{if(l.code=="0"){let i=!1;const r=f=>$(void 0,null,function*(){i||(i=!0,(0,k.fetchPost)("/api/notification/pushMsg",{msg:f,data:30}),yield new Promise(v=>setTimeout(v,300)),i=!1)});s.OnImportData=!0;const c=new ye(l.data.kramdown);let u=new X(a.data.view);if(u.duplicatesRow){(0,k.fetchPost)("/api/notification/pushErrMsg",{msg:"database have duplicates name",data:1e3});return}const h=[],d=[],m=[],p=[],g=a.data.view.rows.length;if(c.cells[0].forEach((f,v)=>{u.columnIndexMap[f.content]!=null&&f.content!=""&&v!=0&&h.push({col:v,name:f.content})}),h.length===0)return;for(let f=1;f<c.cells.length;f++){const v={name:c.cells[f][0].content,row:f};if(v.name=="")continue;const T=u.getCellData(v.name);m.push(v),T.result||d.push(v)}const D=!1;let S=!0,b=0;const A=o.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),I=o.protyle.notebookId,E=a.data,C=[],P=[];if(d.length>0&&D){b=d.length;let f=0;console.log("creat new note "+d.length);const v=new Date,T=`import${v.getFullYear()}_${v.getMonth()}_${v.getDay()}_${v.getHours()}_${v.getMinutes()}`;for((0,k.fetchPost)("/api/filetree/getHPathByID",{id:A},x=>$(void 0,null,function*(){(0,k.fetchPost)("/api/filetree/createDocWithMd",{notebook:I,path:x.data+"/"+T,markdown:`import at ${v.getDate()}`},_=>$(void 0,null,function*(){for(const ie of d){f++;const Ne=x.data+"/"+T+"/"+ie.name;for(console.log("creat new note "+ie.name),(0,k.fetchPost)("/api/filetree/createDocWithMd",{notebook:I,path:Ne,markdown:""},z=>{C.push(z.data),b--,f--});f>0;)yield new Promise(z=>setTimeout(z,10))}}))}));b>0;)yield new Promise(x=>setTimeout(x,200)),r("wait for creat note "+b);r("note creat over "+d.length)}else if(d.length>0)for(const f of d){const v=Y();C.push(v),P.push(f.name)}if(yield new Promise(f=>setTimeout(f,250)),C.length>0){C.reverse(),P.reverse();const f=o.protyle,v=E.view.rows.length>0?E.view.rows[E.view.rows.length-1].id:"";f.getInstance().transaction([{action:"insertAttrViewBlock",avID:E.id,previousID:v,srcIDs:C,isDetached:!D}],[{action:"removeAttrViewBlock",srcIDs:C,avID:E.id}]),yield new Promise(_=>setTimeout(_,1500)),S=!0;let T;const x=a.data.view.rowCount+C.length;for(;S;)yield new Promise(_=>setTimeout(_,1200)),G(n.value,x,_=>{S&&_.data.view.rowCount==x&&(T=_,S=!1)}),r("wait for av reload");yield new Promise(_=>setTimeout(_,200)),console.log(T),a=T}u=new X(a.data.view),D||(u.setEmptyBlockCell(C,P),d.forEach(f=>{const v=u.getCellData(f.name,u.keyColumnName,f.name);v.columnName=f.name,v.keyName=f.name,v.reX=f.row,p.push(v)})),b=h.length*m.length;for(const f of h)for(const v of m){const T=u.getCellData(v.name,f.name,c.cells[v.row][f.col].content);T.result&&(T.reX=v.row,T.reY=f.col,T.content=c.cells[v.row][f.col].content,p.push(T))}yield new Promise(f=>setTimeout(f,200)),b=0;let y=0;for(let f=0;f<p.length;f++){b++,r("UPDATE "+f+" / "+p.length);const v=p[f];for(v.checkerResult.result?(ue(n.value,v.value.keyID,v.rowsID,v.value.id,v,()=>{b--}),y++):b--;b>0;)yield new Promise(T=>setTimeout(T,2))}s.OnImportData=!1,(0,k.fetchPost)("/api/notification/pushMsg",{msg:"Import Over with"+y+" data",data:1e3})}}catch{s.OnImportData=!1}}))})})});class X{constructor(t){this.duplicatesRow=!1,this.lateKeyName="",this.laterowIndex=0,this.data=t,this.preprocessData()}preprocessData(){const t=this.data.columns.find(o=>o.type==="block");this.keyColumnIndex=this.data.columns.indexOf(t),this.keyColumnName=t.name,this.columnIndexMap={},this.rowValueChecker={},this.data.columns.forEach((o,s)=>{this.columnIndexMap[o.name]=s,this.rowValueChecker[s]=fe(o)}),this.rowIndexMap={},this.emptyRowIndexMap={},this.data.rows.forEach((o,s)=>{const n=o.cells[this.keyColumnIndex].value.block.content;n&&n!=""?(this.rowIndexMap[n]&&(console.log("block name duplicate "+n),this.duplicatesRow=!0),this.rowIndexMap[n]=s):this.emptyRowIndexMap[o.id]=s})}getCellData(t,o="",s=""){if(t!=this.lateKeyName){if(this.laterowIndex=this.rowIndexMap[t],this.laterowIndex===void 0)return{result:!1,debug:"have no main key"};this.lateKeyName=t}if(o=="")return{result:!0};const n=this.columnIndexMap[o];if(n===void 0)return{result:!1,debug:"have no attr"};const a=this.data.rows[this.laterowIndex],l=a.cells[n],i=this.rowValueChecker[n],r=i(s,l.value,l.valueType);return{result:!0,value:l.value,checkerResult:r,column:this.data.columns[n],rowsID:a.id,keyName:t,columnName:o}}setEmptyBlockCell(t,o){for(let s=0;s<t.length;s++){const n=t[s],a=o[s],l=this.emptyRowIndexMap[n];l>=0?(this.rowIndexMap[a]=l,delete this.emptyRowIndexMap[n]):(console.error(`error with wrong index ${n} ${a} ${s}`),this.error())}}}const fe=e=>{const t={};let o=L;switch(e.type){case"text":return F;case"date":return be;case"number":return ge;case"relation":return L;case"rollup":return L;case"select":if(!e.options)return(s,n,a)=>({result:!1,faliResult:e.name+" No Any Options"});return e.options.forEach(s=>{t[s.name]=s}),o=(s,n,a)=>{const l=t[s];let i=!1,r="",c="";if(!l)return r="input isnot in select options",{result:i,faliResult:r};const u=n.mSelect;if(u&&s==u[0].content)return r="the same as input",{result:i,faliResult:r};const h={mSelect:[{content:l.name,color:l.color}]};return c=`[${s}] -> [${u}]`,i=!0,{result:i,value:h,successLog:c}},o;break;case"block":return me;case"mSelect":if(!e.options)return(s,n,a)=>({result:!1,faliResult:e.name+" No Any Options"});return e.options.forEach(s=>{t[s.name]=s}),o=(s,n,a)=>{let l=!1,i="",r="",c="",u="";const h=[];let d=s.split(",");d||(d=[s]);const m=n.mSelect;for(let g=0;g<d.length;g++){const D=d[g],S=t[D];if(!S){c+=D+",";continue}let b=!1;if(m){for(let R=0;R<m.length;R++)if(m[R].content==D){b=!0;break}}if(b){u+=D+",";continue}h.push({content:S.name,color:S.color})}if(h.length<1)return i=`unKnow option:(${c}) duplicate option:(${u})`,{result:l,faliResult:i};let p;return m?p={mSelect:[...n.mSelect,...h]}:p={mSelect:h},r=`[${s}] -> [${m}]`,l=!0,{result:l,value:p,successLog:r}},o;break;case"url":return F;case"email":return F;case"phone":return F;case"mAsset":return we;case"checkbox":return ve;default:return L}},me=(e,t,o)=>{const s=t.block.content;let n=!1,a="",l="";if(e==s)return a=`the same as input (${s})`,{result:n,faliResult:a};const i={block:{content:e}};return l=`[${e}] -> [${s}]`,n=!0,{result:n,value:i,successLog:l}},F=(e,t,o)=>{const s=t[o].content;let n=!1,a="",l="";if(e==s)return a=`the same as input (${s})`,{result:n,faliResult:a};const i={[o]:{content:e}};return l=`[${e}] -> [${s}]`,n=!0,{result:n,value:i,successLog:l}},ge=(e,t,o)=>{const s=t.number.content;let n=!1,a="",l="";if(parseFloat(e)==s)return a=`the same as input (${s})`,{result:n,faliResult:a};const i={number:{content:parseFloat(e)}};return l=`[${e}] -> [${s}]`,n=!0,{result:n,value:i,successLog:l}},be=(e,t,o)=>{const s=t.date,n={content:0,isNotEmpty:!1,content2:0,isNotEmpty2:!1,isNotTime:!1};n.hasEndDate=s.hasEndDate,n.isNotTime=s.isNotTime;let a=!1,l="",i="",r=0;const c=e.split(",");if(c.length>=1){const h=c[0].trim(),d=Q(h);d!==0&&(n.content=d,n.isNotEmpty=!0),s.content===n.content&&r++}if(c.length>=2){const h=c[1].trim(),d=Q(h);d!==0&&(n.content2=d,n.isNotEmpty2=!0,n.hasEndDate=!0),s.content2===n.content2&&r++}if(r==2)return l=`the same as input (${s})`,{result:a,faliResult:l};const u={date:n};return i=`[${e}] -> [${s}]`,a=!0,{result:a,value:u,successLog:i}};function Q(e){const t=Date.parse(e);return isNaN(t)?0:t+new Date().getTimezoneOffset()*60*1e3}const ve=(e,t,o)=>{const s=t.checkbox.checked;let n=!1,a="",l="";if(e==="")return a=`input is empety (${e})`,{result:n,faliResult:a};const i=e.includes("true");if(i===s)return a=`the same as input (${s})`,{result:n,faliResult:a};const r={checkbox:{checked:i}};return l=`[${e}] -> [${s}]`,n=!0,{result:n,value:r,successLog:l}},L=(e,t,o)=>({result:!1,faliResult:`Unkonw type [${o}] value [${e}]`}),we=(e,t,o)=>{const s=he(e,o);let n=!1,a="",l="";if(!s.result)return a=`input isnot asset (${e})`,{result:n,faliResult:a};const i=s.value[o];let r=[],c=[];if(t.mAsset){if(r=i.filter(u=>!t.mAsset.some(d=>d.content===u.content)),r.length===0)return a=`${e} -> already in database `,{result:n,faliResult:a};l+=`asset ${r.length} ${r.map(u=>u.content).join(" ")} -> ${t.mAsset?t.mAsset.length:"none"}`,t.mAsset&&t.mAsset.length>0&&(r=[...t.mAsset,...r]),s.value=r}return c=s.value,n=!0,{result:n,value:c,successLog:l}};class ye{constructor(t){this.cells=[],this.end="",this.duplicatesRow=!1,this.keyWorlds={},this.kmdCellRegex=/{:\s*(.+?)\s*}/,this.kmdCell=o=>{const s=o.match(this.kmdCellRegex);return s?{content:o.replace(s[0],"")}:{content:o}},this.parseTable(t)}parseTable(t){const o=t.split(`
`);this.end=o[o.length-1],o.slice(0,-1).map(n=>n.split(new RegExp("(?<!\\\\)\\|")).map(a=>a.replace(/\\\|/g,"|"))).forEach((n,a)=>{this.cells[a]=[],n.forEach((l,i)=>{this.cells[a][i]=this.kmdCell(l)}),this.cells[a]=this.cells[a].slice(1,-1),this.cells[a][0].content=this.sanitizeFileName(this.cells[a][0].content),this.keyWorlds[this.cells[a][0].content]?(this.keyWorlds[this.cells[a][0].content]+=1,this.duplicatesRow=!0):this.keyWorlds[this.cells[a][0].content]=1}),this.cells=this.cells.slice(0,1).concat(this.cells.slice(2))}sanitizeFileName(t){const o=/[\/\\\?%\*:|"<>]/g;return t.replace(o,"").replace(/<br\/>/g,"")}}function $e(e,t,o=null){fetchPost("/api/notification/pushMsg",{msg:e,data:t},s=>{o&&o(s)})}function Be(e,t,o=null){fetchPost("/api/notification/pushErrMsg",{msg:e,data:t},s=>{o&&o(s)})}var V=(e,t,o)=>new Promise((s,n)=>{var a=r=>{try{i(o.next(r))}catch(c){n(c)}},l=r=>{try{i(o.throw(r))}catch(c){n(c)}},i=r=>r.done?s(r.value):Promise.resolve(r.value).then(a,l);i((o=o.apply(e,t)).next())});const J=!1,H="menu-config",Pe="custom_tab",Oe="dock_tab",M=class extends k.Plugin{onload(){this.eventBus.on("switch-protyle",this.switch_protyle),M.Ini=this,this.eventBus.on("click-blockicon",this.blockIconEvent.bind(this)),this.protyleSlash=[{filter:["table","data table","database table","niop","\u8868\u683C","\u6570\u636E\u8868\u683C","\u6570\u636E\u5E93\u8868\u683C","shujubiaoge"],html:`<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${this.i18n.dTable}</span><span class="b3-list-item__meta">TABLE</span></div>`,id:"creatniopDateTable",callback(l){return V(this,null,function*(){const i=l.protyle.breadcrumb.id,r=l.protyle.contentElement.querySelector(`[data-node-id="${i}"]`),c=l.protyle.transactionTime;yield(h=>V(this,null,function*(){l.insert("<span></span>"),yield re(i),U(r,i,l.protyle,200)}))(1)})}}];const e=document.createElement("div");e.innerHTML=`
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u8F85\u52A9\u5DE5\u5177 -->
<select id="niopSelect" >
    <option value="close">${M.Ini.i18n.close}</option>
    <option value="open">${M.Ini.i18n.open}</option>
</select>

<!-- \u9009\u62E9\u6846\u548C\u8F93\u5165\u6846 \u9884\u5B9A\u4E49 CSS -->
<div id="niopContainer" class="fn__none">
    <select id="niopSelect2">
        <option value="option1">\u4F7F\u7528\u5185\u5D4Ccss</option>
        <option value="option2">\u4F7F\u7528\u81EA\u5B9A\u4E49css</option>
    </select>
    <button onclick="console.log('Clicked!')">\u6062\u590D\u9ED8\u8BA4css</button>
    <input type="text" id="niopInput" placeholder="Type something...">
</div>    
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u5FEB\u901F\u5DE5\u5177\u680F \u8F93\u51FA log -->
<select id="niopSelect3" class="fn__none">
    <option value="option1">Option 1</option>
    <option value="option2">Option 2</option>
    <option value="option3">Option 3</option>
</select>
<!-- \u5FEB\u901F\u5DE5\u5177\u680F -->
<div id="niopToolbar" class="fn__none">
    <button onclick="console.log('Clicked!')">Log</button>
</div>
    `;const t=e.querySelector("#niopSelect"),o=e.querySelector("#niopSelect2"),s=e.querySelector("#niopInput"),n=e.querySelector("#niopSelect3"),a=e.querySelector("#niopToolbar");this.setting=new k.Setting({confirmCallback:()=>{this.saveData(H,{useAdvanceTools:t.value})}}),this.setting.addItem({title:`${M.Ini.i18n.useImportToll}`,createActionElement:()=>(this.loadData(H).then(l=>{l.useAdvanceTools&&(t.value=l.useAdvanceTools)}),e)}),console.log("DatabaseTable from niop ~"),this.loadData(H).then(l=>{l.useAdvanceTools&&new le().creatCommands(this)})}onLayoutReady(){}onunload(){this.eventBus.off("switch-protyle",this.switch_protyle),this.eventBus.off("click-blockicon",this.blockIconEvent.bind(this))}EventMenu(){}blockIconEvent({detail:e}){e.menu.addItem({iconHTML:'<svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg>',label:this.i18n.dTable,click:()=>{const t=e.blockElements[0],o=t.getAttribute("data-node-id");U(t,o,e.protyle,0)}})}switch_protyle(e){const t=e.detail.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr");if(!t)return;let o=t.getAttribute("niopStatu");if(o||(o="addToolBar",t.setAttribute("niopStatu",o)),o==="addToolBar"){const n=e.detail.protyle.contentElement;n.addEventListener("click",a=>{if(a.altKey){const l=a.composedPath();for(let i=0;i<l.length;i++){const r=l[i];if(typeof r.getAttribute=="function"&&r.getAttribute(M.ATTRNAME)!==null){const c=r,u=c.getAttribute("data-node-id");U(c,u,e.detail.protyle,0),a.preventDefault(),a.stopPropagation();break}if(r===n)break}}})}e.detail.protyle.contentElement.querySelectorAll(`[${M.ATTRNAME}]`).forEach(n=>{ke(n,e.detail.protyle)}),t.setAttribute("niopStatu","none")}};let w=M;w.OnRedner=!1,w.OnImportData=!1,w.ATTRNAME="custom-nioptable";const Fe=()=>{},ke=(e,t)=>{if(w.OnRedner||w.OnImportData)return;const o=e,s=o.getAttribute("data-node-id"),n=o.getAttribute(w.ATTRNAME);if(J&&console.log(n),n){const a=new O(n);if(a.renderEditMethod!=1)return;a.nodeID=s,a.protyle=t,a.reFreshOnPageSelect&&De(a)}},U=(e,t,o,s=1e3)=>{const n=e,a=n.getAttribute("data-type");if(a!="NodeTable"&&a!="NodeHTMLBlock"){ae("DataBaseTable only used on Table",4e3);return}if(a==="NodeHTMLBlock"&&!n.getAttribute(w.ATTRNAME)){ae("error with wrong attribute",4e3);return}const l=c=>{if(c.nodeID=t,c.tableNode=n,c.protyle=o,c.renderEditMethod===2||c.renderEditMethod<1){c.renderEditMethod=2;const u=[],h=c.tableNode.querySelector("colgroup");h&&h.querySelectorAll("col").forEach(m=>{const p=m.getBoundingClientRect().width,g=p?`${p}px`:"";u.push(g)}),c.colgroup=JSON.stringify(u),(0,k.fetchPost)("/api/block/getBlockKramdown",{id:c.nodeID},d=>V(void 0,null,function*(){c.renderEditMethod=2,c.setSourceTable(d.data.kramdown),yield re(t),K(c)}))}else K(c)},i=c=>{const u=n.getAttribute(w.ATTRNAME),h=new O(u);s>10?setTimeout(()=>{l(h)},s):l(h)},r=c=>{const u=new O(""),h={[w.ATTRNAME]:u.getJson()};s>10?setTimeout(()=>{B(t,h,()=>{l(u)})},s):B(t,h,()=>{l(u)})};Se(t,w.ATTRNAME,i,r)},Le=e=>{const t=e,o=t.getAttribute("data-node-id"),s=t.getAttribute(w.ATTRNAME);if(!o){console.error("error with data-node-id ");return}const n=t.getElementsByClassName("protyle-attr"),a=document.createElement("div");a.setAttribute("contenteditable","false"),a.classList.add("niop-toolbar-container"),a.addEventListener("mouseenter",()=>{a.classList.remove("hide"),a.classList.add("show")}),a.addEventListener("mouseleave",()=>{a.classList.remove("show"),a.classList.add("hide")}),n[0].appendChild(a);const l=new O(s);l.nodeID=o,l.tableNode=t;const i=document.createElement("button");i.textContent="Toolbar",i.setAttribute("niopButton","showMenu"),i.setAttribute("contenteditable","false"),i.classList.add("niop-button"),a.appendChild(i),i.addEventListener("click",()=>{K(l)});const r=document.createElement("button");r.textContent="Reload",r.setAttribute("niopButton","reload"),r.setAttribute("contenteditable","false"),r.classList.add("niop-button"),a.appendChild(r),r.addEventListener("click",()=>{Re(l)}),l.toolBarMenuContainer=a},K=e=>{let t=!1;const o=y=>{t&&e.save(f=>{setTimeout(()=>{},200)})},s=new k.Dialog({title:`${w.Ini.i18n.OnEditSomthing_Table} : ${e.nodeID}`,content:`
      <div class="b3-dialog__content">
      <div class="fn__hr"></div>
      <div>${w.Ini.i18n.AVBlockID}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Dababase ID" id = "niopIDBox">
      <div class="fn__hr"></div>
      <div >${w.Ini.i18n.AVViewName}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Views Name" id = "niopIDBox2">
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${w.Ini.i18n.RenderMethodAs}:</div>
      <div class="fn__hr"></div>
      <div class="renderMethod">
        <button class="niopRenderSelect" id = "niopRenderSelectCard" style="display: inline-block;" >${w.Ini.i18n.renderCard}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectRight" style="display: inline-block;">${w.Ini.i18n.renderRight}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectDown" style="display: inline-block;" >${w.Ini.i18n.renderBelow}</button>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>DisPlay as:</div>
      <div class="fn__hr"></div>
      <div class="niopRenderMethodDis">
      <div class="niopRenderSelect" id = "niopRenderAsEditor" aria-label="">${w.Ini.i18n.currentDisPlayMethod_Editor}</div>
      <div class="niopRenderSelect" id = "niopRenderAsDataBase" aria-label="">${w.Ini.i18n.currentDisPlayMethod_DateBase}</div>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>Switch Render:</div>
      <div class="fn__hr"></div>
      <div class="niopLoadMethod">
      <button class="niop-button" id = "niopEditTable" aria-label="">${w.Ini.i18n.currentDisPlayMethod_Editor}</button>
      <span style="width:120px;height:60px;"><span>
      <button class="niop-button" id = "niopReloadAll" aria-label="">${w.Ini.i18n.ReloadAll}</button>
      </div>
      <div class="fn__hr"></div>
      <div>${w.Ini.i18n.AutoReloadOn}</div>
      <div class="fn__hr"></div>
      <button class="niopRenderSelect" id = "reLoadOnTabSelect" aria-label="">${w.Ini.i18n.reLoadOnTabSelect}</button>
      <div class="fn__hr"></div>
      <div style="display:none">Edit</div>
      <div class="fn__hr"></div>

      <button class="niop-button hide" id = "niopSetFiltter" >SetFiltter</button>
      <button class="niop-button hide" id = "niopCleanFiltter" >cleanFiltter</button>
      <div class="fn__hr" style="display:none"></div>
      <div class="fn_none" style="display:none">json:</div>
      <div id = "jsonstring" class="fn_none" style="display:none"></div>
      </div>        
  `,width:"360px",height:"500px",destroyCallback:o}),n=s.element.querySelector("#jsonstring"),a=s.element.querySelector("#niopIDBox"),l=s.element.querySelector("#niopIDBox2"),i=s.element.querySelector("#niopRenderSelectCard"),r=s.element.querySelector("#niopRenderSelectRight"),c=s.element.querySelector("#niopRenderSelectDown"),u=s.element.querySelector("#niopEditTable"),h=s.element.querySelector("#niopReloadAll"),d=s.element.querySelector("#reLoadOnTabSelect"),m=s.element.querySelector("#niopRenderAsEditor"),p=s.element.querySelector("#niopRenderAsDataBase"),g=s.element.querySelector("#niopSetFiltter"),D=s.element.querySelector("#niopCleanFiltter"),S=()=>{n.innerText=e.getJson()},b=()=>{i.classList.remove("select"),r.classList.remove("select"),c.classList.remove("select"),m.classList.remove("select"),p.classList.remove("select"),d.classList.remove("select"),e.renderMethod===1?i.classList.add("select"):e.renderMethod===2?r.classList.add("select"):e.renderMethod===3&&c.classList.add("select"),e.renderEditMethod===1&&p.classList.add("select"),e.renderEditMethod===2&&m.classList.add("select"),e.reFreshOnPageSelect&&d.classList.add("select")},R=()=>{const y=[{action:"setAttrViewFilters",avID:e.resourceAVID,data:e.hotReloadSetting.filters},{action:"setAttrViewSorts",avID:e.resourceAVID,data:e.hotReloadSetting.sorts}];e.protyle.getInstance().transaction(y)},A=()=>{e.renderEditMethod=2,m.classList.add("select"),p.classList.remove("select");const y=q(e.sourceTable,["fold","updated"]);se(e.nodeID,y,f=>{}),w.OnRedner=!1,t=!0,S()},I=y=>{e.resourceAVID!=""&&(m.classList.remove("select"),p.classList.add("select"),Z(e,y))},E=()=>{W(e,y=>{if(!y){console.log("no av on the block:"+e.resourceID);return}t=!0,e.renderEditMethod=1,I(!1),S()})},C=()=>{const y=e.resourceAVID;W(e,f=>{if(!f){console.log("no av on the block"+e.resourceID);return}e.resourceAVID!=y?I(!1):I(!0),S()})},P=()=>{t=!0,d.classList.remove("select"),e.reFreshOnPageSelect=!e.reFreshOnPageSelect};a.value=e.resourceID,l.value=e.resourceAVViewName,W(e,()=>{S()}),a.addEventListener("input",()=>{e.resourceID=a.value,t=!0}),l.addEventListener("input",()=>{e.resourceAVViewName=l.value,t=!0}),i.addEventListener("click",()=>{e.renderMethod=1,t=!0,S(),b()}),r.addEventListener("click",()=>{e.renderMethod=2,t=!0,S(),b()}),c.addEventListener("click",()=>{e.renderMethod=3,t=!0,S(),b()}),u.addEventListener("click",A),h.addEventListener("click",E),d.addEventListener("click",()=>{e.reFreshOnPageSelect=!e.reFreshOnPageSelect,ee(e.resourceID,y=>{e.resourceAVUpdated=y}),t=!0,b()}),a.innerText=e.resourceID,b()},Z=(e,t=!0,o=null)=>V(void 0,null,function*(){if(w.OnRedner){ne(`${w.Ini.i18n.pleaseWaitOnRendering}`,3e3),w.OnRedner=!1;return}w.OnRedner=!0,(0,k.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID},s=>V(void 0,null,function*(){const n=s.data.view.rowCount,a=()=>{J&&(console.log("niopTable:"),console.log(e));const i=new Ee(e.sourceTable,e);let r="";switch(e.renderMethod){case 1:i.direction={card:1,x:0,y:0},i.makeToCard(e),r=i.RebuildAsCard(e);break;case 2:i.direction={card:0,x:1,y:0},i.makeToCard(e),r=i.Rebuild(e);break;case 3:i.direction={card:0,x:0,y:1},i.makeToCard(e),r=i.Rebuild(e);break;default:ne(`${w.Ini.i18n.mustSelectOneRenderMethod}`,5e3);break}J&&(console.log("\u9884\u5904\u7406\u8868\u683C"),console.log(i),console.log(r)),se(e.nodeID,r,o),e.renderEditMethod=1,w.OnRedner=!1};t=!1;let l=s.data.view.id;if(e.resourceAVViewName!=""&&s.data.view.name!=e.resourceAVViewName&&s.data.views.length>1){for(let i=0;i<s.data.views.length;i++){const r=s.data.views[i];if(r.name===e.resourceAVViewName){t=!0,l=r.id;break}}t||console.log("error view name")}t||n>s.data.view.rows.length?(0,k.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID,viewID:l,pageSize:n},r=>{e.titles=e.deepCopy(r.data.view.columns),e.rows=r.data.view.rows,e.avTable=r,a()}):(e.titles=e.deepCopy(s.data.view.columns),e.rows=s.data.view.rows,e.avTable=s,a())}))}),De=(e,t=!0)=>{ee(e.resourceID,o=>{e.resourceAVUpdated!=o&&(e.resourceAVUpdated=o,Z(e,t,()=>{e.save()}))})},ee=(e,t=null)=>{(0,k.fetchPost)("/api/block/getBlockDOM",{id:e},o=>{const s=document.createElement("div");s.innerHTML=o.data.dom;const n=s.children[0].getAttribute("updated");n&&t&&t(n)})},qe=(e,t=null)=>{fetchPost("/api/av/renderAttributeView",{id:e.resourceAVID},o=>{e.titles=e.deepCopy(o.data.view.columns),e.rows=o.data.view.rows,e.avTable=o,e.setting.filters=Object.assign(o.data.view.filters),e.setting.sorts=Object.assign(o.data.view.sorts),t&&t()})},je=e=>{console.log(e)};class O{constructor(t){this.renderMethod=-1,this.renderEditMethod=2,this.resourceID="",this.resourceAVID="",this.resourceAVUpdated="",this.resourceAVViewName="",this.setting={filters:[],sorts:[]},this.hotReloadSetting={filters:[],sorts:[]},this.titles=[{id:"",name:"",type:"",icon:"",wrap:!1,hidden:!1,pin:!1,width:"68px",numberFormat:"",template:""}],this.sourceTable="",this.colgroup="",this.nodeID="",this.reFreshOnPageSelect=!1;try{const o=JSON.parse(t);o.renderMethod&&(this.renderMethod=o.renderMethod),o.resourceID&&(this.resourceID=o.resourceID),o.resourceAVID&&(this.resourceAVID=o.resourceAVID),o.sourceTable&&(this.sourceTable=this.decode(o.sourceTable)),o.renderEditMethod&&(this.renderEditMethod=o.renderEditMethod),o.hotReloadSetting&&(this.hotReloadSetting=o.hotReloadSetting),o.colgroup&&(this.colgroup=this.decode(o.colgroup)),o.resourceAVViewName&&(this.resourceAVViewName=o.resourceAVViewName),o.resourceAVUpdated&&(this.resourceAVUpdated=o.resourceAVUpdated),o.reFreshOnPageSelect&&(this.reFreshOnPageSelect=o.reFreshOnPageSelect)}catch(o){console.log("Error parsing JSON:",o),this.save(s=>{setTimeout(()=>{},200)})}}clean(){this.protyle=null}getJson(){return JSON.stringify({renderMethod:this.renderMethod,resourceID:this.resourceID,resourceAVID:this.resourceAVID,sourceTable:this.encode(this.sourceTable),renderEditMethod:this.renderEditMethod,hotReloadSetting:this.hotReloadSetting,colgroup:this.encode(this.colgroup),resourceAVViewName:this.resourceAVViewName,resourceAVUpdated:this.resourceAVUpdated,reFreshOnPageSelect:this.reFreshOnPageSelect})}encode(t){const o=encodeURIComponent(t);return window.btoa(o)}decode(t){try{const o=atob(t);return decodeURIComponent(o)}catch(o){return console.error("Error decoding string:",o),""}}deepCopy(t){return JSON.parse(JSON.stringify(t))}setSourceTable(t){const o=/custom-nioptable="[^"]*"/g,s=t.replace(o,"");this.sourceTable=s}save(t=null){if(this.nodeID!=""){const o={[w.ATTRNAME]:this.getJson()};t?B(this.nodeID,o,s=>{t(s)}):B(this.nodeID,o)}}}const Je=()=>{const e=`|{: colspan="4" rowspan="1"}\u6807\u9898|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|
| :-------------------------------: | :--------------------------------: | :--------------------------------: | :--------------------------------: |
|{: colspan="1"}\u5934\u50CF|{: colspan="1"}\u540D\u5B57|{: colspan="1"}\u7B49\u7EA7|\u6280\u80FD|
|..(icon)|..(name)|..(level)|..(skill)|
{: colgroup="width: 94px;|width: 121px;|width: 95px;|width: 116px;" custom-nioptable="123" fold="0" id="20231120114455-g1jmigv" updated="20231130193916"}`,o=e.split(`
`).slice(0,-1).map(n=>n.split(new RegExp("(?<!\\\\)\\|")).map(a=>a.replace(/\\\|/g,"|"))),s=[[{content:"",config:""}]];o.forEach((n,a)=>{s[a]=[],n.forEach((l,i)=>{s[a][i]=te(l)}),s[a]=s[a].slice(1,-1)}),console.log(e),console.log(s)},Ae=/{:\s*(.+?)\s*}/,te=e=>{const t=e.match(Ae);if(t){const o=e.replace(t[0],""),s=Ie(t[1]),n=s.attributes,a=!!(n.colspan&&n.colspan>1||n.rowspan&&n.rowspan>1);return{content:o,config:n,configNo:s.length,resize:a,valueType:"",colspan:n.colspan?parseInt(n.colspan):1,rowspan:n.rowspan?parseInt(n.rowspan):1}}else return{content:e,config:{},configNo:0,resize:!1,valueType:"",colspan:1,rowspan:1}};function Ie(e){const t=/(\S+)=["']([^"']+)["']/g,o=e.match(t);if(!o)return{};const s={};let n=0;return o.forEach(a=>{const[l,i,r]=a.match(/(\S+)=["']([^"']+)["']/);s[i]=r,n++}),{attributes:s,length:n}}class Ee{constructor(t,o){this.cells=[],this.dashRowNum=1,this.colgroup=[],this.rowsStyleStrs=[],this.end="",this.cards=[],this.haveActionValueRegex=/\.\.\((.+?)\)/g,this.checkifHaveActionValue=s=>!!s.content.match(this.haveActionValueRegex),this.direction={card:0,x:0,y:0},this.curCell={card:0,x:0,y:0},this.parseTable(t,o)}parseTable(t,o){const s={};let n=!1;const a=t.split(`
`);this.end=a[a.length-1],a.slice(0,-1).map(i=>i.split(new RegExp("(?<!\\\\)\\|")).map(r=>r.replace(/\\\|/g,"|"))).forEach((i,r)=>{this.cells[r]=[];let c=!1;s[r]||(s[r]=0),i.forEach((u,h)=>{if(this.cells[r][h]=te(u),!n&&this.cells[r][h].rowspan>1){c=!0;for(let d=0;d<this.cells[r][h].rowspan;d++)s[r+d]?s[r+d]+=1:s[r+d]=1}}),!n&&!c&&s[r]===0&&(n=!0,this.dashRowNum<r&&(this.dashRowNum=r)),this.cells[r]=this.cells[r].slice(1,-1)}),this.getRawColgroup(o),this.getMdSettingFromTable()}removeEmpetyInputRows(t){const o=t.avTable.data.view;let s=-1;for(let a=0;a<o.columns.length;a++)if(o.columns[a].type==="block"){s=a;break}const n=[];for(let a=0;a<o.rows.length;a++)o.rows[a].cells[s].value.block.content===""&&n.push(a);for(let a=n.length-1;a>=0;a--)o.rows.splice(n[a],1)}caculateColAndRowGroup(t){this.cells.forEach((o,s)=>{o.forEach((n,a)=>{switch(t.renderMethod){case 1:break;case 2:n.colspan>1&&o.length==a+n.colspan?(n.colspan+=t.rows.length-1,n.config.colspan=n.colspan):o.length==1&&n.colspan==1&&this.dashRowNum!=s&&(this.checkifHaveActionValue(n)||(n.colspan+=t.rows.length-1,n.config.colspan=n.colspan,n.configNo+=1));break;case 3:n.rowspan>1&&this.cells.length==s+n.rowspan+1?(n.rowspan+=t.rows.length,n.config.rowspan=n.rowspan):this.cells.length==2&&n.rowspan==1&&this.dashRowNum!=s&&(this.checkifHaveActionValue(n)||(n.rowspan+=t.rows.length-1,n.config.rowspan=n.rowspan,n.configNo+=1));break;default:break}})})}Rebuild(t){const o=this.cards.map(a=>a.map(l=>"|"+l.map(i=>{let r="";return i.configNo>0&&(r="{: "+Object.entries(i.config).map(([c,u])=>`${c}="${u}"`).join("  ")+"}"),r+i.content}).join("|")).join(`|
`)).join("");this.end=t.renderMethod===2?q(this.end,["fold","id","updated","colgroup"]):q(this.end,["fold","id","updated"]);let s=' id="'+t.nodeID+'" ';t.renderMethod===2&&(s+=' colgroup="'+this.colgroup.map(a=>"width: "+a+";").join("|")+'" ');const n=this.end;return this.end=n.slice(0,2)+s+n.slice(2),`${o}
${this.end}`}RebuildAsCard(t){const o=q(this.end,["fold","id","updated","colgroup"]),s=` id="${t.nodeID}"  data-type="NodeHTMLBlock" `;this.end=o.slice(0,2)+s+o.slice(2);const n=Te(this.cards.length,this.cells.length-1,this.colgroup,this.rowsStyleStrs,t),a=[];return this.cards.forEach((l,i)=>{l.forEach((r,c)=>{if(this.dashRowNum!=c){const u=c>this.dashRowNum?c-1:c;r.forEach((h,d)=>{const m=n.cells[i][u][d];if(m.innerHTML=h.content,h.configNo>0){if(h.colspan>1||h.rowspan>1)for(let p=0;p<h.colspan;p++)for(let g=0;g<h.rowspan;g++)p===0&&g===0||a.push(n.cells[i][u+g][d+p]);if(h.colspan>1){m.setAttribute("colspan",`${h.colspan}`);let p=parseInt(m.style.width);for(let g=1;g<h.colspan;g++)p+=parseInt(n.cells[i][u][d+g].style.width);m.style.width=p+"px"}h.rowspan>1&&m.setAttribute("rowspan",`${h.rowspan}`)}})}}),a.forEach(r=>{r.className="fn__none"})}),`<div>${n.body.innerHTML}</div>
${this.end}`}makeToCard(t){this.cards=[],this.removeEmpetyInputRows(t),this.caculateColAndRowGroup(t);const o=this.cells[0].length,s=this.cells.length,n=t.titles.length,a=t.rows.length,l=this.cards,i={card:0,x:0,y:0},r=this.direction;if(r.card==1?(_e(this.cells),t.rows.forEach((d,m)=>{l[m]=t.deepCopy(this.cells)})):l[0]=t.deepCopy(this.cells),r.x===1){const d=l[0],m=this.colgroup[this.colgroup.length-1];for(let p=0;p<t.rows.length-1;p++)this.colgroup.push(m);for(let p=0;p<s;p++){const g=JSON.parse(JSON.stringify(d[p][o-1]));g.colspan>1&&this.dashRowNum!=p&&(g.content="",g.config.class="fn__none",g.colspan=1,g.config.colspan=1,g.configNo=1);const D=JSON.stringify(g);t.rows.forEach((S,b)=>{b!=0&&d[p].push(JSON.parse(D))})}}if(r.y===1){const d=l[0],m=t.rows.length,p=d[0].length,g=this.dashRowNum===s-1;let D;g?D=JSON.parse(JSON.stringify(Object.assign(d[s-2]))):D=Object.assign(JSON.parse(JSON.stringify(d[s-1]))),D.forEach(b=>{b.rowspan>1&&(b.content="",b.config.class="fn__none",b.rowspan=1,b.config.rowspan=1,b.configNo=1)});const S=JSON.stringify(D);for(let b=1;b<m;b++)g?d.splice(d.length-1,0,JSON.parse(S)):d.push(JSON.parse(S))}const c=[],u=/\.\.\((.*?)\)/;this.cells.forEach((d,m)=>{d.forEach((p,g)=>{p.content.match(u)&&c.push({x:m,y:g})})}),t.titles.forEach((d,m)=>{if(d.name!=""){const p=`..(${d.name})`;c.forEach(g=>{const D=this.cells[g.x][g.y];if(new RegExp(p).test(D.content))for(let b=0;b<a;b++){const R=this.getOffsetCell(g,b),A=t.rows[b].cells[m];let I="[None Data]",E=A.value[A.valueType];switch(A.valueType){case"block":I=A.value.block.content;break;case"number":I=A.value.number.content;break;case"date":I=(E.isNotEmpty?oe(E.content):"")+(E.isNotEmpty2?` -> ${oe(E.content2)}`:"");break;case"phone":I=A.value.phone.content;break;case"mAsset":if(A.value.mAsset&&(t.renderMethod===1?I=`<span class='imgDiv'><img src="${A.value.mAsset[0].content}"></span>`:I=`![image](${A.value.mAsset[0].content})`),A.value.mAsset){const C=A.value.mAsset.length;t.renderMethod===1?C===1?I=`<span class='imgDiv'><img src="${A.value.mAsset[0].content}"></span>`:I=`<span class='AssetContainer'>${A.value.mAsset.map(y=>y.type==="image"?`<span class='imgDiv'><img src='${y.content}' alt='${y.name}'></span>`:`<span class='fileDiv'><a href='${y.content}' title='${y.name}'>${y.name}</a></span>`).join("")}</span>`:C===1?I=A.value.mAsset[0].type==="image"?`![image](${A.value.mAsset[0].content})`:`![file](${A.value.mAsset[0].content})`:I=`${A.value.mAsset.map(y=>y.type==="image"?`![${y.name}](${y.content})`:`[${y.name}](${y.content})`).join("")}`}else I="[No Assets]";break;case"select":E=A.value.mSelect,E&&(I=E.length>0?E[0].content:"None Select");break;case"mSelect":E=A.value.mSelect,E&&(I=E.length>0?E.map(C=>C.content).join(","):"None Select");break;default:E.content&&(I=E.content);break}R.content=R.content.replace(p,I)}})}})}getOffsetCell(t,o){let s=0,n=t.x,a=t.y;return this.direction.card===1&&(s=o),this.direction.y===1&&(n+=o),this.direction.x===1&&(a+=o),this.cards[s][n][a]}getRawColgroup(t){this.colgroup=JSON.parse(t.colgroup)}getMdSettingFromTable(){const t=[];this.cells.forEach((o,s)=>{if(s!=this.dashRowNum){const n=o[0].content,a=/\.\.style\(([^)]*)\)/,l=n.match(a);if(l&&l[1]){const i=l[1];let r=l[1];r.length>1&&r.charAt(r.length-1)!==";"&&(r=r+";"),t.push(r),o[0].content=n.replace(l[0],"")}else t.push("")}}),this.rowsStyleStrs=t}}const W=(e,t=null)=>{(0,k.fetchPost)("/api/block/getBlockKramdown",{id:e.resourceID},o=>{const s=o.data.kramdown,n=/data-av-id="([^"]+)"/,a=s.match(n);if(a)e.resourceAVID!=a[1]&&(e.resourceAVID=a[1]);else{console.log("No av-id"),e.resourceAVID="",t&&t(!1);return}t&&t(!0)})},He=(e,t=null)=>{fetchPost("/api/block/getBlockKramdown",{id:e.resourceID},o=>{const s=o.data.kramdown,n=/data-av-id="([^"]+)"/,a=s.match(n);if(a)e.resourceAVID!=a[1]&&(e.resourceAVID=a[1]);else{console.log("No av-id"),e.resourceAVID="",t&&t(!1);return}t&&t(!0)})},Ue=e=>{};function oe(e){const t=new Date(e),o=t.getFullYear(),s=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getDate().toString().padStart(2,"0");return`${o}-${s}-${n}`}function B(e,t,o=null){const s=JSON.stringify({id:e,attrs:t});(0,k.fetchPost)("/api/attr/setBlockAttrs",{id:e,attrs:t},n=>{o&&o(n)})}function Se(e,t,o=null,s=null){const n={id:e};return(0,k.fetchPost)("/api/attr/getBlockAttrs",n,a=>{a.data[t]?o&&o(a.data[t]):s&&s(a)}),!1}function Ke(e,t){return V(this,null,function*(){const o={id:e};return fetchPost("/api/attr/getBlockAttrs",o,s=>{const n=s.data[t];return n||null}),null})}function We(e,t=null){fetchPost("/api/av/renderAttributeView",{id:e},o=>{t&&t(o)})}function se(e,t,o=null){(0,k.fetchPost)("/api/block/updateBlock",{dataType:"markdown",data:t,id:e},s=>{o&&o(s)})}function ne(e,t,o=null){(0,k.fetchPost)("/api/notification/pushMsg",{msg:e,data:t},s=>{o&&o(s)})}function ae(e,t,o=null){(0,k.fetchPost)("/api/notification/pushErrMsg",{msg:e,data:t},s=>{o&&o(s)})}const re=(e,t=30)=>V(void 0,null,function*(){const o="custom-nioptablewait";let n=0,a=!0;const l=()=>{n++>t&&(a=!1,n=0)};for(B(e,{[o]:"1"},i=>{a=!1});a;)yield new Promise(i=>setTimeout(i,50)),l();for(a=!0,B(e,{[o]:""},i=>{a=!1});a;)yield new Promise(i=>setTimeout(i,50)),l()}),q=(e,t)=>{const o=t.map(a=>`${a}="[^"]*"`).join("|"),s=new RegExp(o,"g");return e.replace(s,"")};function Te(e,t,o,s,n){const a=document.createElement("div"),l=document.createElement("style"),i=Ce();l.textContent=`
.niop-card {
  padding: 5px;
  margin: 5px;
  display: inline-block;
  background-color: ${i.surfaceLight}; 
  border-radius: 5px; 
  opacity: 0.95;
  transition: box-shadow 0.3s ease; 
}
.niop-card:hover {
  box-shadow: 0 0 10px rgba(0, 0, 0, 1.0); 
  background-color: ${i.primarylight}; 
  opacity: 1;
}
.niop-card tr{
  background-color:${i.surface};
  /* height of each line */
  min-height: auto;
}
.niop-card tr.thread{
  background-color:${i.surface};
}
.niop-card img {
  line-height: 0;
  object-fit: contain;
  width: 100%;
  height: 100%;
  vertical-align: middle;
}
.niop-card td {
  border-Color:${i.cellBorderColor};
  border-collapse: collapse;
  text-align: center;
  overflow-wrap: anywhere;
}
.niop-card td:hover {
  box-shadow: 0px 0px 30px ${i.primarylighter};
}
.niop-card span.imgsDiv {
  width: 0;
  height: -webkit-fill-available;
  display: flex;
}
.niop-card span.imgDiv  {
  height: -webkit-fill-available;
  width: -webkit-fill-available;
}
.AssetContainer {
  position: relative;
  height: 100%;
  width: 100%;
  display: block;
  overflow-x: auto;
  white-space: nowrap;
  left: 0px;
  top: 14px;
}
.AssetContainer::-webkit-scrollbar {
height: 5px; 
background-color: transparent; 
}
.AssetContainer::-webkit-scrollbar-track {
background-color: transparent;
}
.AssetContainer::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.098); 
transition: background-color 0.3s ease; 
}
.AssetContainer:hover::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.6); 
height: 20px; 
}
.fn__none {
  display: none !important;
}
`,a.append(l);const r=document.createElement("div");r.className="cardContainer",a.append(r);const c=[];for(let u=0;u<e;u++){const h=document.createElement("div");h.className="niop-card";const d=document.createElement("table");for(let m=0;m<t;m++){const p=document.createElement("tr");if(s[m]!=""){const g=s[m];p.setAttribute("style",g)}m===0&&(p.className="thread");for(let g=0;g<o.length;g++){const D=document.createElement("td");D.style.width=o[g],D.style.height="inherit",c[u]||(c[u]=[]),c[u][m]||(c[u][m]=[]),c[u][m][g]=D,p.appendChild(D)}d.appendChild(p)}h.appendChild(d),r.appendChild(h)}return{body:a,cells:c}}function Ce(){const e=window.getComputedStyle(document.documentElement);return{backgroundColor:e.getPropertyValue("--b3-theme-background"),surface:e.getPropertyValue("--b3-theme-surface"),surfaceLight:e.getPropertyValue("--b3-theme-surface-lighter"),cellBorderColor:e.getPropertyValue("--b3-border-color"),primarylight:e.getPropertyValue("--b3-theme-primary-light"),primarylighter:e.getPropertyValue("--b3-theme-primary-lighter"),primarylightest:e.getPropertyValue("--b3-theme-primary-lightest"),listhover:e.getPropertyValue("--b3-list-hover"),tooltipscolor:e.getPropertyValue("--b3-tooltips-color"),tooltipsbackground:e.getPropertyValue("--b3-tooltips-background")}}function ze(e){const t={backgroundColor:"",surface:"",surfaceLight:"",cellBorderColor:""},o=e.querySelector("thead");if(o){const a=window.getComputedStyle(o);t.surface=a.backgroundColor}const s=e.querySelector("tbody");if(s){const a=window.getComputedStyle(s);t.surfaceLight=a.backgroundColor}const n=e.querySelectorAll("td");if(n.length>0){const a=window.getComputedStyle(n[0]);t.cellBorderColor=a.borderColor}return t}function _e(e){const t=/\[([^\]]*)\]\(([^)]+)\)/g;e.forEach(o=>{o.forEach(s=>{let n;for(;(n=t.exec(s.content))!==null;){const a=n[0],l=n[1],i=n[2],r=s.content[n.index-1]==="!",c=r?`<img style="max-width:px;" src="${i}" alt="${l}">`:`<a href="${i}">${l}</a>`;s.content=s.content.replace(r?"!"+a:a,c)}})})}const Re=e=>{throw new Error("Function not implemented.")};module.exports=j})();
