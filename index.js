/*!
 * MIT License
 *
 * Copyright (c) 2023 SiYuan 思源笔记
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */(()=>{"use strict";var M={};M.d=(e,t)=>{for(var n in t)M.o(t,n)&&!M.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},M.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),M.r=e=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var W={};M.r(W),M.d(W,{NiopTable:()=>H,ReFreshTable:()=>q,default:()=>D});const S=require("siyuan");var P=(e,t,n)=>new Promise((o,s)=>{var a=r=>{try{i(n.next(r))}catch(u){s(u)}},l=r=>{try{i(n.throw(r))}catch(u){s(u)}},i=r=>r.done?o(r.value):Promise.resolve(r.value).then(a,l);i((n=n.apply(e,t)).next())});class fe{constructor(){this.creatCommands=t=>{t.protyleSlash.push({filter:[],html:'<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">'+t.i18n.niopimportTool+'</span><span class="b3-list-item__meta">TABLE</span></div>',id:"niop-getCommand-AVdebugDialog",callback:n=>P(this,null,function*(){console.log(`${t.i18n.DataBaseImportToolDes}`+n.protyle.notebookId);const o=n.protyle.breadcrumb.id;n.insert("<span></span>");const s=new S.Dialog({title:`${t.i18n.DataBaseImportToolDes}`,content:`
                        <div class="b3-dialog__content">
                        <div class="fn__hr"></div>
                        <div>DataBae ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox1">
                        <div class="fn__hr"></div>
                        <div>Table ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox2">
                        <div class="fn__hr"></div>
                        <div style="display:none">RenderMethod:</div>
                        <div class="fn__hr"></div>
                        <div class="renderMethod">
                          <button class="niopRenderSelect" id = "niopButton5" style="display: inline-block;"></button>
                        </div>
                        <div class="fn__hr"></div>
                        <div class="fn__hr"></div>
                        <div style="display:none">json:</div>
                        <div id = "jsonstring" style="display:none"></div>
                        </div>        
                    `,width:"360px",height:"440px",destroyCallback:()=>{t.saveData("niopTID_AVID",a.value),t.saveData("niopTID_TableID",l.value)}}),a=s.element.querySelector("#niopIDBox1"),l=s.element.querySelector("#niopIDBox2"),i=s.element.querySelector("#niopButton5");i.textContent=t.i18n.import,t.loadData("niopTID_AVID").then(r=>{a.value=r}),t.loadData("niopTID_TableID").then(r=>{l.value=r}),i.addEventListener("click",()=>{ye(a.value,l.value,n,t)})})})}}}function me(e,t=null){(0,S.fetchPost)("/api/block/getBlockKramdown",{id:e},n=>{t&&t(n)})}function Ye(e,t=null){fetchPost("/api/block/getBlockDOM",{id:e},n=>{t&&t(n)})}function te(e,t,n=null){(0,S.fetchPost)("/api/av/renderAttributeView",{id:e,pageSize:t},o=>{n&&n(o)})}const ge=(e,t=null)=>{(0,S.fetchPost)("/api/block/getBlockKramdown",{id:e},n=>{const o=n.data.kramdown,s=/data-av-id="([^"]+)"/,a=o.match(s);if(!a){console.log("No av-id"),t&&t({result:!1,value:""});return}t&&t({result:!0,value:a[1]})})};function K(){return globalThis.Lute.NewNodeID()}const Xe=(e,t,n=null)=>{const o=e.id,s=[K()];let a="";e.view.rows.length>0&&(a=e.view.rows[e.view.rows.length-1].id);const l=[{action:"insertAttrViewBlock",avID:o,previousID:a,srcIDs:s,isDetached:!0}];console.log(`ac:${o} \u65B0id:${s} \u524D\u4E00\u7EA7id${a}  do:`),t.protyle.getInstance().transaction(l,[{action:"removeAttrViewBlock",srcIDs:s,avID:o}]),n&&n(1)},Ze=(e,t)=>{const o=e.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),s=e.protyle.notebookId;fetchPost("/api/filetree/getHPathByID",{id:o},a=>{const l=a.data+"/\u65B0\u5EFA\u6587\u68631";fetchPost("/api/filetree/createDocWithMd",{notebook:s,path:l,markdown:"tttt"},i=>{const r=e.protyle;setTimeout(()=>{r.getInstance().transaction([{action:"insertAttrViewBlock",avID:t.id,previousID:t.view.rows[t.view.rows.length-1].id,srcIDs:[i.data],isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:[i.data],avID:t.id}])},500)})})},be=(e,t,n,o,s,a=null)=>{let l=null;s.checkerResult.result&&(l=s.checkerResult.value,(0,S.fetchPost)("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,rowID:n,cellID:o,value:l},i=>{a&&a(i)}))},ne=(e,t,n,o,s,a=null)=>{(0,S.fetchPost)("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,rowID:n,cellID:o,value:s},l=>{a&&a(l)})};function ve(e,t){const n=/\[([^\]]*)\]\((.+?)\.([a-zA-Z0-9]{1,5})\)/,o=[];let s=0,a;for(;(a=n.exec(e))!=null;){s+=1;let l=a[1];l||(l="");const i=a[2],r=`.${a[3]}`,u=e[a.index-1]==="!",c={content:i+r,type:u?"image":"file",name:l};e=e.replace(u?"!"+a[0]:a[0],""),o.push(c)}return s===0?{result:!1}:{result:!0,value:{[t]:o}}}const ye=(e,t,n,o)=>P(void 0,null,function*(){ge(e,s=>{s.result&&te(s.value,2e4,a=>{me(t,l=>P(void 0,null,function*(){if(o.OnImportData){o.OnImportData=!1;return}try{if(l.code=="0"){let i=!1;const r=m=>P(void 0,null,function*(){i||(i=!0,(0,S.fetchPost)("/api/notification/pushMsg",{msg:m,data:30}),yield new Promise(g=>setTimeout(g,300)),i=!1)});o.OnImportData=!0;const u=new Ee(l.data.kramdown);let c=new oe(a.data.view);if(c.duplicatesRow){(0,S.fetchPost)("/api/notification/pushErrMsg",{msg:"database have duplicates name",data:1e3});return}const d=[],p=[],y=[],f=[],b=a.data.view.rows.length;if(u.cells[0].forEach((m,g)=>{c.columnIndexMap[m.content]!=null&&m.content!=""&&g!=0&&d.push({col:g,name:m.content})}),d.length===0)return;for(let m=1;m<u.cells.length;m++){const g={name:u.cells[m][0].content,row:m};if(g.name=="")continue;const C=c.getCellData(g.name);y.push(g),C.result||p.push(g)}const k=!1;let T=!0,w=0;const R=n.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),A=n.protyle.notebookId,h=a.data,v=[],E=[];if(p.length>0&&k){w=p.length;let m=0;console.log("creat new note "+p.length);const g=new Date,C=`import${g.getFullYear()}_${g.getMonth()}_${g.getDay()}_${g.getHours()}_${g.getMinutes()}`;for((0,S.fetchPost)("/api/filetree/getHPathByID",{id:R},I=>P(void 0,null,function*(){(0,S.fetchPost)("/api/filetree/createDocWithMd",{notebook:A,path:I.data+"/"+C,markdown:`import at ${g.getDate()}`},V=>P(void 0,null,function*(){for(const pe of p){m++;const Ge=I.data+"/"+C+"/"+pe.name;for(console.log("creat new note "+pe.name),(0,S.fetchPost)("/api/filetree/createDocWithMd",{notebook:A,path:Ge,markdown:""},ee=>{v.push(ee.data),w--,m--});m>0;)yield new Promise(ee=>setTimeout(ee,10))}}))}));w>0;)yield new Promise(I=>setTimeout(I,200)),r("wait for creat note "+w);r("note creat over "+p.length)}else if(p.length>0)for(const m of p){const g=K();v.push(g),E.push(m.name)}if(yield new Promise(m=>setTimeout(m,250)),v.length>0){v.reverse(),E.reverse();const m=n.protyle,g=h.view.rows.length>0?h.view.rows[h.view.rows.length-1].id:"";m.getInstance().transaction([{action:"insertAttrViewBlock",avID:h.id,previousID:g,srcIDs:v,isDetached:!k}],[{action:"removeAttrViewBlock",srcIDs:v,avID:h.id}]),yield new Promise(V=>setTimeout(V,1500)),T=!0;let C;const I=a.data.view.rowCount+v.length;for(;T;)yield new Promise(V=>setTimeout(V,1200)),te(s.value,I,V=>{T&&V.data.view.rowCount==I&&(C=V,T=!1)}),r("wait for av reload");yield new Promise(V=>setTimeout(V,200)),console.log(C),a=C}c=new oe(a.data.view),k||(c.setEmptyBlockCell(v,E),p.forEach(m=>{const g=c.getCellData(m.name,c.keyColumnName,m.name);g.columnName=m.name,g.keyName=m.name,g.reX=m.row,f.push(g)})),w=d.length*y.length;for(const m of d)for(const g of y){const C=c.getCellData(g.name,m.name,u.cells[g.row][m.col].content);C.result&&(C.reX=g.row,C.reY=m.col,C.content=u.cells[g.row][m.col].content,f.push(C))}yield new Promise(m=>setTimeout(m,200)),w=0;let N=0;for(let m=0;m<f.length;m++){w++,r("UPDATE "+m+" / "+f.length);const g=f[m];for(g.checkerResult.result?(be(s.value,g.value.keyID,g.rowsID,g.value.id,g,()=>{w--}),N++):w--;w>5;)yield new Promise(C=>setTimeout(C,5))}o.OnImportData=!1,(0,S.fetchPost)("/api/notification/pushMsg",{msg:"Import Over with"+N+" data",data:1e3})}}catch{o.OnImportData=!1}}))})})});class oe{constructor(t){this.duplicatesRow=!1,this.lateKeyName="",this.laterowIndex=0,this.data=t,this.preprocessData()}preprocessData(){const t=this.data.columns.find(n=>n.type==="block");this.keyColumnIndex=this.data.columns.indexOf(t),this.keyColumnName=t.name,this.columnIndexMap={},this.rowValueChecker={},this.data.columns.forEach((n,o)=>{this.columnIndexMap[n.name]=o,this.rowValueChecker[o]=we(n)}),this.rowIndexMap={},this.emptyRowIndexMap={},this.data.rows.forEach((n,o)=>{const s=n.cells[this.keyColumnIndex].value.block.content;s&&s!=""?(this.rowIndexMap[s]&&(console.log("block name duplicate "+s),this.duplicatesRow=!0),this.rowIndexMap[s]=o):this.emptyRowIndexMap[n.id]=o})}getCellData(t,n="",o=""){if(t!=this.lateKeyName){if(this.laterowIndex=this.rowIndexMap[t],this.laterowIndex===void 0)return{result:!1,debug:"have no main key"};this.lateKeyName=t}if(n=="")return{result:!0};const s=this.columnIndexMap[n];if(s===void 0)return{result:!1,debug:"have no attr"};const a=this.data.rows[this.laterowIndex],l=a.cells[s],i=this.rowValueChecker[s],r=i(o,l.value,l.valueType);return{result:!0,value:l.value,checkerResult:r,column:this.data.columns[s],rowsID:a.id,keyName:t,columnName:n}}setEmptyBlockCell(t,n){for(let o=0;o<t.length;o++){const s=t[o],a=n[o],l=this.emptyRowIndexMap[s];l>=0?(this.rowIndexMap[a]=l,delete this.emptyRowIndexMap[s]):(console.error(`error with wrong index ${s} ${a} ${o}`),this.error())}}}const we=e=>{const t={};let n=J;switch(e.type){case"text":return j;case"date":return ke;case"number":return Ie;case"relation":return J;case"rollup":return J;case"select":if(!e.options)return(o,s,a)=>({result:!1,faliResult:e.name+" No Any Options"});return e.options.forEach(o=>{t[o.name]=o}),n=(o,s,a)=>{const l=t[o];let i=!1,r="",u="";if(!l)return r="input isnot in select options",{result:i,faliResult:r};const c=s.mSelect;if(c&&o==c[0].content)return r="the same as input",{result:i,faliResult:r};const d={mSelect:[{content:l.name,color:l.color}]};return u=`[${o}] -> [${c}]`,i=!0,{result:i,value:d,successLog:u}},n;break;case"block":return De;case"mSelect":if(!e.options)return(o,s,a)=>({result:!1,faliResult:e.name+" No Any Options"});return e.options.forEach(o=>{t[o.name]=o}),n=(o,s,a)=>{let l=!1,i="",r="",u="",c="";const d=[];let p=o.split(",");p||(p=[o]);const y=s.mSelect;for(let b=0;b<p.length;b++){const k=p[b],T=t[k];if(!T){u+=k+",";continue}let w=!1;if(y){for(let $=0;$<y.length;$++)if(y[$].content==k){w=!0;break}}if(w){c+=k+",";continue}d.push({content:T.name,color:T.color})}if(d.length<1)return i=`unKnow option:(${u}) duplicate option:(${c})`,{result:l,faliResult:i};let f;return y?f={mSelect:[...s.mSelect,...d]}:f={mSelect:d},r=`[${o}] -> [${y}]`,l=!0,{result:l,value:f,successLog:r}},n;break;case"url":return j;case"email":return j;case"phone":return j;case"mAsset":return Se;case"checkbox":return Ae;default:return J}},De=(e,t,n)=>{const o=t.block.content;let s=!1,a="",l="";if(e==o)return a=`the same as input (${o})`,{result:s,faliResult:a};const i={block:{content:e}};return l=`[${e}] -> [${o}]`,s=!0,{result:s,value:i,successLog:l}},j=(e,t,n)=>{const o=t[n].content;let s=!1,a="",l="";if(e==o)return a=`the same as input (${o})`,{result:s,faliResult:a};const i={[n]:{content:e}};return l=`[${e}] -> [${o}]`,s=!0,{result:s,value:i,successLog:l}},Ie=(e,t,n)=>{const o=t.number.content;let s=!1,a="",l="";if(parseFloat(e)==o)return a=`the same as input (${o})`,{result:s,faliResult:a};const i={number:{content:parseFloat(e)}};return l=`[${e}] -> [${o}]`,s=!0,{result:s,value:i,successLog:l}},ke=(e,t,n)=>{const o=t.date,s={content:0,isNotEmpty:!1,content2:0,isNotEmpty2:!1,isNotTime:!1};s.hasEndDate=o.hasEndDate,s.isNotTime=o.isNotTime;let a=!1,l="",i="",r=0;const u=e.split(",");if(u.length>=1){const d=u[0].trim(),p=se(d);p!==0&&(s.content=p,s.isNotEmpty=!0),o.content===s.content&&r++}if(u.length>=2){const d=u[1].trim(),p=se(d);p!==0&&(s.content2=p,s.isNotEmpty2=!0,s.hasEndDate=!0),o.content2===s.content2&&r++}if(r==2)return l=`the same as input (${o})`,{result:a,faliResult:l};const c={date:s};return i=`[${e}] -> [${o}]`,a=!0,{result:a,value:c,successLog:i}};function se(e){const t=Date.parse(e);return isNaN(t)?0:t+new Date().getTimezoneOffset()*60*1e3}const Ae=(e,t,n)=>{const o=t.checkbox.checked;let s=!1,a="",l="";if(e==="")return a=`input is empety (${e})`,{result:s,faliResult:a};const i=e.includes("true");if(i===o)return a=`the same as input (${o})`,{result:s,faliResult:a};const r={checkbox:{checked:i}};return l=`[${e}] -> [${o}]`,s=!0,{result:s,value:r,successLog:l}},J=(e,t,n)=>({result:!1,faliResult:`Unkonw type [${n}] value [${e}]`}),Se=(e,t,n)=>{const o=ve(e,n);let s=!1,a="",l="";if(!o.result)return a=`input isnot asset (${e})`,{result:s,faliResult:a};const i=o.value[n];let r=[],u=[];if(t.mAsset){if(r=i.filter(c=>!t.mAsset.some(p=>p.content===c.content)),r.length===0)return a=`${e} -> already in database `,{result:s,faliResult:a};l+=`asset ${r.length} ${r.map(c=>c.content).join(" ")} -> ${t.mAsset?t.mAsset.length:"none"}`,t.mAsset&&t.mAsset.length>0&&(r=[...t.mAsset,...r]),o.value=r}return u=o.value,s=!0,{result:s,value:u,successLog:l}};class Ee{constructor(t){this.cells=[],this.end="",this.duplicatesRow=!1,this.keyWorlds={},this.kmdCellRegex=/{:\s*(.+?)\s*}/,this.kmdCell=n=>{const o=n.match(this.kmdCellRegex);return o?{content:n.replace(o[0],"")}:{content:n}},this.parseTable(t)}parseTable(t){const n=t.split(`
`);this.end=n[n.length-1],n.slice(0,-1).map(s=>s.split(new RegExp("(?<!\\\\)\\|")).map(a=>a.replace(/\\\|/g,"|"))).forEach((s,a)=>{this.cells[a]=[],s.forEach((l,i)=>{this.cells[a][i]=this.kmdCell(l)}),this.cells[a]=this.cells[a].slice(1,-1),this.cells[a][0].content=this.sanitizeFileName(this.cells[a][0].content),this.keyWorlds[this.cells[a][0].content]?(this.keyWorlds[this.cells[a][0].content]+=1,this.duplicatesRow=!0):this.keyWorlds[this.cells[a][0].content]=1}),this.cells=this.cells.slice(0,1).concat(this.cells.slice(2))}sanitizeFileName(t){const n=/[\/\\\?%\*:|"<>]/g;return t.replace(n,"").replace(/<br\/>/g,"")}}function Qe(e,t,n=null){fetchPost("/api/notification/pushMsg",{msg:e,data:t},o=>{n&&n(o)})}function et(e,t,n=null){fetchPost("/api/notification/pushErrMsg",{msg:e,data:t},o=>{n&&n(o)})}const Te=e=>{const t=e.getAttribute("niopInput");let n,o,s;switch(t){case"text":return O(t,e);case"date":return null;case"number":return Ce(t,e);case"relation":return null;case"rollup":return null;case"select":return Ne(t,e);case"block":return O(t,e);case"mSelect":return null;case"url":return O(t,e);case"email":return O(t,e);case"phone":return O(t,e);case"mAsset":return null;case"checkbox":return $e(t,e);default:return O(t,e)}},O=(e,t)=>{const n=F(t.innerText);return{[e]:{content:n}}},Ce=(e,t)=>{const n=parseFloat(F(t.innerText));return n.toString()!=t.innerText&&(t.innerText=n.toString()),{[e]:{content:n}}},$e=(e,t)=>({checkbox:{checked:t.checked}}),Ne=(e,t)=>{const n=t;return{mSelect:[{content:n.value,color:n.getAttribute("color")}]}},F=e=>e.replace(/\n/g,"<br>"),z=(e,t)=>{const n=Te(t);n!=null?ne(e.resourceAVID,t.getAttribute("keyID"),t.getAttribute("rowID"),t.getAttribute("cellID"),n):console.log(`error with ${t.getAttribute("niotInput")}`),Ve(e,t)},Ve=(e,t)=>{let n=t;for(let o=0;o<3&&(n=n.parentElement,!!n);o++)if(n.tagName==="TD"){n.hasAttribute("reload")&&q(e,!0,!0,!0,400);break}};let x=null;const xe=(e,t)=>{Re();const n=t.target,o=n.getAttribute("niopInput");if(o!==null){t.preventDefault(),t.stopPropagation(),x={element:n,text:n.innerText,change:!1};const s=a=>{(x.change||n===x.element&&n.innerText!=x.text&&o!="mAsset")&&z(e,x.element),n.removeEventListener("blur",s),x=null};n.addEventListener("blur",s),x.blur=s}},Re=()=>{x!=null&&(x.blur(),x=null)},_e=(e,t)=>{const n=t.composedPath&&t.composedPath();for(let o=0;o<n.length&&o<=2;o++)if(n[o].hasAttribute&&n[o].getAttribute("niopInput")=="mAsset"){if(t.preventDefault(),n[o]instanceof HTMLElement){const s=n[o],a=t.clipboardData?t.clipboardData.getData("text"):"";if(a&&a!=""){const l=Be(a);let i="";const r=[];l.forEach(c=>{i+=c.content,r.push({type:c.isImage?"image":"file",content:c.link,name:""})}),s.innerHTML=i;const u={mAsset:r};ne(e.resourceAVID,s.getAttribute("keyID"),s.getAttribute("rowID"),s.getAttribute("cellID"),u,()=>{})}}break}},Me=(e,t)=>{const n=t.target;if(n.getAttribute("niopInput")!==null){z(e,n);return}};function Be(e){const t=/\[([^\]]*)\]\(([^)]+)\)/g,n=[];let o;for(;(o=t.exec(e))!==null;){const s=o[0],a=o[1],l=o[2],i=e[o.index-1]==="!",r=i?`<img src="${l}" alt="${a}">`:`<a href="${l}">${a}</a>`;e=e.replace(i?"!"+s:s,r),n.push({text:a,link:l,content:r,isImage:i})}return n}class Pe{constructor(){this.avTarget={},this.liveNiopTable={},this.liveNiopTableElement={},this.livePage={}}SetNewTable(t,n){this.liveNiopTable[t.nodeID]=t,this.liveNiopTableElement[t.nodeID]=n,t.manager=this}RemoveTable(t){delete this.liveNiopTable[t.nodeID],delete this.liveNiopTableElement[t.nodeID],t.manager=null}ReplaceTableNode(){}ONPageClose(t){}getNiopTable(t,n=null){let o=this.liveNiopTable[t];if(!o&&n){const s=n.getAttribute(D.ATTRNAME);try{s?o=new H(s):o=new H("{}"),o.tableNode=n,o.nodeID=t,o.protyle=D.protyle,this.SetNewTable(o,n)}catch(a){console.log(a)}}return o}getNiopsInSamePageWithSmeAvID(t){const n=this.livePage[t.pageID],o=[];return Object.values(n).forEach(s=>{s.renderEditMethod===1&&s.resourceAVID===t.resourceAVID&&(s.syncTables||s.reFreshOnPageSelect)&&o.push(s)}),o}onSwitchPage(t){const o=t.detail.protyle.element.getAttribute("data-id"),s=this.livePage[o],a={};let l=0;const i=t.detail.protyle.contentElement.querySelectorAll(`[${D.ATTRNAME}]`);return i&&i.forEach(r=>{const u=r.getAttribute("data-node-id"),c=this.getNiopTable(u,r);c.tableContainer=t.detail.protyle.contentElement,c.pageID=o,r!=c.tableNode&&(c.tableNode=r),a[u]=c,l++,s&&s[u]&&delete s[u]}),s&&Object.values(s).forEach(r=>{this.RemoveTable(r)}),l>0&&(this.livePage[o]=a),a}}var B=(e,t,n)=>new Promise((o,s)=>{var a=r=>{try{i(n.next(r))}catch(u){s(u)}},l=r=>{try{i(n.throw(r))}catch(u){s(u)}},i=r=>r.done?o(r.value):Promise.resolve(r.value).then(a,l);i((n=n.apply(e,t)).next())});const ae=!1,G="menu-config",tt="custom_tab",nt="dock_tab",_=class extends S.Plugin{onload(){globalThis.NTP=this,this.eventBus.on("switch-protyle",this.switch_protyle),_.Ini=this,this.manager=new Pe,this.eventBus.on("click-blockicon",this.blockIconEvent.bind(this)),this.protyleSlash=[{filter:["table","data table","database table","niop","\u8868\u683C","\u6570\u636E\u8868\u683C","\u6570\u636E\u5E93\u8868\u683C","shujubiaoge"],html:`<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${this.i18n.dTable}</span><span class="b3-list-item__meta">TABLE</span></div>`,id:"creatniopDateTable",callback(l){return B(this,null,function*(){const i=l.protyle.breadcrumb.id,r=l.protyle.contentElement.querySelector(`[data-node-id="${i}"]`),u=l.protyle.transactionTime;yield(d=>B(this,null,function*(){l.insert("<span></span>"),yield he(i),Y(r,i,l.protyle,200)}))(1)})}}];const e=document.createElement("div");e.innerHTML=`
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u8F85\u52A9\u5DE5\u5177 -->
<select id="niopSelect" >
    <option value="close">${_.Ini.i18n.close}</option>
    <option value="open">${_.Ini.i18n.open}</option>
</select>

<!-- \u9009\u62E9\u6846\u548C\u8F93\u5165\u6846 \u9884\u5B9A\u4E49 CSS -->
<div id="niopContainer" class="fn__none">
    <select id="niopSelect2">
        <option value="option1">\u4F7F\u7528\u5185\u5D4Ccss</option>
        <option value="option2">\u4F7F\u7528\u81EA\u5B9A\u4E49css</option>
    </select>
    <button onclick="console.log('Clicked!')">\u6062\u590D\u9ED8\u8BA4css</button>
    <input type="text" id="niopInput" placeholder="Type something...">
</div>    
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u5FEB\u901F\u5DE5\u5177\u680F \u8F93\u51FA log -->
<select id="niopSelect3" class="fn__none">
    <option value="option1">Option 1</option>
    <option value="option2">Option 2</option>
    <option value="option3">Option 3</option>
</select>
<!-- \u5FEB\u901F\u5DE5\u5177\u680F -->
<div id="niopToolbar" class="fn__none">
    <button onclick="console.log('Clicked!')">Log</button>
</div>
    `;const t=e.querySelector("#niopSelect"),n=e.querySelector("#niopSelect2"),o=e.querySelector("#niopInput"),s=e.querySelector("#niopSelect3"),a=e.querySelector("#niopToolbar");this.setting=new S.Setting({confirmCallback:()=>{this.saveData(G,{useAdvanceTools:t.value})}}),this.setting.addItem({title:`${_.Ini.i18n.useImportToll}`,createActionElement:()=>(this.loadData(G).then(l=>{l.useAdvanceTools&&(t.value=l.useAdvanceTools)}),e)}),console.log("DatabaseTable from niop ~"),this.loadData(G).then(l=>{l.useAdvanceTools&&new fe().creatCommands(this)})}onLayoutReady(){}onunload(){this.eventBus.off("switch-protyle",this.switch_protyle),this.eventBus.off("click-blockicon",this.blockIconEvent.bind(this))}EventMenu(){}blockIconEvent({detail:e}){e.menu.addItem({iconHTML:'<svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg>',label:this.i18n.dTable,click:()=>{const t=e.blockElements[0],n=t.getAttribute("data-node-id");Y(t,n,e.protyle,0)}})}switch_protyle(e){_.protyle=e.detail.protyle;const t=e.detail.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr");if(!t||t===this.protyleTitleElement)return;this.protyleTitleElement=t;let n=t.getAttribute("niopStatu");n||(n="addToolBar",t.setAttribute("niopStatu",n));const o=_.Ini.manager;if(n==="addToolBar"){const a=e.detail.protyle.contentElement;a.addEventListener("click",l=>{if(l.altKey){const i=l.composedPath();for(let r=0;r<i.length;r++){const u=i[r];if(typeof u.getAttribute=="function"&&u.getAttribute(_.ATTRNAME)!==null){const c=u,d=c.getAttribute("data-node-id");_.protyle=e.detail.protyle,Y(c,d,e.detail.protyle,0),l.preventDefault(),l.stopPropagation();break}if(u===a)break}}}),a.addEventListener("niouInputPaste",l=>{console.log(l.event.target)}),t.setAttribute("niopStatu","none")}const s=o.onSwitchPage(e);s&&Object.keys(s).forEach(a=>{const l=s[a];if(!l.tableContainer){l.tableContainer=e.detail.protyle.contentElement;const i=l.tableContainer.parentElement.getAttribute("data-id")}l.renderEditMethod===1&&(l.reFreshOnPageSelect||l.editableCard)&&(l.tableNode.style.pointerEvents="none",l.tableNode.style.opacity="0.5",q(l,!0,!0,!1,0))})}registerTable(e,t){const o=this.manager.getNiopTable(e);if(o){if(o.OnLoad)return;const s=o.tableContainer.querySelector(`[data-node-id="${e}"]`);o.tableNode!=s&&(o.tableNode=s),o.editableCard&&Oe(o,!1)}}};let D=_;D.OnRedner=!1,D.OnImportData=!1,D.ATTRNAME="custom-nioptable",D.protyle=null;const ot=()=>{},st=(e,t=!0)=>!t&&(D.OnRedner||D.OnImportData)||e.renderEditMethod!=1?!1:((e.reFreshOnPageSelect||e.editableCard)&&Fe(e),!0),Oe=(e,t=!1)=>{if(!e.editableCard)return;t&&(e.tableNode=e.tableContainer.querySelector(`[data-node-id="${e.nodeID}"]`));const n=e.tableNode;if(!n.getAttribute("niopStatu")&&(n.setAttribute("niopStatu","none"),n.getAttribute("data-type")==="NodeHTMLBlock")){const o=n.querySelector("protyle-html[data-content]");n.querySelector(".protyle-icons").classList.add("fn__none");const a=o.shadowRoot.querySelector(".cardContainer");a.addEventListener("focus",l=>{xe(e,l)},!0),a.addEventListener("change",l=>{Me(e,l)}),a.addEventListener("paste",l=>{_e(e,l)}),e.displayAddButton&&a.querySelector(".add-button").addEventListener("click",()=>{Le(e,a)})}},Le=(e,t)=>{if(e.OnLoad)return;e.OnLoad=!0,t.style.pointerEvents="none",t.style.opacity="0.5";const n=K(),o=[{action:"insertAttrViewBlock",avID:e.resourceAVID,previousID:"",srcIDs:[n],isDetached:!0}],s=[{action:"removeAttrViewBlock",srcIDs:[n],avID:e.resourceAVID}];(0,S.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID,viewID:e.AVViewID,pageSize:0},()=>{D.protyle.getInstance().transaction(o,s),setTimeout(()=>{e.OnLoad=!1,q(e,!0,!0,!0,0)},800)})},Fe=(e,t=!0)=>{Z(e.resourceID,n=>{e.resourceAVUpdated!=n&&(e.resourceAVUpdated=n,q(e,t,!0,!0,0))})},q=(e,t=!0,n=!1,o=!1,s=500)=>{if(e.OnLoad){e.OnLoad=!1;return}n&&Z(e.resourceID,l=>{e.resourceAVUpdated=l});const a=l=>{l.OnLoad=!0,le(l,t,!0,()=>{l.OnLoad=!1,l.save()})};o&&e.syncTables?D.Ini.manager.getNiopsInSamePageWithSmeAvID(e).forEach(i=>{s>10?setTimeout(()=>{a(i)},s):a(i)}):s>10?setTimeout(()=>{a(e)},s):a(e)},Y=(e,t,n,o=1e3)=>{const s=D.Ini.manager,a=e,l=a.getAttribute("data-type");if(l!="NodeTable"&&l!="NodeHTMLBlock"){ue("DataBaseTable only used on Table",400);return}l==="NodeHTMLBlock"&&!a.getAttribute(D.ATTRNAME)&&ue("error with wrong attribute",400);const i=c=>{if(c.protyle=n,c.tableContainer=n.contentElement,c.tableNode!=a&&(c.tableNode=a),c.renderEditMethod===2||c.renderEditMethod<1){c.renderEditMethod=2;const d=[],p=c.tableNode.querySelector("colgroup");p&&p.querySelectorAll("col").forEach(f=>{const b=f.getBoundingClientRect().width,k=b?`${b}px`:"";d.push(k)}),c.colgroup=JSON.stringify(d),(0,S.fetchPost)("/api/block/getBlockKramdown",{id:c.nodeID},y=>B(void 0,null,function*(){c.renderEditMethod=2,c.setSourceTable(y.data.kramdown),yield he(t),X(c)}))}else X(c)},r=c=>{const d=s.getNiopTable(t,a);o>10?setTimeout(()=>{i(d)},o):i(d)},u=c=>{const d=s.getNiopTable(t,a),p={[D.ATTRNAME]:d.getJson()};o>10?setTimeout(()=>{L(t,p,()=>{i(d)})},o):L(t,p,()=>{i(d)})};He(t,D.ATTRNAME,r,u)},at=e=>{const t=e,n=t.getAttribute("data-node-id"),o=t.getAttribute(D.ATTRNAME);if(!n){console.error("error with data-node-id ");return}const s=t.getElementsByClassName("protyle-attr"),a=document.createElement("div");a.setAttribute("contenteditable","false"),a.classList.add("niop-toolbar-container"),a.addEventListener("mouseenter",()=>{a.classList.remove("hide"),a.classList.add("show")}),a.addEventListener("mouseleave",()=>{a.classList.remove("show"),a.classList.add("hide")}),s[0].appendChild(a);const l=new H(o);l.nodeID=n,l.tableNode=t;const i=document.createElement("button");i.textContent="Toolbar",i.setAttribute("niopButton","showMenu"),i.setAttribute("contenteditable","false"),i.classList.add("niop-button"),a.appendChild(i),i.addEventListener("click",()=>{X(l)});const r=document.createElement("button");r.textContent="Reload",r.setAttribute("niopButton","reload"),r.setAttribute("contenteditable","false"),r.classList.add("niop-button"),a.appendChild(r),r.addEventListener("click",()=>{ze(l)}),l.tableContainer=a},X=e=>{let t=!1;const n=I=>{t&&e.save(V=>{setTimeout(()=>{},200)})},o=new S.Dialog({title:`${D.Ini.i18n.OnEditSomthing_Table} : ${e.nodeID}`,content:`
      <div class="b3-dialog__content">
      <div class="fn__hr"></div>
      <div>${D.Ini.i18n.AVBlockID}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Dababase ID" id = "niopIDBox">
      <div class="fn__hr"></div>
      <div >${D.Ini.i18n.AVViewName}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Views Name" id = "niopIDBox2">
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${D.Ini.i18n.RenderMethodAs}:</div>
      <div class="fn__hr"></div>
      <div class="renderMethod">
        <button class="niopRenderSelect" id = "niopRenderSelectCard" style="display: inline-block;" >${D.Ini.i18n.renderCard}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectRight" style="display: inline-block;">${D.Ini.i18n.renderRight}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectDown" style="display: inline-block;" >${D.Ini.i18n.renderBelow}</button>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${D.Ini.i18n.DisPlayAs}:</div>
      <div class="fn__hr"></div>
      <div class="niopRenderMethodDis">
      <div class="niopRenderSelect" id = "niopRenderAsEditor" aria-label="">${D.Ini.i18n.currentDisPlayMethod_Editor}</div>
      <div class="niopRenderSelect" id = "niopRenderAsDataBase" aria-label="">${D.Ini.i18n.currentDisPlayMethod_DateBase}</div>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${D.Ini.i18n.SwitchRender}:</div>
      <div class="fn__hr"></div>
      <div class="niopLoadMethod">
      <button class="niop-button" id = "niopEditTable" aria-label="">${D.Ini.i18n.currentDisPlayMethod_Editor}</button>
      <span style="width:120px;height:60px;"><span>
      <button class="niop-button" id = "niopReloadAll" aria-label="">${D.Ini.i18n.ReloadAll}</button>
      </div>
      <div class="fn__hr"></div>
      <div>${D.Ini.i18n.tableSetting}</div>
      <div class="fn__hr"></div>
      <button class="niopRenderSelect" id = "reLoadOnTabSelect" aria-label="">${D.Ini.i18n.reLoadOnTabSelect}</button>
      <button class="niopRenderSelect" id = "EditorAble" aria-label="">${D.Ini.i18n.editableCard}</button>
      <button class="niopRenderSelect" id = "ShowAddButton" aria-label="">${D.Ini.i18n.ShowAddButton}</button>
      <button class="niopRenderSelect" id = "ShowEmptyData" aria-label="">${D.Ini.i18n.ShowEmptyData}</button>
      <button class="niopRenderSelect" id = "syncTables" aria-label="">${D.Ini.i18n.syncTables}</button>
      <div class="fn__hr"></div>
      <div style="display:none">Edit</div>
      <div class="fn__hr"></div>

      <button class="niop-button hide" id = "niopSetFiltter" >SetFiltter</button>
      <button class="niop-button hide" id = "niopCleanFiltter" >cleanFiltter</button>
      <div class="fn__hr" style="display:none"></div>
      <div class="fn_none" style="display:none">json:</div>
      <div id = "jsonstring" class="fn_none" style="display:none"></div>
      </div>        
  `,width:"360px",height:"500px",destroyCallback:n}),s=o.element.querySelector("#jsonstring"),a=o.element.querySelector("#niopIDBox"),l=o.element.querySelector("#niopIDBox2"),i=o.element.querySelector("#niopRenderSelectCard"),r=o.element.querySelector("#niopRenderSelectRight"),u=o.element.querySelector("#niopRenderSelectDown"),c=o.element.querySelector("#niopEditTable"),d=o.element.querySelector("#niopReloadAll"),p=o.element.querySelector("#reLoadOnTabSelect"),y=o.element.querySelector("#EditorAble"),f=o.element.querySelector("#ShowAddButton"),b=o.element.querySelector("#ShowEmptyData"),k=o.element.querySelector("#syncTables"),T=o.element.querySelector("#niopRenderAsEditor"),w=o.element.querySelector("#niopRenderAsDataBase"),$=o.element.querySelector("#niopSetFiltter"),R=o.element.querySelector("#niopCleanFiltter"),A=()=>{s.innerText=e.getJson()},h=()=>{i.classList.remove("select"),r.classList.remove("select"),u.classList.remove("select"),T.classList.remove("select"),w.classList.remove("select"),p.classList.remove("select"),y.classList.remove("select"),f.classList.remove("select"),b.classList.remove("select"),k.classList.remove("select"),e.renderMethod===1?i.classList.add("select"):e.renderMethod===2?r.classList.add("select"):e.renderMethod===3&&u.classList.add("select"),e.renderEditMethod===1&&w.classList.add("select"),e.renderEditMethod===2&&T.classList.add("select"),e.reFreshOnPageSelect&&p.classList.add("select"),e.editableCard&&y.classList.add("select"),e.displayAddButton&&f.classList.add("select"),e.displayEmpety&&b.classList.add("select"),e.syncTables&&k.classList.add("select")},v=()=>{const I=[{action:"setAttrViewFilters",avID:e.resourceAVID,data:e.hotReloadSetting.filters},{action:"setAttrViewSorts",avID:e.resourceAVID,data:e.hotReloadSetting.sorts}];e.protyle.getInstance().transaction(I)},E=()=>{e.renderEditMethod=2,T.classList.add("select"),w.classList.remove("select");const I=U(e.sourceTable,["fold","updated"]);ce(e.nodeID,I,V=>{}),D.OnRedner=!1,t=!0,A()},N=I=>{e.resourceAVID!=""&&(T.classList.remove("select"),w.classList.add("select"),le(e,I))},m=()=>{Q(e,I=>{if(!I){console.log("no av on the block:"+e.resourceID);return}t=!0,e.renderEditMethod=1,N(!1),A()})},g=()=>{const I=e.resourceAVID;Q(e,V=>{if(!V){console.log("no av on the block"+e.resourceID);return}e.resourceAVID!=I?N(!1):N(!0),A()})},C=()=>{t=!0,p.classList.remove("select"),e.reFreshOnPageSelect=!e.reFreshOnPageSelect};a.value=e.resourceID,l.value=e.resourceAVViewName,Q(e,()=>{A()}),a.addEventListener("input",()=>{e.resourceID=a.value,t=!0}),l.addEventListener("input",()=>{e.resourceAVViewName=l.value,t=!0}),i.addEventListener("click",()=>{e.renderMethod=1,t=!0,A(),h()}),r.addEventListener("click",()=>{e.renderMethod=2,t=!0,A(),h()}),u.addEventListener("click",()=>{e.renderMethod=3,t=!0,A(),h()}),c.addEventListener("click",E),d.addEventListener("click",m),p.addEventListener("click",()=>{e.reFreshOnPageSelect=!e.reFreshOnPageSelect,Z(e.resourceID,I=>{e.resourceAVUpdated=I}),t=!0,h()}),y.addEventListener("click",()=>{e.editableCard=!e.editableCard,t=!0,h()}),f.addEventListener("click",()=>{e.displayAddButton=!e.displayAddButton,t=!0,h()}),b.addEventListener("click",()=>{e.displayEmpety=!e.displayEmpety,t=!0,h()}),k.addEventListener("click",()=>{e.syncTables=!e.syncTables,t=!0,h()}),a.innerText=e.resourceID,h()},le=(e,t=!0,n=!1,o=null)=>B(void 0,null,function*(){if(!n){if(D.OnRedner){de(`${D.Ini.i18n.pleaseWaitOnRendering}`,3e3),D.OnRedner=!1;return}D.OnRedner=!0}const s={id:e.resourceAVID};(0,S.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID,pageSize:0},a=>B(void 0,null,function*(){const l=a.data.view.rowCount,i=()=>{ae&&(console.log("niopTable:"),console.log(e));const c=new Je(e.sourceTable,e);let d="";switch(e.renderMethod){case 1:c.direction={card:1,x:0,y:0},c.makeToCard(e),d=c.RebuildAsCard(e);break;case 2:c.direction={card:0,x:1,y:0},c.makeToCard(e),d=c.Rebuild(e);break;case 3:c.direction={card:0,x:0,y:1},c.makeToCard(e),d=c.Rebuild(e);break;default:de(`${D.Ini.i18n.mustSelectOneRenderMethod}`,5e3);break}ae&&(console.log("\u9884\u5904\u7406\u8868\u683C"),console.log(c),console.log(d)),d!=""&&(ce(e.nodeID,d,o),e.renderEditMethod=1),D.OnRedner=!1};t=!0;let r=a.data.view.id,u=r===e.resourceAVViewName;if(e.resourceAVViewName!=""&&a.data.view.name!=e.resourceAVViewName&&a.data.views.length>1){for(let c=0;c<a.data.views.length;c++){const d=a.data.views[c];if(d.name===e.resourceAVViewName){u=!0,e.AVViewID=d.id,r=d.id;break}}u||console.log(`${e.nodeID} set error view name : ${e.resourceAVViewName}`)}t===!0&&(0,S.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID,viewID:r,pageSize:Number.MAX_VALUE},d=>{e.titles=d.data.view.columns,e.rows=d.data.view.rows,e.avTable=d,i()})}))}),Z=(e,t=null)=>{(0,S.fetchPost)("/api/block/getBlockDOM",{id:e},n=>{if(n.data.dom||n.data.dom==="")return;const o=document.createElement("div");o.innerHTML=n.data.dom;const s=o.children[0].getAttribute("updated");s&&t&&t(s)})},lt=(e,t=null)=>{fetchPost("/api/av/renderAttributeView",{id:e.resourceAVID},n=>{e.titles=e.deepCopy(n.data.view.columns),e.rows=n.data.view.rows,e.avTable=n,e.setting.filters=Object.assign(n.data.view.filters),e.setting.sorts=Object.assign(n.data.view.sorts),t&&t()})},rt=e=>{console.log(e)};class H{constructor(t){this.renderMethod=-1,this.renderEditMethod=2,this.resourceID="",this.resourceAVID="",this.resourceAVUpdated="",this.resourceAVViewName="",this.AVViewID="",this.setting={filters:[],sorts:[]},this.hotReloadSetting={filters:[],sorts:[]},this.sourceTable="",this.colgroup="",this.nodeID="",this.reFreshOnPageSelect=!1,this.editableCard=!1,this.displayEmpety=!1,this.displayAddButton=!1,this.syncTables=!1,this.OnLoad=!1;try{const n=JSON.parse(t);n.renderMethod&&(this.renderMethod=n.renderMethod),n.resourceID&&(this.resourceID=n.resourceID),n.resourceAVID&&(this.resourceAVID=n.resourceAVID),n.sourceTable&&(this.sourceTable=this.decode(n.sourceTable)),n.renderEditMethod&&(this.renderEditMethod=n.renderEditMethod),n.hotReloadSetting&&(this.hotReloadSetting=n.hotReloadSetting),n.nodeID&&(this.nodeID=n.nodeID),n.colgroup&&(this.colgroup=this.decode(n.colgroup)),n.resourceAVViewName&&(this.resourceAVViewName=n.resourceAVViewName),n.resourceAVUpdated&&(this.resourceAVUpdated=n.resourceAVUpdated),n.reFreshOnPageSelect&&(this.reFreshOnPageSelect=n.reFreshOnPageSelect),n.editableCard&&(this.editableCard=n.editableCard),n.displayEmpety&&(this.displayEmpety=n.displayEmpety),n.displayAddButton&&(this.displayAddButton=n.displayAddButton),n.syncTables&&(this.syncTables=n.syncTables),n.AVViewID&&(this.AVViewID=n.AVViewID)}catch(n){console.log("Error parsing JSON:",n),this.save(o=>{setTimeout(()=>{},200)})}}clean(){this.protyle=null}getJson(){return JSON.stringify({renderMethod:this.renderMethod,resourceID:this.resourceID,resourceAVID:this.resourceAVID,sourceTable:this.encode(this.sourceTable),renderEditMethod:this.renderEditMethod,hotReloadSetting:this.hotReloadSetting,nodeID:this.nodeID,colgroup:this.encode(this.colgroup),resourceAVViewName:this.resourceAVViewName,resourceAVUpdated:this.resourceAVUpdated,reFreshOnPageSelect:this.reFreshOnPageSelect,editableCard:this.editableCard,displayEmpety:this.displayEmpety,displayAddButton:this.displayAddButton,syncTables:this.syncTables,AVViewID:this.AVViewID})}encode(t){const n=encodeURIComponent(t);return window.btoa(n)}decode(t){try{const n=atob(t);return decodeURIComponent(n)}catch(n){return console.error("Error decoding string:",n),""}}deepCopy(t){return JSON.parse(JSON.stringify(t))}setSourceTable(t){const n=/custom-nioptable="[^"]*"/g,o=t.replace(n,"");this.sourceTable=o}save(t=null){if(this.nodeID!=""){const n={[D.ATTRNAME]:this.getJson()};t?L(this.nodeID,n,o=>{t(o)}):L(this.nodeID,n)}}}const it=()=>{const e=`|{: colspan="4" rowspan="1"}\u6807\u9898|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|
| :-------------------------------: | :--------------------------------: | :--------------------------------: | :--------------------------------: |
|{: colspan="1"}\u5934\u50CF|{: colspan="1"}\u540D\u5B57|{: colspan="1"}\u7B49\u7EA7|\u6280\u80FD|
|..(icon)|..(name)|..(level)|..(skill)|
{: colgroup="width: 94px;|width: 121px;|width: 95px;|width: 116px;" custom-nioptable="123" fold="0" id="20231120114455-g1jmigv" updated="20231130193916"}`,n=e.split(`
`).slice(0,-1).map(s=>s.split(new RegExp("(?<!\\\\)\\|")).map(a=>a.replace(/\\\|/g,"|"))),o=[[{content:"",config:""}]];n.forEach((s,a)=>{o[a]=[],s.forEach((l,i)=>{o[a][i]=re(l)}),o[a]=o[a].slice(1,-1)}),console.log(e),console.log(o)},qe=/{:\s*(.+?)\s*}/,re=e=>{const t=e.match(qe);if(t){const n=e.replace(t[0],""),o=je(t[1]),s=o.attributes,a=!!(s.colspan&&s.colspan>1||s.rowspan&&s.rowspan>1);return{content:n,config:s,configNo:o.length,resize:a,valueType:"",colspan:s.colspan?parseInt(s.colspan):1,rowspan:s.rowspan?parseInt(s.rowspan):1}}else return{content:e,config:{},configNo:0,resize:!1,valueType:"",colspan:1,rowspan:1}};function je(e){const t=/(\S+)=["']([^"']+)["']/g,n=e.match(t);if(!n)return{};const o={};let s=0;return n.forEach(a=>{const[l,i,r]=a.match(/(\S+)=["']([^"']+)["']/);o[i]=r,s++}),{attributes:o,length:s}}class Je{constructor(t,n){this.cells=[],this.dashRowNum=1,this.colgroup=[],this.rowsStyleStrs=[],this.cellStyleStrs={},this.cellSetting={},this.end="",this.cards=[],this.haveActionValueRegex=/\.\.\((.+?)\)/g,this.checkifHaveActionValue=o=>!!o.content.match(this.haveActionValueRegex),this.rowStyleRegex=/\.\.style\(([^)]*)\)/,this.cellStyleRegex=/\.\.tdstyle\(([^)]*)\)/,this.cellSettingRegex=/\.\.(\w+)\((.*?)\)/,this.direction={card:0,x:0,y:0},this.curCell={card:0,x:0,y:0},this.parseTable(t,n)}parseTable(t,n){const o={};let s=!1;const a=t.split(`
`);this.end=a[a.length-1],a.slice(0,-1).map(i=>i.split(new RegExp("(?<!\\\\)\\|")).map(r=>r.replace(/\\\|/g,"|"))).forEach((i,r)=>{this.cells[r]=[],o[r]||(o[r]=0),i.forEach((u,c)=>{const d=re(u);this.cells[r][c]=d,!s&&c==1&&d.content&&d.content.startsWith(" ")&&(s=!0,this.dashRowNum<r&&(this.dashRowNum=r))}),this.cells[r]=this.cells[r].slice(1,-1)}),this.getRawColgroup(n),this.getMdSettingFromTable()}removeEmpetyInputRows(t){const n=t.avTable.data.view;let o=-1;for(let a=0;a<n.columns.length;a++)if(n.columns[a].type==="block"){o=a;break}const s=[];for(let a=0;a<n.rows.length;a++)n.rows[a].cells[o].value.block.content===""&&s.push(a);for(let a=s.length-1;a>=0;a--)n.rows.splice(s[a],1)}caculateColAndRowGroup(t){this.cells.forEach((n,o)=>{n.forEach((s,a)=>{switch(t.renderMethod){case 1:break;case 2:s.colspan>1&&n.length==a+s.colspan?(s.colspan+=t.rows.length-1,s.config.colspan=s.colspan):n.length==1&&s.colspan==1&&this.dashRowNum!=o&&(this.checkifHaveActionValue(s)||(s.colspan+=t.rows.length-1,s.config.colspan=s.colspan,s.configNo+=1));break;case 3:s.rowspan>1&&this.cells.length==o+s.rowspan+1?(s.rowspan+=t.rows.length,s.config.rowspan=s.rowspan):this.cells.length==2&&s.rowspan==1&&this.dashRowNum!=o&&(this.checkifHaveActionValue(s)||(s.rowspan+=t.rows.length-1,s.config.rowspan=s.rowspan,s.configNo+=1));break;default:break}})})}Rebuild(t){const n=this.cards.map(a=>a.map(l=>"|"+l.map(i=>{let r="";return i.configNo>0&&(r="{: "+Object.entries(i.config).map(([u,c])=>`${u}="${c}"`).join("  ")+"}"),r+i.content}).join("|")).join(`|
`)).join("");this.end=t.renderMethod===2?U(this.end,["fold","id","updated","colgroup"]):U(this.end,["fold","id","updated"]);let o=' id="'+t.nodeID+'" ';t.renderMethod===2&&(o+=' colgroup="'+this.colgroup.map(a=>"width: "+a+";").join("|")+'" ');const s=this.end;return this.end=s.slice(0,2)+o+s.slice(2),`${n}
${this.end}`}RebuildAsCard(t){const n=U(this.end,["fold","id","updated","colgroup"]),o=` id="${t.nodeID}"  data-type="NodeHTMLBlock" `;this.end=n.slice(0,2)+o+n.slice(2);const s=Ue(this,t),a=[];return this.cards.forEach((l,i)=>{l.forEach((r,u)=>{if(this.dashRowNum!=u){const c=u>this.dashRowNum?u-1:u;r.forEach((d,p)=>{const y=s.cells[i][c][p];if(y.innerHTML=d.content,d.configNo>0){if(d.colspan>1||d.rowspan>1)for(let f=0;f<d.colspan;f++)for(let b=0;b<d.rowspan;b++)f===0&&b===0||a.push(s.cells[i][c+b][p+f]);if(d.colspan>1){y.setAttribute("colspan",`${d.colspan}`);let f=parseInt(y.style.width);for(let b=1;b<d.colspan;b++)f+=parseInt(s.cells[i][c][p+b].style.width);y.style.width=f+"px"}d.rowspan>1&&y.setAttribute("rowspan",`${d.rowspan}`)}})}}),a.forEach(r=>{r.className="fn__none"})}),`<div>${s.body.innerHTML}</div>
${this.end}`}makeToCard(t){this.cards=[],t.displayEmpety||this.removeEmpetyInputRows(t),this.caculateColAndRowGroup(t);const n=this.cells[0].length,o=this.cells.length,s=t.titles.length,a=t.rows.length,l=this.cards,i={card:0,x:0,y:0},r=this.direction;if(r.card==1?(Ke(this.cells),t.rows.forEach((p,y)=>{l[y]=t.deepCopy(this.cells)})):l[0]=t.deepCopy(this.cells),r.x===1){const p=l[0],y=this.colgroup[this.colgroup.length-1];for(let f=0;f<t.rows.length-1;f++)this.colgroup.push(y);for(let f=0;f<o;f++){const b=JSON.parse(JSON.stringify(p[f][n-1]));b.colspan>1&&this.dashRowNum!=f&&(b.content="",b.config.class="fn__none",b.colspan=1,b.config.colspan=1,b.configNo=1);const k=JSON.stringify(b);t.rows.forEach((T,w)=>{w!=0&&p[f].push(JSON.parse(k))})}}if(r.y===1){const p=l[0],y=t.rows.length,f=p[0].length,b=this.dashRowNum===o-1;let k;b?k=JSON.parse(JSON.stringify(Object.assign(p[o-2]))):k=Object.assign(JSON.parse(JSON.stringify(p[o-1]))),k.forEach(w=>{w.rowspan>1&&(w.content="",w.config.class="fn__none",w.rowspan=1,w.config.rowspan=1,w.configNo=1)});const T=JSON.stringify(k);for(let w=1;w<y;w++)b?p.splice(p.length-1,0,JSON.parse(T)):p.push(JSON.parse(T))}const u=[],c=/\.\.\((.*?)\)/;this.cells.forEach((p,y)=>{p.forEach((f,b)=>{f.content.match(c)&&u.push({x:y,y:b})})}),t.titles.forEach((p,y)=>{if(p.name!=""){const f=`..(${p.name})`;u.forEach(b=>{const k=this.cells[b.x][b.y],T=new RegExp(f),w=t.editableCard;if(T.test(k.content))for(let $=0;$<a;$++){const R=this.getOffsetCell(b,$),A=t.rows[$],h=t.rows[$].cells[y];let v="[None]",E=h.value[h.valueType],N,m="";switch(h.valueType){case"block":v=h.value.block.content,v=F(v),v=`<span contenteditable="${w}"  niopInput="block" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">${v}</span>`;break;case"number":v=h.value.number.content,v=`<span contenteditable="${w}" niopInput="number" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">${v}</span>`;break;case"date":v=(E.isNotEmpty?ie(E.content):"")+(E.isNotEmpty2?` -> ${ie(E.content2)}`:"");break;case"phone":v=h.value.phone.content,v=F(v),v=`<span contenteditable="${w}" niopInput="phone" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">${v}</span>`;break;case"mAsset":if(h.value.mAsset){const g=h.value.mAsset.length;t.renderMethod===1?g===1?(v=`<span class='imgDiv'><img src="${h.value.mAsset[0].content}"></span>`,v=`<span contenteditable="${w}" niopInput="mAsset" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">${v}</span>`):v=`<span class='AssetContainer'>${h.value.mAsset.map(I=>I.type==="image"?`<span class='imgDiv'><img src='${I.content}' alt='${I.name}'></span>`:`<span class='fileDiv'><a href='${I.content}' title='${I.name}'>${I.name}</a></span>`).join("")}</span>`:g===1?(v=h.value.mAsset[0].type==="image"?`![image](${h.value.mAsset[0].content})`:`![file](${h.value.mAsset[0].content})`,v=`<span contenteditable="${w}" niopInput="mAsset" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">${v}</span>`):v=`${h.value.mAsset.map(I=>I.type==="image"?`![${I.name}](${I.content})`:`[${I.name}](${I.content})`).join("")}`}else v="[No Assets]",v=`<span contenteditable="${w}" niopInput="mAsset" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">${v}</span>`;break;case"select":if(N=p.options,m=`<select contenteditable="${w}"  ${w?"":"disabled"} niopInput="select" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">`,E=h.value.mSelect,m+=`<option value="" Color="" ${E?"":"selected"}  >[None]</option>`,N.length>0)for(const g of N)m+=`<option value="${g.name}" Color="${g.color}" ${E&&E.length>0&&E[0].content===g.name?"selected":""}>${g.name}</option>`;m+="</select>",v=m;break;case"mSelect":if(N=p.options,m=`<select multiple contenteditable="${w}"  ${w?"":"disabled"} niopInput="mSelect" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">`,E=h.value.mSelect,N.length>0)for(const g of N)m+=`<option value="${g.name}" Color="${g.color}" ${E&&E.some(C=>C.content===g.name)?"selected":""}>${g.name}</option>`;else m+='<option value="" style="background-color: default;">[None]</option>';m+="</select>",v=m;break;case"checkbox":E=h.value.checkbox,v=`<input type="checkbox" ${E.checked?"checked":""} contenteditable="${w}" niopInput="${h.valueType}" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">`;break;default:E.content&&(v=F(E.content),v=`<span contenteditable="${w}" niopInput="${h.valueType}" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}">${v}</span>`),v==="[None]"&&(v=`<span contenteditable="${w}" niopInput="${h.valueType}" keyID="${h.value.keyID}" rowID="${A.id}" cellID="${h.value.id}"> </span>`);break}R.content=R.content.replace(f,v)}})}})}getOffsetCell(t,n){let o=0,s=t.x,a=t.y;return this.direction.card===1&&(o=n),this.direction.y===1&&(s+=n),this.direction.x===1&&(a+=n),this.cards[o][s][a]}getRawColgroup(t){this.colgroup=JSON.parse(t.colgroup)}getAttr(t,n){const o=this.cellSetting[n];if(o){const s=o[t];if(s)return`${t}="${s}"`}return""}getMdSettingFromTable(){const t=[],n={},o={},s=this.cells[0].length;let a=0;this.cells.forEach((l,i)=>{i!=this.dashRowNum&&(l.forEach((r,u)=>{let c=r.content;const d=s*a+u,p=c.match(this.cellStyleRegex);if(p&&p[1]){let f=p[1];f.length>1&&f.charAt(f.length-1)!==";"&&(f=f+";"),n[d]=f,c=c.replace(p[0],"")}if(u==0){const f=c.match(this.rowStyleRegex);if(f&&f[1]){let b=f[1];b.length>1&&b.charAt(b.length-1)!==";"&&(b=b+";"),t.push(b),c=c.replace(f[0],"")}else t.push("")}const y=c.match(this.cellSettingRegex);if(y&&y[1]){const f=y[1];o[d]||(o[d]={}),o[d][f]=y[2]?y[2]:"",c=c.replace(y[0],"")}r.content=c}),a++)}),this.rowsStyleStrs=t,this.cellStyleStrs=n,this.cellSetting=o}}const Q=(e,t=null)=>{(0,S.fetchPost)("/api/block/getBlockKramdown",{id:e.resourceID},n=>{const o=n.data.kramdown,s=/data-av-id="([^"]+)"/,a=o.match(s);if(a)e.resourceAVID!=a[1]&&(e.resourceAVID=a[1]);else{console.log("No av-id"),e.resourceAVID="",t&&t(!1);return}t&&t(!0)})},ct=(e,t=null)=>{fetchPost("/api/block/getBlockKramdown",{id:e.resourceID},n=>{const o=n.data.kramdown,s=/data-av-id="([^"]+)"/,a=o.match(s);if(a)e.resourceAVID!=a[1]&&(e.resourceAVID=a[1]);else{console.log("No av-id"),e.resourceAVID="",t&&t(!1);return}t&&t(!0)})},dt=e=>{};function ie(e){const t=new Date(e),n=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0");return`${n}-${o}-${s}`}function L(e,t,n=null){const o=JSON.stringify({id:e,attrs:t});(0,S.fetchPost)("/api/attr/setBlockAttrs",{id:e,attrs:t},s=>{n&&n(s)})}function He(e,t,n=null,o=null){const s={id:e};return(0,S.fetchPost)("/api/attr/getBlockAttrs",s,a=>{a.data[t]?n&&n(a.data[t]):o&&o(a)}),!1}function ut(e,t){return B(this,null,function*(){const n={id:e};return fetchPost("/api/attr/getBlockAttrs",n,o=>{const s=o.data[t];return s||null}),null})}function ht(e,t=null){fetchPost("/api/av/renderAttributeView",{id:e},n=>{t&&t(n)})}function ce(e,t,n=null){(0,S.fetchPost)("/api/block/updateBlock",{dataType:"markdown",data:t,id:e},o=>{n&&n(o)})}function de(e,t,n=null){(0,S.fetchPost)("/api/notification/pushMsg",{msg:e,data:t},o=>{n&&n(o)})}function ue(e,t,n=null){(0,S.fetchPost)("/api/notification/pushErrMsg",{msg:e,data:t},o=>{n&&n(o)})}const he=(e,t=30)=>B(void 0,null,function*(){const n="custom-nioptablewait";let s=0,a=!0;const l=()=>{s++>t&&(a=!1,s=0)};for(L(e,{[n]:"1"},i=>{a=!1});a;)yield new Promise(i=>setTimeout(i,50)),l();for(a=!0,L(e,{[n]:""},i=>{a=!1});a;)yield new Promise(i=>setTimeout(i,50)),l()}),U=(e,t)=>{const n=t.map(a=>`${a}="[^"]*"`).join("|"),o=new RegExp(n,"g");return e.replace(o,"")};function Ue(e,t){const n=e.cards.length,o=e.cells.length-1,s=e.colgroup,a=e.rowsStyleStrs,l=e.cellStyleStrs,i=e.cellSetting,r=document.createElement("div"),u=document.createElement("style"),c=document.createElement("script"),d=We(),p=s.length;u.textContent=`
.niop-card {
  padding: 5px;
  margin: 5px;
  display: inline-block;
  background-color: ${d.surfaceLight}; 
  border-radius: 5px; 
  opacity: 0.95;
  transition: box-shadow 0.3s ease; 
}
.niop-card:hover {
  box-shadow: 0 0 10px rgba(0, 0, 0, 1.0); 
  background-color: ${d.primarylight}; 
  opacity: 1;
}
.niop-card tr{
  background-color:${d.surface};
  /* height of each line */
  min-height: auto;
}
.niop-card tr.thread{
  background-color:${d.surface};
}
.niop-card img {
  line-height: 0;
  object-fit: contain;
  width: 100%;
  height: 100%;
  vertical-align: middle;
}
.niop-card td {
  border-Color:${d.cellBorderColor};
  border-collapse: collapse;
  text-align: center;
  overflow-wrap: anywhere;
  word-break: break-all;
  text-align: left;
  /*vertical-align: text-top;*/
}
.niop-card td:hover {
  box-shadow: 0px 0px 30px ${d.primarylighter};
}
.niop-card span.imgsDiv {
  width: 0;
  height: -webkit-fill-available;
  display: flex;
}
.niop-card span.imgDiv  {
  height: -webkit-fill-available;
  width: -webkit-fill-available;
}
.AssetContainer {
  position: relative;
  height: 100%;
  width: 100%;
  display: block;
  overflow-x: auto;
  white-space: nowrap;
  left: 0px;
  top: 14px;
}
.AssetContainer::-webkit-scrollbar {
height: 5px; 
background-color: transparent; 
}
.AssetContainer::-webkit-scrollbar-track {
background-color: transparent;
}
.AssetContainer::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.098); 
transition: background-color 0.3s ease; 
}
.AssetContainer:hover::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.6); 
height: 20px; 
}
.niop-card td span[niopinput] {
  width: fit-content;
  padding-right: 3px;
  /*display: inline-block;*/
}
.niop-card td span[niopinput]:empty {
  content:"[None]"
  min-width:20px;
  padding-right: 5px;
  background-color: #; 
  border-radius: 8px;
  display: inline-block;
}
.niop-card td select[niopinput="select"] {
  min-height: 25px;
  max-width: 100%;
  width:fit-content;
}
.add-button{
  background-color: #eeee;
  border: solid 5px;
  border-radius: 8px;
}
.add-button:focus{
  border-color: ${d.primarylighter};
}
.fn__none {
  display: none !important;
}
`,c.textContent=`
setTimeout(() => {
  var mg =globalThis.NTP;
  mg.registerTable("${t.nodeID}","${t.resourceAVID}");
}, 100);
`,r.append(u),r.append(c);const y=document.createElement("div");y.className="cardContainer",r.append(y),y.setAttribute("avID",t.resourceAVID),y.setAttribute("blockID",t.nodeID),y.setAttribute("viewName",t.resourceAVViewName);const f=[];for(let k=0;k<n;k++){const T=document.createElement("div");T.className="niop-card";const w=document.createElement("table");for(let $=0;$<o;$++){const R=document.createElement("tr");if(a[$]!=""){const A=a[$];R.setAttribute("style",A)}$===0&&(R.className="thread");for(let A=0;A<s.length;A++){const h=document.createElement("td"),v=$*p+A;h.setAttribute("cellIndexID",v.toString());const E=l[v];E&&h.setAttribute("style",E);const N=i[v];N&&Object.keys(N).forEach(m=>{h.setAttribute(m,N[m])}),h.style.width=s[A],h.style.maxWidth=s[A],h.style.height="inherit",f[k]||(f[k]=[]),f[k][$]||(f[k][$]=[]),f[k][$][A]=h,R.appendChild(h)}w.appendChild(R)}T.appendChild(w),y.appendChild(T)}const b=document.createElement("span");return t.displayAddButton||b.classList.add("fn__none"),b.innerHTML=`
      <svg class="add-button" width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <path d="M24 4v38M5 24h38" stroke="black" stroke-width="4"/>
      </svg>
  `,y.appendChild(b),{body:r,cells:f}}function We(){const e=window.getComputedStyle(document.documentElement);return{backgroundColor:e.getPropertyValue("--b3-theme-background"),surface:e.getPropertyValue("--b3-theme-surface"),surfaceLight:e.getPropertyValue("--b3-theme-surface-lighter"),cellBorderColor:e.getPropertyValue("--b3-border-color"),primarylight:e.getPropertyValue("--b3-theme-primary-light"),primarylighter:e.getPropertyValue("--b3-theme-primary-lighter"),primarylightest:e.getPropertyValue("--b3-theme-primary-lightest"),listhover:e.getPropertyValue("--b3-list-hover"),tooltipscolor:e.getPropertyValue("--b3-tooltips-color"),tooltipsbackground:e.getPropertyValue("--b3-tooltips-background")}}function pt(e){const t={backgroundColor:"",surface:"",surfaceLight:"",cellBorderColor:""},n=e.querySelector("thead");if(n){const a=window.getComputedStyle(n);t.surface=a.backgroundColor}const o=e.querySelector("tbody");if(o){const a=window.getComputedStyle(o);t.surfaceLight=a.backgroundColor}const s=e.querySelectorAll("td");if(s.length>0){const a=window.getComputedStyle(s[0]);t.cellBorderColor=a.borderColor}return t}function Ke(e){const t=/\[([^\]]*)\]\(([^)]+)\)/g;e.forEach(n=>{n.forEach(o=>{let s;for(;(s=t.exec(o.content))!==null;){const a=s[0],l=s[1],i=s[2],r=o.content[s.index-1]==="!",u=r?`<img" src="${i}" alt="${l}">`:`<a href="${i}">${l}</a>`;o.content=o.content.replace(r?"!"+a:a,u)}})})}const ze=e=>{throw new Error("Function not implemented.")};module.exports=W})();
