/*!
 * MIT License
 *
 * Copyright (c) 2023 SiYuan 思源笔记
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */(()=>{"use strict";var M={};M.d=(e,t)=>{for(var n in t)M.o(t,n)&&!M.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},M.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),M.r=e=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var z={};M.r(z),M.d(z,{NiopTable:()=>U,ReFreshTable:()=>H,default:()=>b});const k=require("siyuan");var P=(e,t,n)=>new Promise((s,o)=>{var l=i=>{try{r(n.next(i))}catch(u){o(u)}},a=i=>{try{r(n.throw(i))}catch(u){o(u)}},r=i=>i.done?s(i.value):Promise.resolve(i.value).then(l,a);r((n=n.apply(e,t)).next())});class ve{constructor(){this.creatCommands=t=>{t.protyleSlash.push({filter:[],html:'<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">'+t.i18n.niopimportTool+'</span><span class="b3-list-item__meta">TABLE</span></div>',id:"niop-getCommand-AVdebugDialog",callback:n=>P(this,null,function*(){console.log(`${t.i18n.DataBaseImportToolDes}`+n.protyle.notebookId);const s=n.protyle.breadcrumb.id;n.insert("<span></span>");const o=new k.Dialog({title:`${t.i18n.DataBaseImportToolDes}`,content:`
                        <div class="b3-dialog__content">
                        <div class="fn__hr"></div>
                        <div>DataBae ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox1">
                        <div class="fn__hr"></div>
                        <div>Table ID:</div>
                        <div class="fn__hr"></div>
                        <input type="text" id = "niopIDBox2">
                        <div class="fn__hr"></div>
                        <div style="display:none">RenderMethod:</div>
                        <div class="fn__hr"></div>
                        <div class="renderMethod">
                          <button class="niopRenderSelect" id = "niopButton5" style="display: inline-block;"></button>
                        </div>
                        <div class="fn__hr"></div>
                        <div class="fn__hr"></div>
                        <div style="display:none">json:</div>
                        <div id = "jsonstring" style="display:none"></div>
                        </div>        
                    `,width:"360px",height:"440px",destroyCallback:()=>{t.saveData("niopTID_AVID",l.value),t.saveData("niopTID_TableID",a.value)}}),l=o.element.querySelector("#niopIDBox1"),a=o.element.querySelector("#niopIDBox2"),r=o.element.querySelector("#niopButton5");r.textContent=t.i18n.import,t.loadData("niopTID_AVID").then(i=>{l.value=i}),t.loadData("niopTID_TableID").then(i=>{a.value=i}),r.addEventListener("click",()=>{ke(l.value,a.value,n,t)})})})}}}function ye(e,t=null){(0,k.fetchPost)("/api/block/getBlockKramdown",{id:e},n=>{t&&t(n)})}function tt(e,t=null){fetchPost("/api/block/getBlockDOM",{id:e},n=>{t&&t(n)})}function oe(e,t,n=null){(0,k.fetchPost)("/api/av/renderAttributeView",{id:e,pageSize:t},s=>{n&&n(s)})}const we=(e,t=null)=>{(0,k.fetchPost)("/api/block/getBlockKramdown",{id:e},n=>{const s=n.data.kramdown,o=/data-av-id="([^"]+)"/,l=s.match(o);if(!l){console.log("No av-id"),t&&t({result:!1,value:""});return}t&&t({result:!0,value:l[1]})})};function G(){return globalThis.Lute.NewNodeID()}const nt=(e,t,n,s=null)=>{const o=e.id,l=[G()];let a="";e.view.rows.length>0&&(a=e.view.rows[e.view.rows.length-1].id),console.log(`ac:${o} \u65B0id:${l} \u524D\u4E00\u7EA7id${a}  do:`),Y(o,l,a,t,!0,s)},st=(e,t)=>{const s=e.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),o=e.protyle.notebookId;fetchPost("/api/filetree/getHPathByID",{id:s},l=>{const a=l.data+"/\u65B0\u5EFA\u6587\u68631";fetchPost("/api/filetree/createDocWithMd",{notebook:o,path:a,markdown:"tttt"},r=>{const i=e.protyle;setTimeout(()=>{i.getInstance().transaction([{action:"insertAttrViewBlock",avID:t.id,previousID:t.view.rows[t.view.rows.length-1].id,srcIDs:[r.data],isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:[r.data],avID:t.id}])},500)})})},Ie=(e,t,n,s,o,l=null)=>{let a=null;o.checkerResult.result&&(a=o.checkerResult.value,(0,k.fetchPost)("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,rowID:n,cellID:s,value:a},r=>{l&&l(r)}))},le=(e,t,n,s,o,l=null)=>{(0,k.fetchPost)("/api/av/setAttributeViewBlockAttr",{avID:e,keyID:t,rowID:n,cellID:s,value:o},a=>{l&&l(a)})},Y=(e,t,n,s,o,l=null)=>{const a=t.map(r=>({id:r,isDetached:!0,content:""}));(0,k.fetchPost)("/api/av/addAttributeViewBlocks",{avID:e,srcs:a,previousID:n,blockID:s,ignoreFillFilter:o},r=>{l&&l(r)})},ot=(e,t,n=null)=>{fetchPost("/api/av/addAttributeViewBlocks",{avID:e,srcIDs:t},s=>{n&&n(s)})};function De(e,t){const n=/\[([^\]]*)\]\((.+?)\.([a-zA-Z0-9]{1,5})\)/,s=[];let o=0,l;for(;(l=n.exec(e))!=null;){o+=1;let a=l[1];a||(a="");const r=l[2],i=`.${l[3]}`,u=e[l.index-1]==="!",c={content:r+i,type:u?"image":"file",name:a};e=e.replace(u?"!"+l[0]:l[0],""),s.push(c)}return o===0?{result:!1}:{result:!0,value:{[t]:s}}}const ke=(e,t,n,s)=>P(void 0,null,function*(){we(e,o=>{o.result&&oe(o.value,2e4,l=>{ye(t,a=>P(void 0,null,function*(){if(s.OnImportData){s.OnImportData=!1;return}try{if(a.code=="0"){let r=!1;const i=g=>P(void 0,null,function*(){r||(r=!0,(0,k.fetchPost)("/api/notification/pushMsg",{msg:g,data:30}),yield new Promise(m=>setTimeout(m,300)),r=!1)});s.OnImportData=!0;const u=new xe(a.data.kramdown);let c=new ae(l.data.view);if(c.duplicatesRow){(0,k.fetchPost)("/api/notification/pushErrMsg",{msg:"database have duplicates name",data:1e3});return}const d=[],p=[],f=[],h=[],v=l.data.view.rows.length;if(u.cells[0].forEach((g,m)=>{c.columnIndexMap[g.content]!=null&&g.content!=""&&m!=0&&d.push({col:m,name:g.content})}),d.length===0)return;for(let g=1;g<u.cells.length;g++){const m={name:u.cells[g][0].content,row:g};if(m.name=="")continue;const T=c.getCellData(m.name);f.push(m),T.result||p.push(m)}const w=!1;let S=!0,y=0;const V=n.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr").getAttribute("data-node-id"),x=n.protyle.notebookId,A=l.data,D=[],E=[];if(p.length>0&&w){y=p.length;let g=0;console.log("creat new note "+p.length);const m=new Date,T=`import${m.getFullYear()}_${m.getMonth()}_${m.getDay()}_${m.getHours()}_${m.getMinutes()}`;for((0,k.fetchPost)("/api/filetree/getHPathByID",{id:V},C=>P(void 0,null,function*(){(0,k.fetchPost)("/api/filetree/createDocWithMd",{notebook:x,path:C.data+"/"+T,markdown:`import at ${m.getDate()}`},$=>P(void 0,null,function*(){for(const q of p){g++;const et=C.data+"/"+T+"/"+q.name;for(console.log("creat new note "+q.name),(0,k.fetchPost)("/api/filetree/createDocWithMd",{notebook:x,path:et,markdown:""},se=>{D.push(se.data),y--,g--});g>0;)yield new Promise(se=>setTimeout(se,10))}}))}));y>0;)yield new Promise(C=>setTimeout(C,200)),i("wait for creat note "+y);i("note creat over "+p.length)}else if(p.length>0)for(const g of p){const m=G();D.push(m),E.push(g.name)}if(yield new Promise(g=>setTimeout(g,250)),D.length>0){D.reverse(),E.reverse();const g=A.view.rows.length>0?A.view.rows[A.view.rows.length-1].id:"";Y(A.id,D,g,e,!0,C=>{console.log(C)}),yield new Promise(C=>setTimeout(C,1500)),S=!0;let m;const T=l.data.view.rowCount+D.length;for(;S;)yield new Promise(C=>setTimeout(C,1200)),oe(o.value,T,C=>{S&&C.data.view.rowCount==T&&(m=C,S=!1)}),i("wait for av reload");yield new Promise(C=>setTimeout(C,200)),console.log(m),l=m}c=new ae(l.data.view),w||(c.setEmptyBlockCell(D,E),p.forEach(g=>{const m=c.getCellData(g.name,c.keyColumnName,g.name);m.columnName=g.name,m.keyName=g.name,m.reX=g.row,h.push(m)})),y=d.length*f.length;for(const g of d)for(const m of f){const T=c.getCellData(m.name,g.name,u.cells[m.row][g.col].content);T.result&&(T.reX=m.row,T.reY=g.col,T.content=u.cells[m.row][g.col].content,h.push(T))}yield new Promise(g=>setTimeout(g,200)),y=0;let N=0;for(let g=0;g<h.length;g++){y++,i("UPDATE "+g+" / "+h.length);const m=h[g];for(m.checkerResult.result?(Ie(o.value,m.value.keyID,m.rowsID,m.value.id,m,()=>{y--}),N++):y--;y>5;)yield new Promise(T=>setTimeout(T,5))}s.OnImportData=!1,(0,k.fetchPost)("/api/notification/pushMsg",{msg:"Import Over with"+N+" data",data:1e3})}}catch{s.OnImportData=!1}}))})})});class ae{constructor(t){this.duplicatesRow=!1,this.lateKeyName="",this.laterowIndex=0,this.data=t,this.preprocessData()}preprocessData(){const t=this.data.columns.find(n=>n.type==="block");this.keyColumnIndex=this.data.columns.indexOf(t),this.keyColumnName=t.name,this.columnIndexMap={},this.rowValueChecker={},this.data.columns.forEach((n,s)=>{this.columnIndexMap[n.name]=s,this.rowValueChecker[s]=Ae(n)}),this.rowIndexMap={},this.emptyRowIndexMap={},this.data.rows.forEach((n,s)=>{const o=n.cells[this.keyColumnIndex].value.block.content;o&&o!=""?(this.rowIndexMap[o]&&(console.log("block name duplicate "+o),this.duplicatesRow=!0),this.rowIndexMap[o]=s):this.emptyRowIndexMap[n.id]=s})}getCellData(t,n="",s=""){if(t!=this.lateKeyName){if(this.laterowIndex=this.rowIndexMap[t],this.laterowIndex===void 0)return{result:!1,debug:"have no main key"};this.lateKeyName=t}if(n=="")return{result:!0};const o=this.columnIndexMap[n];if(o===void 0)return{result:!1,debug:"have no attr"};const l=this.data.rows[this.laterowIndex],a=l.cells[o],r=this.rowValueChecker[o],i=r(s,a.value,a.valueType);return{result:!0,value:a.value,checkerResult:i,column:this.data.columns[o],rowsID:l.id,keyName:t,columnName:n}}setEmptyBlockCell(t,n){for(let s=0;s<t.length;s++){const o=t[s],l=n[s],a=this.emptyRowIndexMap[o];a>=0?(this.rowIndexMap[l]=a,delete this.emptyRowIndexMap[o]):(console.error(`error with wrong index ${o} ${l} ${s}`),this.error())}}}const Ae=e=>{const t={};let n=W;switch(e.type){case"text":return J;case"date":return Te;case"number":return Ee;case"relation":return W;case"rollup":return W;case"select":if(!e.options)return(s,o,l)=>({result:!1,faliResult:e.name+" No Any Options"});return e.options.forEach(s=>{t[s.name]=s}),n=(s,o,l)=>{const a=t[s];let r=!1,i="",u="";if(!a)return i="input isnot in select options",{result:r,faliResult:i};const c=o.mSelect;if(c&&s==c[0].content)return i="the same as input",{result:r,faliResult:i};const d={mSelect:[{content:a.name,color:a.color}]};return u=`[${s}] -> [${c}]`,r=!0,{result:r,value:d,successLog:u}},n;break;case"block":return Se;case"mSelect":if(!e.options)return(s,o,l)=>({result:!1,faliResult:e.name+" No Any Options"});return e.options.forEach(s=>{t[s.name]=s}),n=(s,o,l)=>{let a=!1,r="",i="",u="",c="";const d=[];let p=s.split(",");p||(p=[s]);const f=o.mSelect;for(let v=0;v<p.length;v++){const w=p[v],S=t[w];if(!S){u+=w+",";continue}let y=!1;if(f){for(let I=0;I<f.length;I++)if(f[I].content==w){y=!0;break}}if(y){c+=w+",";continue}d.push({content:S.name,color:S.color})}if(d.length<1)return r=`unKnow option:(${u}) duplicate option:(${c})`,{result:a,faliResult:r};let h;return f?h={mSelect:[...o.mSelect,...d]}:h={mSelect:d},i=`[${s}] -> [${f}]`,a=!0,{result:a,value:h,successLog:i}},n;break;case"url":return J;case"email":return J;case"phone":return J;case"mAsset":return Ce;case"checkbox":return $e;default:return W}},Se=(e,t,n)=>{const s=t.block.content;let o=!1,l="",a="";if(e==s)return l=`the same as input (${s})`,{result:o,faliResult:l};const r={block:{content:e}};return a=`[${e}] -> [${s}]`,o=!0,{result:o,value:r,successLog:a}},J=(e,t,n)=>{const s=t[n].content;let o=!1,l="",a="";if(e==s)return l=`the same as input (${s})`,{result:o,faliResult:l};const r={[n]:{content:e}};return a=`[${e}] -> [${s}]`,o=!0,{result:o,value:r,successLog:a}},Ee=(e,t,n)=>{const s=t.number.content;let o=!1,l="",a="";if(e!="0"&&parseFloat(e)==s)return l=`the same as input (${s})`,{result:o,faliResult:l};const r={number:{content:parseFloat(e),IsNotEmpty:e!==""}};return a=`[${e}] -> [${s}]`,o=!0,{result:o,value:r,successLog:a}},Te=(e,t,n)=>{const s=t.date,o={content:0,isNotEmpty:!1,content2:0,isNotEmpty2:!1,isNotTime:!1};o.hasEndDate=s.hasEndDate,o.isNotTime=s.isNotTime;let l=!1,a="",r="",i=0;const u=e.split(",");if(u.length>=1){const d=u[0].trim(),p=ie(d);p!==0&&(o.content=p,o.isNotEmpty=!0),s.content===o.content&&i++}if(u.length>=2){const d=u[1].trim(),p=ie(d);p!==0&&(o.content2=p,o.isNotEmpty2=!0,o.hasEndDate=!0),s.content2===o.content2&&i++}if(i==2)return a=`the same as input (${s})`,{result:l,faliResult:a};const c={date:o};return r=`[${e}] -> [${s}]`,l=!0,{result:l,value:c,successLog:r}};function ie(e){const t=Date.parse(e);return isNaN(t)?0:t+new Date().getTimezoneOffset()*60*1e3}const $e=(e,t,n)=>{const s=t.checkbox.checked;let o=!1,l="",a="";if(e==="")return l=`input is empety (${e})`,{result:o,faliResult:l};const r=e.includes("true");if(r===s)return l=`the same as input (${s})`,{result:o,faliResult:l};const i={checkbox:{checked:r}};return a=`[${e}] -> [${s}]`,o=!0,{result:o,value:i,successLog:a}},W=(e,t,n)=>({result:!1,faliResult:`Unkonw type [${n}] value [${e}]`}),Ce=(e,t,n)=>{const s=De(e,n);let o=!1,l="",a="";if(!s.result)return l=`input isnot asset (${e})`,{result:o,faliResult:l};const r=s.value[n];let i=[],u=[];if(t.mAsset){if(i=r.filter(c=>!t.mAsset.some(p=>p.content===c.content)),i.length===0)return l=`${e} -> already in database `,{result:o,faliResult:l};a+=`asset ${i.length} ${i.map(c=>c.content).join(" ")} -> ${t.mAsset?t.mAsset.length:"none"}`,t.mAsset&&t.mAsset.length>0&&(i=[...t.mAsset,...i]),s.value=i}return u=s.value,o=!0,{result:o,value:u,successLog:a}};class xe{constructor(t){this.cells=[],this.end="",this.duplicatesRow=!1,this.keyWorlds={},this.kmdCellRegex=/{:\s*(.+?)\s*}/,this.kmdCell=n=>{const s=n.match(this.kmdCellRegex);return s?{content:n.replace(s[0],"")}:{content:n}},this.parseTable(t)}parseTable(t){const n=t.split(`
`);this.end=n[n.length-1],n.slice(0,-1).map(o=>o.split(new RegExp("(?<!\\\\)\\|")).map(l=>l.replace(/\\\|/g,"|"))).forEach((o,l)=>{this.cells[l]=[],o.forEach((a,r)=>{this.cells[l][r]=this.kmdCell(a)}),this.cells[l]=this.cells[l].slice(1,-1),this.cells[l][0].content=this.sanitizeFileName(this.cells[l][0].content),this.keyWorlds[this.cells[l][0].content]?(this.keyWorlds[this.cells[l][0].content]+=1,this.duplicatesRow=!0):this.keyWorlds[this.cells[l][0].content]=1}),this.cells=this.cells.slice(0,1).concat(this.cells.slice(2))}sanitizeFileName(t){const n=/[\/\\\?%\*:|"<>]/g;return t.replace(n,"").replace(/<br\/>/g,"")}}function lt(e,t,n=null){fetchPost("/api/notification/pushMsg",{msg:e,data:t},s=>{n&&n(s)})}function at(e,t,n=null){fetchPost("/api/notification/pushErrMsg",{msg:e,data:t},s=>{n&&n(s)})}const Ne=e=>{const t=e.getAttribute("niopInput");let n,s,o;switch(t){case"text":return O(t,e);case"date":return null;case"number":return Ve(t,e);case"relation":return null;case"rollup":return null;case"select":return Re(t,e);case"block":return O(t,e);case"mSelect":return null;case"url":return O(t,e);case"email":return O(t,e);case"phone":return O(t,e);case"mAsset":return null;case"checkbox":return _e(t,e);default:return O(t,e)}},O=(e,t)=>{let n=L(t.innerText);return{[e]:{content:n}}},Ve=(e,t)=>{const n=parseFloat(L(t.innerText));return n.toString()!=t.innerText&&(t.innerText=n.toString()),{[e]:{content:n}}},_e=(e,t)=>({checkbox:{checked:t.checked}}),Re=(e,t)=>{const n=t;return{mSelect:[{content:n.value,color:n.getAttribute("color")}]}},L=e=>e.replace(/\n/g,"<br>"),X=(e,t)=>{const n=Ne(t);n!=null?le(e.resourceAVID,t.getAttribute("keyID"),t.getAttribute("rowID"),t.getAttribute("cellID"),n):console.log(`error with ${t.getAttribute("niotInput")}`),Me(e,t)},Me=(e,t)=>{let n=t;for(let s=0;s<3&&(n=n.parentElement,!!n);s++)if(n.tagName==="TD"){n.hasAttribute("reload")&&H(e,!0,!0,!0,400);break}};let _=null;const Be=(e,t)=>{Pe();const n=t.target,s=n.getAttribute("niopInput");if(s!==null){t.preventDefault(),t.stopPropagation(),_={element:n,text:n.innerText,change:!1};const o=l=>{(_.change||n===_.element&&n.innerText!=_.text&&s!="mAsset")&&X(e,_.element),n.removeEventListener("blur",o),_=null};n.addEventListener("blur",o),_.blur=o}},Pe=()=>{_!=null&&(_.blur(),_=null)},Oe=(e,t)=>{const n=t.composedPath&&t.composedPath();for(let s=0;s<n.length&&s<=2;s++)if(n[s].hasAttribute&&n[s].getAttribute("niopInput")=="mAsset"){if(t.preventDefault(),n[s]instanceof HTMLElement){const o=n[s],l=t.clipboardData?t.clipboardData.getData("text"):"";if(l&&l!=""){const a=Fe(l);let r="";const i=[];a.forEach(c=>{r+=c.content,i.push({type:c.isImage?"image":"file",content:c.link,name:""})}),o.innerHTML=r;const u={mAsset:i};le(e.resourceAVID,o.getAttribute("keyID"),o.getAttribute("rowID"),o.getAttribute("cellID"),u,()=>{})}}break}},Le=(e,t)=>{const n=t.target;if(n.getAttribute("niopInput")!==null){X(e,n);return}};function Fe(e){const t=/\[([^\]]*)\]\(([^)]+)\)/g,n=[];let s;for(;(s=t.exec(e))!==null;){const o=s[0],l=s[1],a=s[2],r=e[s.index-1]==="!",i=r?`<img src="${a}" alt="${l}">`:`<a href="${a}">${l}</a>`;e=e.replace(r?"!"+o:o,i),n.push({text:l,link:a,content:i,isImage:r})}return n}class qe{constructor(){this.avTarget={},this.liveNiopTable={},this.liveNiopTableElement={},this.livePage={}}SetNewTable(t,n){this.liveNiopTable[t.nodeID]=t,this.liveNiopTableElement[t.nodeID]=n,t.manager=this}RemoveTable(t){delete this.liveNiopTable[t.nodeID],delete this.liveNiopTableElement[t.nodeID],t.manager=null}ReplaceTableNode(){}ONPageClose(t){}getNiopTable(t,n=null){let s=this.liveNiopTable[t];if(!s&&n){const o=n.getAttribute(b.ATTRNAME);try{o?s=new U(o):s=new U("{}"),s.tableNode=n,s.nodeID=t,s.protyle=b.protyle,this.SetNewTable(s,n)}catch(l){console.log(l)}}return s}getNiopsInSamePageWithSmeAvID(t){const n=this.livePage[t.pageID],s=[];return Object.values(n).forEach(o=>{o.renderEditMethod===1&&o.resourceAVID===t.resourceAVID&&(o.syncTables||o.reFreshOnPageSelect)&&s.push(o)}),s}onSwitchPage(t){const s=t.detail.protyle.element.getAttribute("data-id"),o=this.livePage[s],l={};let a=0;const r=t.detail.protyle.contentElement.querySelectorAll(`[${b.ATTRNAME}]`);return r&&r.forEach(i=>{const u=i.getAttribute("data-node-id"),c=this.getNiopTable(u,i);c.tableContainer=t.detail.protyle.contentElement,c.pageID=s,i!=c.tableNode&&(c.tableNode=i),l[u]=c,a++,o&&o[u]&&delete o[u]}),o&&Object.values(o).forEach(i=>{this.RemoveTable(i)}),a>0&&(this.livePage[s]=l),l}}var B=(e,t,n)=>new Promise((s,o)=>{var l=i=>{try{r(n.next(i))}catch(u){o(u)}},a=i=>{try{r(n.throw(i))}catch(u){o(u)}},r=i=>i.done?s(i.value):Promise.resolve(i.value).then(l,a);r((n=n.apply(e,t)).next())});const re=!1,Z="menu-config",it="custom_tab",rt="dock_tab",R=class extends k.Plugin{onload(){globalThis.NTP=this,this.eventBus.on("switch-protyle",this.switch_protyle),R.Ini=this,this.manager=new qe,this.eventBus.on("click-blockicon",this.blockIconEvent.bind(this)),this.protyleSlash=[{filter:["table","data table","database table","niop","\u8868\u683C","\u6570\u636E\u8868\u683C","\u6570\u636E\u5E93\u8868\u683C","shujubiaoge"],html:`<div class="b3-list-item__first"><svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${this.i18n.dTable}</span><span class="b3-list-item__meta">TABLE</span></div>`,id:"creatniopDateTable",callback(a){return B(this,null,function*(){const r=a.protyle.breadcrumb.id,i=a.protyle.contentElement.querySelector(`[data-node-id="${r}"]`),u=a.protyle.transactionTime;yield(d=>B(this,null,function*(){a.insert("<span></span>"),yield me(r),Q(i,r,a.protyle,200)}))(1)})}}];const e=document.createElement("div");e.innerHTML=`
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u8F85\u52A9\u5DE5\u5177 -->
<select id="niopSelect" >
    <option value="close">${R.Ini.i18n.close}</option>
    <option value="open">${R.Ini.i18n.open}</option>
</select>

<!-- \u9009\u62E9\u6846\u548C\u8F93\u5165\u6846 \u9884\u5B9A\u4E49 CSS -->
<div id="niopContainer" class="fn__none">
    <select id="niopSelect2">
        <option value="option1">\u4F7F\u7528\u5185\u5D4Ccss</option>
        <option value="option2">\u4F7F\u7528\u81EA\u5B9A\u4E49css</option>
    </select>
    <button onclick="console.log('Clicked!')">\u6062\u590D\u9ED8\u8BA4css</button>
    <input type="text" id="niopInput" placeholder="Type something...">
</div>    
<!-- \u9009\u62E9\u6846 \u6253\u5F00\u5FEB\u901F\u5DE5\u5177\u680F \u8F93\u51FA log -->
<select id="niopSelect3" class="fn__none">
    <option value="option1">Option 1</option>
    <option value="option2">Option 2</option>
    <option value="option3">Option 3</option>
</select>
<!-- \u5FEB\u901F\u5DE5\u5177\u680F -->
<div id="niopToolbar" class="">
</div>
    `;const t=e.querySelector("#niopSelect"),n=e.querySelector("#niopSelect2"),s=e.querySelector("#niopInput"),o=e.querySelector("#niopSelect3"),l=e.querySelector("#niopToolbar");this.setting=new k.Setting({confirmCallback:()=>{this.saveData(Z,{useAdvanceTools:t.value})}}),this.setting.addItem({title:`${R.Ini.i18n.useImportToll}`,createActionElement:()=>(this.loadData(Z).then(a=>{a.useAdvanceTools&&(t.value=a.useAdvanceTools)}),e)}),console.log("DatabaseTable from niop ~"),this.loadData(Z).then(a=>{a.useAdvanceTools&&new ve().creatCommands(this)})}onLayoutReady(){}onunload(){this.eventBus.off("switch-protyle",this.switch_protyle),this.eventBus.off("click-blockicon",this.blockIconEvent.bind(this))}blockIconEvent({detail:e}){e.menu.addItem({iconHTML:'<svg class="b3-menu__icon " style=""><use xlink:href="#iconTable"></use></svg>',label:this.i18n.dTable,click:()=>{const t=e.blockElements[0],n=t.getAttribute("data-node-id");Q(t,n,e.protyle,0)}})}switch_protyle(e){R.protyle=e.detail.protyle;const t=e.detail.protyle.contentElement.querySelector(".protyle-title.protyle-wysiwyg--attr");if(!t||t===this.protyleTitleElement)return;this.protyleTitleElement=t;let n=t.getAttribute("niopStatu");n||(n="addToolBar",t.setAttribute("niopStatu",n));const s=R.Ini.manager;if(n==="addToolBar"){const l=e.detail.protyle.contentElement;l.addEventListener("click",a=>{if(a.altKey){const r=a.composedPath();for(let i=0;i<r.length;i++){const u=r[i];if(typeof u.getAttribute=="function"&&u.getAttribute(R.ATTRNAME)!==null){const c=u,d=c.getAttribute("data-node-id");R.protyle=e.detail.protyle,Q(c,d,e.detail.protyle,0),a.preventDefault(),a.stopPropagation();break}if(u===l)break}}}),l.addEventListener("niouInputPaste",a=>{console.log(a.event.target)}),t.setAttribute("niopStatu","none")}const o=s.onSwitchPage(e);o&&Object.keys(o).forEach(l=>{const a=o[l];if(!a.tableContainer){a.tableContainer=e.detail.protyle.contentElement;const r=a.tableContainer.parentElement.getAttribute("data-id")}a.renderEditMethod===1&&(a.reFreshOnPageSelect||a.editableCard)&&(a.tableNode.style.pointerEvents="none",a.tableNode.style.opacity="0.5",H(a,!0,!0,!1,0))})}registerTable(e,t){const s=this.manager.getNiopTable(e);if(s){if(s.OnLoad)return;const o=s.tableContainer.querySelector(`[data-node-id="${e}"]`);s.tableNode!=o&&(s.tableNode=o),s.editableCard&&He(s,!1)}}};let b=R;b.OnRedner=!1,b.OnImportData=!1,b.ATTRNAME="custom-nioptable",b.protyle=null;const ct=()=>{},dt=(e,t=!0)=>!t&&(b.OnRedner||b.OnImportData)||e.renderEditMethod!=1?!1:((e.reFreshOnPageSelect||e.editableCard)&&Je(e),!0),He=(e,t=!1)=>{if(!e.editableCard)return;t&&(e.tableNode=e.tableContainer.querySelector(`[data-node-id="${e.nodeID}"]`));const n=e.tableNode;if(!n.getAttribute("niopStatu")&&(n.setAttribute("niopStatu","none"),n.getAttribute("data-type")==="NodeHTMLBlock")){const s=n.querySelector("protyle-html[data-content]");n.querySelector(".protyle-icons").classList.add("fn__none");const l=s.shadowRoot.querySelector(".cardContainer");l.addEventListener("focus",a=>{Be(e,a)},!0),l.addEventListener("change",a=>{Le(e,a)}),l.addEventListener("paste",a=>{Oe(e,a)}),e.displayAddButton&&l.querySelector(".add-button").addEventListener("click",()=>{je(e,l)})}},je=(e,t)=>{if(e.OnLoad)return;e.OnLoad=!0,t.style.pointerEvents="none",t.style.opacity="0.5";const n=e.resourceAVID,s=[G()],o="",l=e.nodeID;Y(n,s,o,l,!0,()=>{e.OnLoad=!1,H(e,!0,!0,!0,0)})},Je=(e,t=!0)=>{te(e.resourceID,n=>{e.resourceAVUpdated!=n&&(e.resourceAVUpdated=n,H(e,t,!0,!0,0))})},H=(e,t=!0,n=!1,s=!1,o=500)=>{if(e.OnLoad){e.OnLoad=!1;return}n&&te(e.resourceID,a=>{e.resourceAVUpdated=a});const l=a=>{a.OnLoad=!0,ce(a,t,!0,()=>{a.OnLoad=!1,a.save()})};s&&e.syncTables?b.Ini.manager.getNiopsInSamePageWithSmeAvID(e).forEach(r=>{o>10?setTimeout(()=>{l(r)},o):l(r)}):o>10?setTimeout(()=>{l(e)},o):l(e)},Q=(e,t,n,s=1e3)=>{const o=b.Ini.manager,l=e,a=l.getAttribute("data-type");if(a!="NodeTable"&&a!="NodeHTMLBlock"){pe("DataBaseTable only used on Table",400);return}a==="NodeHTMLBlock"&&!l.getAttribute(b.ATTRNAME)&&pe("error with wrong attribute",400);const r=c=>{if(c.protyle=n,c.tableContainer=n.contentElement,c.tableNode!=l&&(c.tableNode=l),c.renderEditMethod===2||c.renderEditMethod<1){c.renderEditMethod=2;const d=[],p=c.tableNode.querySelector("colgroup");p&&(c.totalCardWidth=0,p.querySelectorAll("col").forEach(h=>{const v=h.getBoundingClientRect().width,w=v?`${v}px`:"";d.push(w),c.totalCardWidth+=v})),c.colgroup=JSON.stringify(d),(0,k.fetchPost)("/api/block/getBlockKramdown",{id:c.nodeID},f=>B(void 0,null,function*(){c.renderEditMethod=2,c.setSourceTable(f.data.kramdown),yield me(t),ee(c)}))}else ee(c)},i=c=>{const d=o.getNiopTable(t,l);s>10?setTimeout(()=>{r(d)},s):r(d)},u=c=>{const d=o.getNiopTable(t,l),p={[b.ATTRNAME]:d.getJson()};s>10?setTimeout(()=>{F(t,p,()=>{r(d)})},s):F(t,p,()=>{r(d)})};Ge(t,b.ATTRNAME,i,u)},ut=e=>{const t=e,n=t.getAttribute("data-node-id"),s=t.getAttribute(b.ATTRNAME);if(!n){console.error("error with data-node-id ");return}const o=t.getElementsByClassName("protyle-attr"),l=document.createElement("div");l.setAttribute("contenteditable","false"),l.classList.add("niop-toolbar-container"),l.addEventListener("mouseenter",()=>{l.classList.remove("hide"),l.classList.add("show")}),l.addEventListener("mouseleave",()=>{l.classList.remove("show"),l.classList.add("hide")}),o[0].appendChild(l);const a=new U(s);a.nodeID=n,a.tableNode=t;const r=document.createElement("button");r.textContent="Toolbar",r.setAttribute("niopButton","showMenu"),r.setAttribute("contenteditable","false"),r.classList.add("niop-button"),l.appendChild(r),r.addEventListener("click",()=>{ee(a)});const i=document.createElement("button");i.textContent="Reload",i.setAttribute("niopButton","reload"),i.setAttribute("contenteditable","false"),i.classList.add("niop-button"),l.appendChild(i),i.addEventListener("click",()=>{Qe(a)}),a.tableContainer=l},ee=e=>{let t=!1;const n=$=>{t&&e.save(q=>{setTimeout(()=>{},200)})},s=new k.Dialog({title:`${b.Ini.i18n.OnEditSomthing_Table} : ${e.nodeID}`,content:`
      <div class="b3-dialog__content">
      <div class="fn__hr"></div>
      <div>${b.Ini.i18n.AVBlockID}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Dababase ID" id = "niopIDBox">
      <div class="fn__hr"></div>
      <div >${b.Ini.i18n.AVViewName}:</div>
      <div class="fn__hr"></div>
      <input type="text" name="Views Name" id = "niopIDBox2">
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${b.Ini.i18n.RenderMethodAs}:</div>
      <div class="fn__hr"></div>
      <div class="renderMethod">
        <button class="niopRenderSelect" id = "niopRenderSelectCard" style="display: inline-block;" >${b.Ini.i18n.renderCard}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectCustom" style="display: inline-block;" >${b.Ini.i18n.renderAsCustom}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectRight" style="display: inline-block;">${b.Ini.i18n.renderRight}</button>
        <button class="niopRenderSelect" id = "niopRenderSelectDown" style="display: inline-block;" >${b.Ini.i18n.renderBelow}</button>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${b.Ini.i18n.DisPlayAs}:</div>
      <div class="fn__hr"></div>
      <div class="niopRenderMethodDis">
      <div class="niopRenderSelect" id = "niopRenderAsEditor" aria-label="">${b.Ini.i18n.currentDisPlayMethod_Editor}</div>
      <div class="niopRenderSelect" id = "niopRenderAsDataBase" aria-label="">${b.Ini.i18n.currentDisPlayMethod_DateBase}</div>
      </div>
      <div class="fn__hr"></div>
      <div class="fn__hr"></div>
      <div>${b.Ini.i18n.SwitchRender}:</div>
      <div class="fn__hr"></div>
      <div class="niopLoadMethod">
      <button class="niop-button" id = "niopEditTable" aria-label="">${b.Ini.i18n.currentDisPlayMethod_Editor}</button>
      <span style="width:120px;height:60px;"><span>
      <button class="niop-button" id = "niopReloadAll" aria-label="">${b.Ini.i18n.ReloadAll}</button>
      </div>
      <div class="fn__hr"></div>
      <div>${b.Ini.i18n.tableSetting}</div>
      <div class="fn__hr"></div>
      <button class="niopRenderSelect" id = "reLoadOnTabSelect" aria-label="">${b.Ini.i18n.reLoadOnTabSelect}</button>
      <button class="niopRenderSelect" id = "EditorAble" aria-label="">${b.Ini.i18n.editableCard}</button>
      <button class="niopRenderSelect" id = "ShowAddButton" aria-label="">${b.Ini.i18n.ShowAddButton}</button>
      <button class="niopRenderSelect" id = "ShowEmptyData" aria-label="">${b.Ini.i18n.ShowEmptyData}</button>
      <button class="niopRenderSelect" id = "syncTables" aria-label="">${b.Ini.i18n.syncTables}</button>
      <div class="fn__hr"></div>
      <div style="display:none">Edit</div>
      <div class="fn__hr"></div>

      <button class="niop-button hide" id = "niopSetFiltter" >SetFiltter</button>
      <button class="niop-button hide" id = "niopCleanFiltter" >cleanFiltter</button>
      <div class="fn__hr" style="display:none"></div>
      <div class="fn_none" style="display:none">json:</div>
      <div id = "jsonstring" class="fn_none" style="display:none"></div>
      </div>        
  `,width:"360px",height:"500px",destroyCallback:n}),o=s.element.querySelector("#jsonstring"),l=s.element.querySelector("#niopIDBox"),a=s.element.querySelector("#niopIDBox2"),r=s.element.querySelector("#niopRenderSelectCard"),i=s.element.querySelector("#niopRenderSelectRight"),u=s.element.querySelector("#niopRenderSelectDown"),c=s.element.querySelector("#niopRenderSelectCustom"),d=s.element.querySelector("#niopEditTable"),p=s.element.querySelector("#niopReloadAll"),f=s.element.querySelector("#reLoadOnTabSelect"),h=s.element.querySelector("#EditorAble"),v=s.element.querySelector("#ShowAddButton"),w=s.element.querySelector("#ShowEmptyData"),S=s.element.querySelector("#syncTables"),y=s.element.querySelector("#niopRenderAsEditor"),I=s.element.querySelector("#niopRenderAsDataBase"),V=s.element.querySelector("#niopSetFiltter"),x=s.element.querySelector("#niopCleanFiltter"),A=()=>{o.innerText=e.getJson()},D=()=>{r.classList.remove("select"),i.classList.remove("select"),u.classList.remove("select"),c.classList.remove("select"),y.classList.remove("select"),I.classList.remove("select"),f.classList.remove("select"),h.classList.remove("select"),v.classList.remove("select"),w.classList.remove("select"),S.classList.remove("select"),e.renderMethod===1?r.classList.add("select"):e.renderMethod===2?i.classList.add("select"):e.renderMethod===3?u.classList.add("select"):e.renderMethod===4&&c.classList.add("select"),e.renderEditMethod===1&&I.classList.add("select"),e.renderEditMethod===2&&y.classList.add("select"),e.reFreshOnPageSelect&&f.classList.add("select"),e.editableCard&&h.classList.add("select"),e.displayAddButton&&v.classList.add("select"),e.displayEmpety&&w.classList.add("select"),e.syncTables&&S.classList.add("select")},E=()=>{const $=[{action:"setAttrViewFilters",avID:e.resourceAVID,data:e.hotReloadSetting.filters},{action:"setAttrViewSorts",avID:e.resourceAVID,data:e.hotReloadSetting.sorts}];e.protyle.getInstance().transaction($)},N=()=>{e.renderEditMethod=2,y.classList.add("select"),I.classList.remove("select");const $=j(e.sourceTable,["fold","updated"]);ue(e.nodeID,$,q=>{}),b.OnRedner=!1,t=!0,A()},g=$=>{e.resourceAVID!=""&&(y.classList.remove("select"),I.classList.add("select"),ce(e,$))},m=()=>{ne(e,$=>{if(!$){console.log("no av on the block:"+e.resourceID);return}t=!0,e.renderEditMethod=1,g(!1),A()})},T=()=>{const $=e.resourceAVID;ne(e,q=>{if(!q){console.log("no av on the block"+e.resourceID);return}e.resourceAVID!=$?g(!1):g(!0),A()})},C=()=>{t=!0,f.classList.remove("select"),e.reFreshOnPageSelect=!e.reFreshOnPageSelect};l.value=e.resourceID,a.value=e.resourceAVViewName,ne(e,()=>{A()}),l.addEventListener("input",()=>{e.resourceID=l.value,t=!0}),a.addEventListener("input",()=>{e.resourceAVViewName=a.value,t=!0}),r.addEventListener("click",()=>{e.renderMethod=1,t=!0,A(),D()}),i.addEventListener("click",()=>{e.renderMethod=2,t=!0,A(),D()}),u.addEventListener("click",()=>{e.renderMethod=3,t=!0,A(),D()}),c.addEventListener("click",()=>{e.renderMethod=4,t=!0,A(),D(),We(e)}),d.addEventListener("click",N),p.addEventListener("click",m),f.addEventListener("click",()=>{e.reFreshOnPageSelect=!e.reFreshOnPageSelect,te(e.resourceID,$=>{e.resourceAVUpdated=$}),t=!0,D()}),h.addEventListener("click",()=>{e.editableCard=!e.editableCard,t=!0,D()}),v.addEventListener("click",()=>{e.displayAddButton=!e.displayAddButton,t=!0,D()}),w.addEventListener("click",()=>{e.displayEmpety=!e.displayEmpety,t=!0,D()}),S.addEventListener("click",()=>{e.syncTables=!e.syncTables,t=!0,D()}),l.innerText=e.resourceID,D()},We=e=>{let t=!1;const n=b.Ini,s=c=>{t&&e.save(d=>{})},o=new k.Dialog({title:`${b.Ini.i18n.OnEditSomthing_Table} : Html && Css`,content:`
      <div class="b3-dialog__content"  style="display: flex; justify-content: space-between;">
        <div class="column left-column">
        <p>Html:</p>
        <textarea id="leftInput" placeholder="html" style="min-height: 400px;height: 400px;"></textarea>
        <button type="button" id="leftClear" class="clear-button left-clear">${b.Ini.i18n.clear}</button>
        </div>
        <div class="column right-column">
        <p>Css:</p>
        <textarea id="rightInput" placeholder="css" style="min-height: 400px;height: 400px;"></textarea>
        <button type="button" id="rightClear" class="clear-button right-clear" >${b.Ini.i18n.clear}</button>
        </div>
      </div>        
      <button type="button" class="save-button" id="saveButton">${b.Ini.i18n.saveData}</button>
  `,width:"600px",height:"600px",destroyCallback:s}),l=o.element.querySelector("#leftInput"),a=o.element.querySelector("#rightInput"),r=o.element.querySelector("#leftClear"),i=o.element.querySelector("#rightClear"),u=o.element.querySelector("#saveButton");r.addEventListener("click",()=>{l.value="",e.CustomHtml=""}),i.addEventListener("click",()=>{a.value="",e.CustomCss=""}),u.addEventListener("click",()=>{e.CustomHtml=l.value.replace(/^\s*\n/gm,""),e.CustomCss=a.value.replace(/^\s*\n/gm,""),t=!0,o.destroy()}),l.value=e.CustomHtml,a.value=e.CustomCss},ce=(e,t=!0,n=!1,s=null)=>B(void 0,null,function*(){if(!n){if(b.OnRedner){he(`${b.Ini.i18n.pleaseWaitOnRendering}`,3e3),b.OnRedner=!1;return}b.OnRedner=!0}const o={id:e.resourceAVID};(0,k.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID,pageSize:0},l=>B(void 0,null,function*(){const a=l.data.view.rowCount,r=()=>{re&&(console.log("niopTable:"),console.log(e));const c=new ze(e.sourceTable,e);let d="";switch(e.renderMethod){case 1:c.direction={card:1,x:0,y:0},c.makeToCard(e),d=c.RebuildAsCard(e);break;case 2:c.direction={card:0,x:1,y:0},c.makeToCard(e),d=c.Rebuild(e);break;case 3:c.direction={card:0,x:0,y:1},c.makeToCard(e),d=c.Rebuild(e);break;case 4:c.direction={card:0,x:0,y:0},d=c.RebuildAsCustomHtml(e);break;default:he(`${b.Ini.i18n.mustSelectOneRenderMethod}`,5e3);break}re&&(console.log("\u9884\u5904\u7406\u8868\u683C"),console.log(c),console.log(d)),d!=""&&(ue(e.nodeID,d,s),e.renderEditMethod=1),b.OnRedner=!1};t=!0;let i=l.data.view.id,u=i===e.resourceAVViewName;if(e.resourceAVViewName!=""&&l.data.view.name!=e.resourceAVViewName&&l.data.views.length>1){for(let c=0;c<l.data.views.length;c++){const d=l.data.views[c];if(d.name===e.resourceAVViewName){u=!0,e.AVViewID=d.id,i=d.id;break}}u||console.log(`${e.nodeID} set error view name : ${e.resourceAVViewName}`)}t===!0&&(0,k.fetchPost)("/api/av/renderAttributeView",{id:e.resourceAVID,viewID:i,pageSize:Number.MAX_VALUE},d=>{e.titles=d.data.view.columns,e.rows=d.data.view.rows,e.avTable=d,r()})}))}),te=(e,t=null)=>{(0,k.fetchPost)("/api/block/getBlockDOM",{id:e},n=>{if(n.data.dom||n.data.dom==="")return;const s=document.createElement("div");s.innerHTML=n.data.dom;const o=s.children[0].getAttribute("updated");o&&t&&t(o)})},ht=(e,t=null)=>{fetchPost("/api/av/renderAttributeView",{id:e.resourceAVID},n=>{e.titles=e.deepCopy(n.data.view.columns),e.rows=n.data.view.rows,e.avTable=n,e.setting.filters=Object.assign(n.data.view.filters),e.setting.sorts=Object.assign(n.data.view.sorts),t&&t()})},pt=e=>{console.log(e)};class U{constructor(t){this.renderMethod=-1,this.renderEditMethod=2,this.resourceID="",this.resourceAVID="",this.resourceAVUpdated="",this.resourceAVViewName="",this.AVViewID="",this.setting={filters:[],sorts:[]},this.hotReloadSetting={filters:[],sorts:[]},this.sourceTable="",this.colgroup="",this.totalCardWidth=200,this.nodeID="",this.reFreshOnPageSelect=!1,this.editableCard=!1,this.displayEmpety=!1,this.displayAddButton=!1,this.syncTables=!1,this.CustomCss="",this.CustomHtml="",this.CustomJs="",this.OnLoad=!1;try{const n=JSON.parse(t);n.renderMethod&&(this.renderMethod=n.renderMethod),n.resourceID&&(this.resourceID=n.resourceID),n.resourceAVID&&(this.resourceAVID=n.resourceAVID),n.sourceTable&&(this.sourceTable=this.decode(n.sourceTable)),n.renderEditMethod&&(this.renderEditMethod=n.renderEditMethod),n.hotReloadSetting&&(this.hotReloadSetting=n.hotReloadSetting),n.nodeID&&(this.nodeID=n.nodeID),n.colgroup&&(this.colgroup=this.decode(n.colgroup)),n.resourceAVViewName&&(this.resourceAVViewName=n.resourceAVViewName),n.resourceAVUpdated&&(this.resourceAVUpdated=n.resourceAVUpdated),n.reFreshOnPageSelect&&(this.reFreshOnPageSelect=n.reFreshOnPageSelect),n.editableCard&&(this.editableCard=n.editableCard),n.displayEmpety&&(this.displayEmpety=n.displayEmpety),n.displayAddButton&&(this.displayAddButton=n.displayAddButton),n.syncTables&&(this.syncTables=n.syncTables),n.AVViewID&&(this.AVViewID=n.AVViewID),n.CustomCss&&(this.CustomCss=n.CustomCss),n.CustomHtml&&(this.CustomHtml=n.CustomHtml),n.CustomJs&&(this.CustomJs=n.CustomJs),n.totalCardWidth&&(this.totalCardWidth=n.totalCardWidth)}catch(n){console.log("Error parsing JSON:",n),this.save(s=>{setTimeout(()=>{},200)})}}clean(){this.protyle=null}getJson(){return JSON.stringify({renderMethod:this.renderMethod,resourceID:this.resourceID,resourceAVID:this.resourceAVID,sourceTable:this.encode(this.sourceTable),renderEditMethod:this.renderEditMethod,hotReloadSetting:this.hotReloadSetting,nodeID:this.nodeID,colgroup:this.encode(this.colgroup),resourceAVViewName:this.resourceAVViewName,resourceAVUpdated:this.resourceAVUpdated,reFreshOnPageSelect:this.reFreshOnPageSelect,editableCard:this.editableCard,displayEmpety:this.displayEmpety,displayAddButton:this.displayAddButton,syncTables:this.syncTables,AVViewID:this.AVViewID,CustomCss:this.CustomCss,CustomHtml:this.CustomHtml,CustomJs:this.CustomJs,totalCardWidth:this.totalCardWidth})}encode(t){const n=encodeURIComponent(t);return window.btoa(n)}decode(t){try{const n=atob(t);return decodeURIComponent(n)}catch(n){return console.error("Error decoding string:",n),""}}deepCopy(t){return JSON.parse(JSON.stringify(t))}setSourceTable(t){const n=/custom-nioptable="[^"]*"/g,s=t.replace(n,"");this.sourceTable=s}save(t=null){if(this.nodeID!=""){const n={[b.ATTRNAME]:this.getJson()};t?F(this.nodeID,n,s=>{t(s)}):F(this.nodeID,n)}}}const mt=()=>{const e=`|{: colspan="4" rowspan="1"}\u6807\u9898|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|{: colspan="1" class="fn__none"}|
| :-------------------------------: | :--------------------------------: | :--------------------------------: | :--------------------------------: |
|{: colspan="1"}\u5934\u50CF|{: colspan="1"}\u540D\u5B57|{: colspan="1"}\u7B49\u7EA7|\u6280\u80FD|
|..(icon)|..(name)|..(level)|..(skill)|
{: colgroup="width: 94px;|width: 121px;|width: 95px;|width: 116px;" custom-nioptable="123" fold="0" id="20231120114455-g1jmigv" updated="20231130193916"}`,n=e.split(`
`).slice(0,-1).map(o=>o.split(new RegExp("(?<!\\\\)\\|")).map(l=>l.replace(/\\\|/g,"|"))),s=[[{content:"",config:""}]];n.forEach((o,l)=>{s[l]=[],o.forEach((a,r)=>{s[l][r]=de(a)}),s[l]=s[l].slice(1,-1)}),console.log(e),console.log(s)},Ue=/{:\s*(.+?)\s*}/,de=e=>{const t=e.match(Ue);if(t){const n=e.replace(t[0],""),s=Ke(t[1]),o=s.attributes,l=!!(o.colspan&&o.colspan>1||o.rowspan&&o.rowspan>1);return{content:n,config:o,configNo:s.length,resize:l,valueType:"",colspan:o.colspan?parseInt(o.colspan):1,rowspan:o.rowspan?parseInt(o.rowspan):1}}else return{content:e,config:{},configNo:0,resize:!1,valueType:"",colspan:1,rowspan:1}};function Ke(e){const t=/(\S+)=["']([^"']+)["']/g,n=e.match(t);if(!n)return{};const s={};let o=0;return n.forEach(l=>{const[a,r,i]=l.match(/(\S+)=["']([^"']+)["']/);s[r]=i,o++}),{attributes:s,length:o}}class ze{constructor(t,n){this.cells=[],this.dashRowNum=1,this.colgroup=[],this.rowsStyleStrs=[],this.cellStyleStrs={},this.cellSetting={},this.end="",this.cards=[],this.haveActionValueRegex=/\.\.\((.+?)\)/g,this.checkifHaveActionValue=s=>!!s.content.match(this.haveActionValueRegex),this.rowStyleRegex=/\.\.style\(([^)]*)\)/,this.cellStyleRegex=/\.\.tdstyle\(([^)]*)\)/,this.cellSettingRegex=/\.\.(\w+)\((.*?)\)/,this.direction={card:0,x:0,y:0},this.curCell={card:0,x:0,y:0},this.parseTable(t,n)}parseTable(t,n){const s=t.split(`
`);if(this.end=s[s.length-1],n.renderMethod==4)return;const o={};let l=!1;s.slice(0,-1).map(r=>r.split(new RegExp("(?<!\\\\)\\|")).map(i=>i.replace(/\\\|/g,"|"))).forEach((r,i)=>{this.cells[i]=[],o[i]||(o[i]=0),r.forEach((u,c)=>{const d=de(u);this.cells[i][c]=d,!l&&c==1&&d.content&&d.content.startsWith(" ")&&(l=!0,this.dashRowNum<i&&(this.dashRowNum=i))}),this.cells[i]=this.cells[i].slice(1,-1)}),this.getRawColgroup(n),this.getMdSettingFromTable()}removeEmpetyInputRows(t){const n=t.avTable.data.view;let s=-1;for(let l=0;l<n.columns.length;l++)if(n.columns[l].type==="block"){s=l;break}const o=[];for(let l=0;l<n.rows.length;l++)n.rows[l].cells[s].value.block.content===""&&o.push(l);for(let l=o.length-1;l>=0;l--)n.rows.splice(o[l],1)}caculateColAndRowGroup(t){this.cells.forEach((n,s)=>{n.forEach((o,l)=>{switch(t.renderMethod){case 1:break;case 2:o.colspan>1&&n.length==l+o.colspan?(o.colspan+=t.rows.length-1,o.config.colspan=o.colspan):n.length==1&&o.colspan==1&&this.dashRowNum!=s&&(this.checkifHaveActionValue(o)||(o.colspan+=t.rows.length-1,o.config.colspan=o.colspan,o.configNo+=1));break;case 3:o.rowspan>1&&this.cells.length==s+o.rowspan+1?(o.rowspan+=t.rows.length,o.config.rowspan=o.rowspan):this.cells.length==2&&o.rowspan==1&&this.dashRowNum!=s&&(this.checkifHaveActionValue(o)||(o.rowspan+=t.rows.length-1,o.config.rowspan=o.rowspan,o.configNo+=1));break;default:break}})})}Rebuild(t){const n=this.cards.map(l=>l.map(a=>"|"+a.map(r=>{let i="";return r.configNo>0&&(i="{: "+Object.entries(r.config).map(([u,c])=>`${u}="${c}"`).join("  ")+"}"),i+r.content}).join("|")).join(`|
`)).join("");this.end=t.renderMethod===2?j(this.end,["fold","id","updated","colgroup"]):j(this.end,["fold","id","updated"]);let s=' id="'+t.nodeID+'" ';t.renderMethod===2&&(s+=' colgroup="'+this.colgroup.map(l=>"width: "+l+";").join("|")+'" ');const o=this.end;return this.end=o.slice(0,2)+s+o.slice(2),`${n}
${this.end}`}RebuildAsCard(t){const n=j(this.end,["fold","id","updated","colgroup"]),s=` id="${t.nodeID}"  data-type="NodeHTMLBlock" `;this.end=n.slice(0,2)+s+n.slice(2);const o=Ye(this,t),l=[];return this.cards.forEach((a,r)=>{a.forEach((i,u)=>{if(this.dashRowNum!=u){const c=u>this.dashRowNum?u-1:u;i.forEach((d,p)=>{const f=o.cells[r][c][p];if(f.innerHTML=`<div class="niop-cell-content">${d.content}</div>`,d.configNo>0){if(d.colspan>1||d.rowspan>1)for(let h=0;h<d.colspan;h++)for(let v=0;v<d.rowspan;v++)h===0&&v===0||l.push(o.cells[r][c+v][p+h]);if(d.colspan>1){f.setAttribute("colspan",`${d.colspan}`);let h=parseInt(f.style.width);for(let v=1;v<d.colspan;v++)h+=parseInt(o.cells[r][c][p+v].style.width);f.style.width=h+"px"}d.rowspan>1&&f.setAttribute("rowspan",`${d.rowspan}`)}})}}),l.forEach(i=>{i.className="fn__none"})}),`<div>${o.body.innerHTML}</div>
${this.end}`}RebuildAsCustomHtml(t){t.displayEmpety||this.removeEmpetyInputRows(t);const n=j(this.end,["fold","id","updated","colgroup"]),s=` id="${t.nodeID}"  data-type="NodeHTMLBlock" `;return this.end=n.slice(0,2)+s+n.slice(2),`<div>${Xe(this,t).body.innerHTML}</div>
${this.end}`}makeToCard(t){this.cards=[],t.displayEmpety||this.removeEmpetyInputRows(t),this.caculateColAndRowGroup(t);const n=this.cells[0].length,s=this.cells.length,o=t.titles.length,l=t.rows.length,a=this.cards,r={card:0,x:0,y:0},i=this.direction;if(i.card==1?(Ze(this.cells),t.rows.forEach((p,f)=>{a[f]=t.deepCopy(this.cells)})):a[0]=t.deepCopy(this.cells),i.x===1){const p=a[0],f=this.colgroup[this.colgroup.length-1];for(let h=0;h<t.rows.length-1;h++)this.colgroup.push(f);for(let h=0;h<s;h++){const v=JSON.parse(JSON.stringify(p[h][n-1]));v.colspan>1&&this.dashRowNum!=h&&(v.content="",v.config.class="fn__none",v.colspan=1,v.config.colspan=1,v.configNo=1);const w=JSON.stringify(v);t.rows.forEach((S,y)=>{y!=0&&p[h].push(JSON.parse(w))})}}if(i.y===1){const p=a[0],f=t.rows.length,h=p[0].length,v=this.dashRowNum===s-1;let w;v?w=JSON.parse(JSON.stringify(Object.assign(p[s-2]))):w=Object.assign(JSON.parse(JSON.stringify(p[s-1]))),w.forEach(y=>{y.rowspan>1&&(y.content="",y.config.class="fn__none",y.rowspan=1,y.config.rowspan=1,y.configNo=1)});const S=JSON.stringify(w);for(let y=1;y<f;y++)v?p.splice(p.length-1,0,JSON.parse(S)):p.push(JSON.parse(S))}const u=[],c=/\.\.\((.*?)\)/;this.cells.forEach((p,f)=>{p.forEach((h,v)=>{h.content.match(c)&&u.push({x:f,y:v})})}),t.titles.forEach((p,f)=>{if(p.name!=""){const h=`..(${p.name})`,v=`\\.\\.\\(${p.name}\\)`,w=`..r(${p.name})`,S=`\\.\\.r\\(${p.name}\\)`;u.forEach(y=>{const I=this.cells[y.x][y.y],V=new RegExp(v),A=new RegExp(S).test(I.content);let D="[None]";if(V.test(I.content))for(let E=0;E<l;E++){const N=this.getOffsetCell(y,E),g=t.rows[E],m=t.rows[E].cells[f];D=ge(D,p,m,g,t),N.content=N.content.replace(h,D)}if(A)for(let E=0;E<l;E++){const N=this.getOffsetCell(y,E),g=t.rows[E],m=t.rows[E].cells[f];D=be(m),N.content=N.content.replace(w,m.value)}})}})}getOffsetCell(t,n){let s=0,o=t.x,l=t.y;return this.direction.card===1&&(s=n),this.direction.y===1&&(o+=n),this.direction.x===1&&(l+=n),this.cards[s][o][l]}getRawColgroup(t){this.colgroup=JSON.parse(t.colgroup)}getAttr(t,n){const s=this.cellSetting[n];if(s){const o=s[t];if(o)return`${t}="${o}"`}return""}getMdSettingFromTable(){const t=[],n={},s={},o=this.cells[0].length;let l=0;this.cells.forEach((a,r)=>{r!=this.dashRowNum&&(a.forEach((i,u)=>{let c=i.content;const d=o*l+u,p=c.match(this.cellStyleRegex);if(p&&p[1]){let h=p[1];h.length>1&&h.charAt(h.length-1)!==";"&&(h=h+";"),n[d]=h,c=c.replace(p[0],"")}if(u==0){const h=c.match(this.rowStyleRegex);if(h&&h[1]){let v=h[1];v.length>1&&v.charAt(v.length-1)!==";"&&(v=v+";"),t.push(v),c=c.replace(h[0],"")}else t.push("")}const f=c.match(this.cellSettingRegex);if(f&&f[1]){const h=f[1];s[d]||(s[d]={}),s[d][h]=f[2]?f[2]:"",c=c.replace(f[0],"")}i.content=c}),l++)}),this.rowsStyleStrs=t,this.cellStyleStrs=n,this.cellSetting=s}}const ne=(e,t=null)=>{(0,k.fetchPost)("/api/block/getBlockKramdown",{id:e.resourceID},n=>{const s=n.data.kramdown,o=/data-av-id="([^"]+)"/,l=s.match(o);if(l)e.resourceAVID!=l[1]&&(e.resourceAVID=l[1]);else{console.log("No av-id"),e.resourceAVID="",t&&t(!1);return}t&&t(!0)})},ft=(e,t=null)=>{fetchPost("/api/block/getBlockKramdown",{id:e.resourceID},n=>{const s=n.data.kramdown,o=/data-av-id="([^"]+)"/,l=s.match(o);if(l)e.resourceAVID!=l[1]&&(e.resourceAVID=l[1]);else{console.log("No av-id"),e.resourceAVID="",t&&t(!1);return}t&&t(!0)})},gt=e=>{};function K(e){const t=new Date(e),n=t.getFullYear(),s=(t.getMonth()+1).toString().padStart(2,"0"),o=t.getDate().toString().padStart(2,"0");return`${n}-${s}-${o}`}function F(e,t,n=null){const s=JSON.stringify({id:e,attrs:t});(0,k.fetchPost)("/api/attr/setBlockAttrs",{id:e,attrs:t},o=>{n&&n(o)})}function Ge(e,t,n=null,s=null){const o={id:e};return(0,k.fetchPost)("/api/attr/getBlockAttrs",o,l=>{l.data[t]?n&&n(l.data[t]):s&&s(l)}),!1}function bt(e,t){return B(this,null,function*(){const n={id:e};return fetchPost("/api/attr/getBlockAttrs",n,s=>{const o=s.data[t];return o||null}),null})}function vt(e,t=null){fetchPost("/api/av/renderAttributeView",{id:e},n=>{t&&t(n)})}function ue(e,t,n=null){(0,k.fetchPost)("/api/block/updateBlock",{dataType:"markdown",data:t,id:e},s=>{n&&n(s)})}function he(e,t,n=null){(0,k.fetchPost)("/api/notification/pushMsg",{msg:e,data:t},s=>{n&&n(s)})}function pe(e,t,n=null){(0,k.fetchPost)("/api/notification/pushErrMsg",{msg:e,data:t},s=>{n&&n(s)})}const me=(e,t=30)=>B(void 0,null,function*(){const n="custom-nioptablewait";let o=0,l=!0;const a=()=>{o++>t&&(l=!1,o=0)};for(F(e,{[n]:"1"},r=>{l=!1});l;)yield new Promise(r=>setTimeout(r,50)),a();for(l=!0,F(e,{[n]:""},r=>{l=!1});l;)yield new Promise(r=>setTimeout(r,50)),a()}),j=(e,t)=>{const n=t.map(l=>`${l}="[^"]*"`).join("|"),s=new RegExp(n,"g");return e.replace(s,"")};function Ye(e,t){const n=e.cards.length,s=e.cells.length-1,o=e.colgroup,l=e.rowsStyleStrs,a=e.cellStyleStrs,r=e.cellSetting,i=document.createElement("div"),u=document.createElement("style"),c=document.createElement("script"),d=fe(),p=o.length;u.textContent=`
.niop-card {
  padding: 5px;
  margin: 5px;
  display: inline-block;
  background-color: ${d.surfaceLight}; 
  border-radius: 5px; 
  opacity: 0.95;
  transition: box-shadow 0.3s ease; 
}
.niop-card:hover {
  box-shadow: 0 0 10px ${d.primarylight}; 
  opacity: 1;
}
.niop-card table {
  width:${t.totalCardWidth}px;
}
.niop-card tr{
  background-color:${d.surface};
  /* height of each line */
  min-height: auto;
}
.niop-card tr.thread{
  background-color:${d.surface};
}
.niop-card img {
  line-height: 0;
  object-fit: contain;
  width: 100%;
  height: 100%;
  vertical-align: middle;
}
.niop-card td {
  border-Color:${d.cellBorderColor};
  border-collapse: collapse;
  text-align: center;
  overflow-wrap: anywhere;
  word-break: break-all;
  vertical-align: middle;
  height: inherit;
}
.niop-card td:hover {
  box-shadow: 0px 0px 30px ${d.primarylighter};
  /%
  posheight:auto;
  overflow-y: visible;
  %/
}
.niop-cell-content {
  overflow-y: hidden;
  overflow-x: hidden;
  height: inherit;
}
.niop-cell-content:hover {
  overflow-y: visible;
  z-index: +10;
}
.niop-card span.imgsDiv {
  width: 0;
  height: -webkit-fill-available;
  display: flex;
}
.niop-card span.imgDiv  {
  height: -webkit-fill-available;
  width: -webkit-fill-available;
}
.AssetContainer {
  position: relative;
  height: 100%;
  width: 100%;
  display: block;
  overflow-x: auto;
  white-space: nowrap;
  left: 0px;
  top: 14px;
}
.AssetContainer::-webkit-scrollbar {
height: 5px; 
background-color: transparent; 
}
.AssetContainer::-webkit-scrollbar-track {
background-color: transparent;
}
.AssetContainer::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.098); 
transition: background-color 0.3s ease; 
}
.AssetContainer:hover::-webkit-scrollbar-thumb {
background-color: rgba(0, 0, 0, 0.6); 
height: 20px; 
}
.niop-card td span[niopinput] {
  width: fit-content;
  height: fit-content;
  padding-right: 3px;
  overflow: overlay;
  vertical-align: middle;
  text-align: left;
}
.niop-card td span[niopinput]:empty {
  content:"[None]"
  min-width:20px;
  padding-right: 5px;
  background-color: #; 
  border-radius: 8px;
  display: inline-block;
}
.niop-card td select[niopinput="select"] {
  min-height: 25px;
  max-width: 100%;
  width:fit-content;
}
.add-button{
  background-color: #eeee;
  border: solid 5px;
  border-radius: 8px;
}
.add-button:focus{
  border-color: ${d.primarylighter};
}
.fn__none {
  display: none !important;
}
`,c.textContent=`
setTimeout(() => {
  var mg =globalThis.NTP;
  mg.registerTable("${t.nodeID}","${t.resourceAVID}");
}, 100);
`,i.append(u),i.append(c);const f=document.createElement("div");f.className="cardContainer",i.append(f),f.setAttribute("avID",t.resourceAVID),f.setAttribute("blockID",t.nodeID),f.setAttribute("viewName",t.resourceAVViewName);const h=[];for(let w=0;w<n;w++){const S=document.createElement("div");S.className="niop-card";const y=document.createElement("table");for(let I=0;I<s;I++){const V=document.createElement("tr");if(l[I]!=""){const x=l[I];V.setAttribute("style",x)}I===0&&(V.className="thread");for(let x=0;x<o.length;x++){const A=document.createElement("td"),D=I*p+x;A.setAttribute("cellIndexID",D.toString());const E=a[D];E&&A.setAttribute("style",E);const N=r[D];N&&Object.keys(N).forEach(g=>{A.setAttribute(g,N[g])}),A.style.width=o[x],A.style.maxWidth=o[x],h[w]||(h[w]=[]),h[w][I]||(h[w][I]=[]),h[w][I][x]=A,V.appendChild(A)}y.appendChild(V)}S.appendChild(y),f.appendChild(S)}const v=document.createElement("span");return t.displayAddButton||v.classList.add("fn__none"),v.innerHTML=`
      <svg class="add-button" width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <path d="M24 4v38M5 24h38" stroke="black" stroke-width="4"/>
      </svg>
  `,f.appendChild(v),{body:i,cells:h}}function Xe(e,t){const n=t.rows.length,s=e.cells.length-1,o=e.colgroup,l=e.rowsStyleStrs,a=e.cellStyleStrs,r=e.cellSetting,i=document.createElement("div"),u=document.createElement("style"),c=document.createElement("style"),d=document.createElement("script"),p=fe(),f=o.length;u.textContent=t.CustomCss,d.textContent=`
setTimeout(() => {
  var mg =globalThis.NTP;
  mg.registerTable("${t.nodeID}","${t.resourceAVID}");
}, 100);
`,c.textContent=`
.niop-card {
  padding: 5px;
  position: relative;
  display: inline-block;
  border-radius: 5px; 
  transition: box-shadow 0.3s ease; 
  opacity: 0.95;
}
.niop-card:hover {
  box-shadow: 0 0 10px ${p.primarylight}; 
  opacity: 1;
}
.niop-card img {
  line-height: 0;
  object-fit: contain;
  width: 100%;
  height: 100%;
  vertical-align: middle;
}
`,i.append(u),i.append(c),i.append(d);const h=document.createElement("div");h.classList.add("cardContainer"),i.append(h),h.setAttribute("avID",t.resourceAVID),h.setAttribute("blockID",t.nodeID),h.setAttribute("viewName",t.resourceAVViewName);const v=t.titles,w=new Array(n).fill(t.CustomHtml);v.forEach((y,I)=>{const V=`..(${y.name})`,x=`\\.\\.\\(${y.name}\\)`,A=`..r(${y.name})`,D=`\\.\\.r\\(${y.name}\\)`,E=new RegExp(x,"g"),g=new RegExp(D,"g").test(t.CustomHtml);if(E.test(t.CustomHtml))for(let m=0;m<n;m++){const T=t.rows[m].cells[I],C=t.rows[m];let $="[None]";$=ge($,y,T,C,t),w[m]=w[m].replace(V,$)}if(g)for(let m=0;m<n;m++){const T=t.rows[m].cells[I],C=t.rows[m];let $="[None]";$=be(T),w[m]=w[m].replace(A,$)}});for(let y=0;y<n;y++){const I=document.createElement("div");I.textContent=w[y],I.className="niop-card",h.appendChild(I)}return{body:i}}function fe(){const e=window.getComputedStyle(document.documentElement);return{backgroundColor:e.getPropertyValue("--b3-theme-background"),surface:e.getPropertyValue("--b3-theme-surface"),surfaceLight:e.getPropertyValue("--b3-theme-surface-lighter"),cellBorderColor:e.getPropertyValue("--b3-border-color"),primarylight:e.getPropertyValue("--b3-theme-primary-light"),primarylighter:e.getPropertyValue("--b3-theme-primary-lighter"),primarylightest:e.getPropertyValue("--b3-theme-primary-lightest"),listhover:e.getPropertyValue("--b3-list-hover"),tooltipscolor:e.getPropertyValue("--b3-tooltips-color"),tooltipsbackground:e.getPropertyValue("--b3-tooltips-background")}}function yt(e){const t={backgroundColor:"",surface:"",surfaceLight:"",cellBorderColor:""},n=e.querySelector("thead");if(n){const l=window.getComputedStyle(n);t.surface=l.backgroundColor}const s=e.querySelector("tbody");if(s){const l=window.getComputedStyle(s);t.surfaceLight=l.backgroundColor}const o=e.querySelectorAll("td");if(o.length>0){const l=window.getComputedStyle(o[0]);t.cellBorderColor=l.borderColor}return t}function Ze(e){const t=/\[([^\]]*)\]\(([^)]+)\)/g;e.forEach(n=>{n.forEach(s=>{let o;for(;(o=t.exec(s.content))!==null;){const l=o[0],a=o[1],r=o[2],i=s.content[o.index-1]==="!",u=i?`<img" src="${r}" alt="${a}">`:`<a href="${r}">${a}</a>`;s.content=s.content.replace(i?"!"+l:l,u)}})})}const ge=(e,t,n,s,o)=>{let l=n.value[n.valueType],a,r="";const i=o.editableCard;switch(n.valueType){case"block":e=n.value.block.content,e=L(e),e=`<span contenteditable="${i}"  niopInput="block" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">${e}</span>`;break;case"text":e=n.value.text.content,e=L(e),e=`<span contenteditable="${i}"  niopInput="text" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">${e}</span>`;break;case"number":e=n.value.number.content,e=`<span contenteditable="${i}" niopInput="number" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">${e}</span>`;break;case"date":e=(l.isNotEmpty?K(l.content):"")+(l.isNotEmpty2?` -> ${K(l.content2)}`:"");break;case"phone":e=n.value.phone.content,e=L(e),e=`<span contenteditable="${i}" niopInput="phone" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">${e}</span>`;break;case"mAsset":if(n.value.mAsset){const u=n.value.mAsset.length;o.renderMethod===1||o.renderMethod===4?u===1?(e=`<span class='imgDiv'><img src="${n.value.mAsset[0].content}"></span>`,e=`<span contenteditable="${i}" niopInput="mAsset" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">${e}</span>`):e=`<span class='AssetContainer'>${n.value.mAsset.map(d=>d.type==="image"?`<span class='imgDiv'><img src='${d.content}' alt='${d.name}'></span>`:`<span class='fileDiv'><a href='${d.content}' title='${d.name}'>${d.name}</a></span>`).join("")}</span>`:u===1?(e=n.value.mAsset[0].type==="image"?`![image](${n.value.mAsset[0].content})`:`![file](${n.value.mAsset[0].content})`,e=`<span contenteditable="${i}" niopInput="mAsset" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">${e}</span>`):e=`${n.value.mAsset.map(d=>d.type==="image"?`![${d.name}](${d.content})`:`[${d.name}](${d.content})`).join("")}`}else e="",e=`<span contenteditable="${i}" niopInput="mAsset" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">${e}</span>`;break;case"select":if(a=t.options,r=`<select contenteditable="${i}" readonly ${i?"":"onmousedown='return false;' onkeydown='return false;'"} niopInput="select" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">`,l=n.value.mSelect,r+=`<option value="" Color="" ${l?"":"selected"}  >[None]</option>`,a.length>0)for(const u of a)r+=`<option value="${u.name}" Color="${u.color}" ${l&&l.length>0&&l[0].content===u.name?"selected":""}>${u.name}</option>`;r+="</select>",e=r;break;case"mSelect":if(a=t.options,r=`<select multiple contenteditable="${i}" readonly  ${i?"":"onmousedown='return false;' onkeydown='return false;'"} niopInput="mSelect" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">`,l=n.value.mSelect,a.length>0)for(const u of a)r+=`<option value="${u.name}" Color="${u.color}" ${l&&l.some(c=>c.content===u.name)?"selected":""}>${u.name}</option>`;else r+='<option value="" style="background-color: default;">[None]</option>';r+="</select>",e=r;break;case"checkbox":l=n.value.checkbox,e=`<input type="checkbox" ${l.checked?"checked":""} contenteditable="${i}" niopInput="${n.valueType}" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">`;break;default:l.content&&(e=L(l.content),e=`<span contenteditable="${i}" niopInput="${n.valueType}" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}">${e}</span>`),e==="[None]"&&(e=`<span contenteditable="${i}" niopInput="${n.valueType}" keyID="${n.value.keyID}" rowID="${s.id}" cellID="${n.value.id}"> </span>`);break}return e},be=e=>{let t="";const n=e.value[e.valueType];switch(e.valueType){case"block":t=e.value.block.content;break;case"number":t=e.value.number.content;break;case"date":t=(n.isNotEmpty?K(n.content):"")+(n.isNotEmpty2?` -> ${K(n.content2)}`:"");break;case"phone":t=e.value.phone.content;break;case"mAsset":e.value.mAsset&&(e.value.mAsset.length===1?t=e.value.mAsset[0].content:t=e.value.mAsset.map(o=>o.content).join(", "));break;case"select":t=n?n[0].content:"";break;case"mSelect":t=n?n.map(s=>s.content).join(", "):"";break;case"checkbox":t=n.checked;break;default:n.content&&(t=n.content);break}return t},Qe=e=>{throw new Error("Function not implemented.")};module.exports=z})();
